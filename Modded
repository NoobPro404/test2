// ==UserScript==
//
// @name         IMDb Scout Mod
// @version      13.9.3
// @namespace    https://github.com/Purfview/IMDb-Scout-Mod
// @description  Auto search for movie/series on torrent, usenet, ddl, subtitles, streaming, predb and other sites. Adds links to IMDb pages from hundreds various sites. Adds movies/series to Radarr/Sonarr. Adds external ratings from Metacritic, Rotten Tomatoes, Letterboxd, Douban, Allocine. Media Server indicators for Plex, Jellyfin, Emby. Dark theme/style for Reference View. Adds/Removes to/from Trakt's watchlist. Removes ads.
// @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABABAMAAABYR2ztAAAAMFBMVEUAAAD/AAAcAAA1AABEAABVAAC3AADnAAD2AACFAAClAABlAAB3AADHAACVAADYAABCnXhrAAAD10lEQVRIx73TV4xMURgH8H/OnRmZWe3T7h2sOWaNXu7oJRg9UccuHgTRBatMtAgSg+gJu9q+kFmihcQoD8qLTkK0CIkoy0YJITsRD0rCKTHFrnkSv5e5c88/53znO+fiPwvsvrN038cPNqrG9pJmHkRVnPcpaTlHJY60cfPSpsrzl1LKihrmLvxhCM2i3OHvDx0d+H7e3F6JBv5iZMiJfhFTfPYDMHrMImpwimWWUdSgDQkbno7fFpUPVgh+pHFbZR4SovSctDCM9Hac9IKd9rO8EevtBCkXgY5IMmgquwypP7qqfcp/Tp4KLONDVsWh3RSBB2rnZfit69ocUdqLn2prrRZYM0Jg4JibamKsqe7gfEh5GOAfeYJjVHIPZvil97rcXkMog30byWRwXYRWoxHbzNFHJJpAarO8NdEBBsdCaP3WMJltTmQd4zlnekTq9Z5dgACwAlrpK4BxdV5mvLuspRgMSHbCIFF0iS8MZ5S8oYBYKY7rByC4dDM9uSIUmPOIwxgQBoYeF93auP4qFyPbIVXziWeGTH1EFM57kJo2hqQju6BwIyRf6RmCjdT4JOdiwNgiH/PPD3qoqlsNaXRd+fKtFfECxlZVNVF9SOsgTZEr2TUjJJbyeNX1IZrKIbyGlBABfpQPv2UDrly13LkJXDVhpQ5MhtGwcyF4HKjlU4E8xwB0AvDjd6AGmevZ87EcQRHgcO52e9uNsYELOrAa/Yh81YlmYLQJ5HWyq0+kzQ/DQKEusg6CRI27ryy8nReRS0wsoetkmRwogHSprliCckfEjXG9yAQc74J0WB99vu6DF3i3pMucsXM6tpBbxd2mVJAwXwGogNRBvGRA4jtHKTXkAIwLGCR/mT4Lh75oneQXXP9sAYfGRDCsnw7pX/jRZkU3M44kjw2l5zRIzb4CbZ8dULdL6wbNPZOpK0B6gN1UR1mdoxAaL/GrWiLPL3SEwW9YMTU/d64BtLahAVyucWhj9Mm8ign9IfQaBtd2/GbvCAEBpG5eMcrj2I0ktpKLeaqXQ3Pst42KGIshpdTmQLAeTgFGJ2wvh+tayMOR0n1RZ8B9z13vnOPBnsBq4E1ffgZpPFZHWVpO2cvhjYpOcbBd5TlhpDu5zq9mHGZcVi0y+VFkcFkDdyKJfTt99wEyHSEzDM90KH0nexpwZHJHKYYhjzlwGe0pP/IKfxociaEb7YDbi6KGJY1R2cR76E6NAtXqY4pPH3plLcl8LD7V+cOLUbUWRFZRPTAbVZO3mxK18Xc1ZaAiS8ARJXpZliXAomR94siiiMx8ZBOkXGTlnH0F/9ov1xPtWwEqP9wAAAAASUVORK5CYII=
// @license      MIT
//
// @homepage     https://github.com/Purfview/IMDb-Scout-Mod
// @supportURL   https://github.com/Purfview/IMDb-Scout-Mod/issues
//
// @compatible   firefox
// @compatible   opera
// @compatible   chrome
// @compatible   safari (it doesn't support the sites with logins)
// @compatible   edge
//
// @require      https://cdn.jsdelivr.net/gh/sizzlemctwizzle/GM_config@43fd0fe4de1166f343883511e53546e87840aeaf/gm_config.js
// @require      https://greasyfork.org/scripts/403996-exev/code/ExEv.js?version=808391
// @require      https://code.jquery.com/jquery-3.5.1.min.js
// @require      https://greasemonkey.github.io/gm4-polyfill/gm4-polyfill.js
//
// @include      http*://*.imdb.tld/title/tt*
// @include      http*://*.imdb.tld/search/title*
// @include      http*://*.imdb.tld/user/ur*/watchlist*
// @include      http*://*.imdb.tld/list/ls*
//
// @exclude      /title\/tt\d+\/\w(?!(eference))/
//
// @connect      *
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_addStyle
// @grant        GM_openInTab
// @grant        GM_xmlhttpRequest
// @grant        GM_registerMenuCommand
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        GM.openInTab
// @grant        GM.xmlHttpRequest
// @grant        GM.registerMenuCommand
// @grant        GM.notification
//
// @run-at       document-start
// @noframes
//
// ==/UserScript==
//
/*=========================  Version History  ==================================
*/
//==============================================================================
//    JSHint directives.
//==============================================================================

/*jshint esversion: 8 */
/*jshint sub:true */
/*jshint multistr: true */
/*jshint scripturl:true*/
/*globals GM, GM_config, $ */
/*jshint shadow:true */
/*jshint -W089 */
/*jshint expr: true */
/*jshint laxbreak: true */

//==============================================================================
//    A list of all the sites.
//==============================================================================
/*
    -= Each site is a dictionary with the following attributes: =-

#  'name':
The site name, abbreviated, unique (the 'TV' atribute internaly adds 'TV' to the name).

#  'icon' (optional):
Icon for the site. If not defined then script looks at site/favicon.ico.
Can be URL or Base64 string (www.base64-image.de).

#  'searchUrl':
The URL to perform the search against, see below for how to tailor the string to a site.

#  'matchRegex':
The string which appears if the searchUrl *doesn't* return a result.

#  'positiveMatch' (optional):
Changes the test to return true if the searchUrl *does* return a result that matches matchRegex.

#  'TV' (optional):
If true, it means that this site will only show up on TV pages.
By default, sites only show up on movie pages.

#  'both' (optional):
Means that the site will show up on both movie and TV pages.

#  'SpaceEncode' (optional):
Changes the character used to encode spaces in movie/TV titles. The default is '+'.

#  'goToUrl' (optional):
Most of the time the same URLs that are used for checking are the ones that
are used to actually get to the movie, but this allows overriding that.

#  'loggedOutRegex' (optional):
If any text on the page matches this regex, the site is treated as being logged out,
rather than mising the movie. This option is not effected by positiveMatch.

#  'ConfigName' (optional):
Use this to allow changing names without breaking existing users.

#  'inSecondSearchBar' & 'inThirdSearchBar' (optional):
Places site at the extra searchable bar. Subtitles and other sites are set to 2nd bar.
3rd bar is empty, space for custom user's configuration. By defaut site goes to the 1st bar.
Extra bars can be enabled/disabled/swapped at the Settings.

#  'rateLimit' (optional):
Connection rate limit in milliseconds. Default is 200.
On the Search/List pages if rateLimit<=1000 then it will be increased by a factor of 4.

#  'mPOST':
HTTP request by POST method. For the sites that doesn't support GET.
Right mouse click won't submit such request.
Atm 'goToUrl' not supported with it.
Examples (3 types of formating):
'cat1=4&cat2=6&filter=%tt%'
'{"cat1":4,"cat2":6,"filter":"all=%tt%&sort=date"}'
'{key:"cat",value:"4"},{key:"cat",value:"6"},{key:"filter",value:"%tt%"}'  // (supports duplicate keys)

#  'ignore404' (optional):
Ignores all 4** HTTP errors.

#  'ignoreEmpty' (optional):
Use it if an empty response means that no results found, otherwise by default it means 'logged_out'.

    -=  Search URL parameters: =-

#  %tt%:
The IMDb id with the tt prefix (e.g. tt0055630).

#  %nott%:
The IMDb id without the tt prefix (e.g. 0055630).

#  %tvdbid%:
The TVDb id.

#  %tmdbid%:
The TMDb id.

#  %doubanid%:
The Douban id.

#  %search_string%:
The movie title (e.g. Yojimbo). Depends on your preferences at www.imdb.com/preferences/general.

#  %search_string_orig%:
The original movie title (e.g. Yôjinbô). Reverts to %search_string% if original title is not set at IMDb.

#  %year%:
The movie year (e.g. 1961).

*/

// Custom sites must be set to the 3rd/2nd search bar.
var custom_sites = [
];

var public_sites = [
  {   'name': '1337x',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA4BAMAAABaqCYtAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAPUExURdY2AN9iOP///9Y2AN9iOE1iXmMAAAADdFJOUwAAAPp2xN4AAADRSURBVDjLtdXtDQIhDAbgxmMBDAP4NcDFOoAI+8/kQXsmV6DgRfuL8KTlhT/ARSkYwHNMZZdyafHS8LhFN4SxhZ7Rf4OW0TUxjqCVyHFjG30ffYG07fZi5FgF5v34c7Sr+f+glXgCAEMWluVhF85VBGqclU5UMOCjiQERq5iHKpga8VnHbClRgYatjmwpboETrlXBoCF2caJEEk3ebuDUR6C7SOSXo0QSOaeKNECg4YejowVyHh1pgsDASGcL5DwdDCXePpgPv2/wyjep4o7f4Q1FlOJhL4s2tAAAAABJRU5ErkJggg==',
      'searchUrl': 'https://1337x.to/category-search/%search_string%+%year%/Movies/1/',
      'matchRegex': /No results were returned/},
  {   'name': 'RARBG',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAADMUExURQAAADhgu/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////7+/zhgu1d5xlt8x2GByWiGzHCNz3aS0XqV0oCa1Iig1o+l2Zar25yw3qK14Ky947DA5LXE5rnH6MbS7MvW7tDa79ff8tzj8+Pp9uzw+fT2+/7+/////0INwLoAAAAodFJOUwAAAAMIDRQZHSIqMzpAR09dY251foaPl6CmrbO7wMfQ19re5Orx9/zZOpCWAAAB3ElEQVRIx5XVWVvaQBSA4ZlhsewoBapVlqFZKqKtiFAkZfn+/3/yIhAmkJDxXOQiOe8zmeXMEUopJYQolOsNM+q1armYE/FQSqnwUah1B65nhOs4o/5dp1X/lgxqmuRw7m/KCeDqjvTo1c9Bw70AGDULp6AF8D6LxXyxXHuhcFv5E9AG8BNi8s8DcJpSSivg+79XAKOKNfD9BcB9zh74S8CpfAH4W6Arw3wr8Ab0ZJifBObz+Wz2OjYmDuh8Knjc79dH7J+cciZgGYEAaGSDXQQ+gGY24OnwamU3whEE4FYsgDnpUTEbrCMADKTKAt7k8OYV+JkJ1lG+/x+863TgT6fTvy/GRv8BdFGlg9OK2AJtZQ/WgC5Zg/EGcJvSFrx5gNuW1mAD0JP24GkHjKqXQRAE41i10S/nLoDH2KnwVwC3VxmARXwaTjcL8HK8/XYAmWB7HGJmBcw7IDBF+vGexm+ybOAd1/bZGMKq4vx3YHMJuD2AedI0ksEw7JLP8aK4BOS1B2yMsjuIZDCQYWNdGt3LBC3z2pqEB7oyOFlbE5y13Y4QouGcNeAIlB7iH35VhRD57+lA1Aax/BshhBClH855/h6IUvthqLXWWg97neq+8eert319DGPjvhKfLLE8ejIzVGgAAAAASUVORK5CYII=',
      'searchUrl': 'https://rarbgweb.org/torrents.php?imdb=%tt%',
      'loggedOutRegex': /something wrong|Please wait|enter the captcha|too many requests/,
      'matchRegex': /imdb_thumb.gif/,
      'positiveMatch': true,
      'rateLimit': 4000,
      'both': true},
];

var private_sites = [
  {   'name': 'CrazyHD',
      'searchUrl': 'https://www.crazyhd.com/index.php?page=searchlist',
      'loggedOutRegex': /Cloudflare|Ray ID|Popular Topics/,
      'matchRegex': /list-name/,
      'positiveMatch': true,
      'mPOST': 'search=%search_string_orig%+%year%',
      'both': true},
  {   'name': 'CrazyHD-Req',
      'searchUrl': 'https://www.crazyhd.com/index.php?page=viewrequests&search=%search_string_orig%',
      'loggedOutRegex': /Cloudflare|Ray ID|Popular Topics/,
      'matchRegex': />No</,
      'positiveMatch': true,
      'both': true},
];

var german_sites = [
];

var usenet_sites = [
];

var subs_sites = [
  {   'name': 'OpenSubtitles',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwAgMAAAAqbBEUAAAACVBMVEUAAAD///8TExOI954UAAAAk0lEQVQoz62SQQ7DMAgEcSXfe/F/+gQf4D99egeCjJtTpITIG4agtYMsX1nxkr/os56r8EB0+6ANJcxmqEWJV6oMFTq6ynAgm64N8J6j7EksW0CaEL7Z1h0GBjvoBt20oHGoBXyyAmgDTliAe26avk3PoAnxCwVh8nYD1oTJmklsbZTQY1QapVlDZDz34/492K/YD8ElL5+2GoYbAAAAAElFTkSuQmCC',
      'searchUrl': 'https://www.opensubtitles.org/en/search/imdbid-%nott%',
      'loggedOutRegex': /Guru Meditation/,
      'matchRegex': /div itemscope/,
      'positiveMatch': true,
      'inSecondSearchBar': true,
      'both': true},
  {   'name': 'OpenSubtitles (EN)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwAgMAAAAqbBEUAAAACVBMVEUAAAD///8TExOI954UAAAAk0lEQVQoz62SQQ7DMAgEcSXfe/F/+gQf4D99egeCjJtTpITIG4agtYMsX1nxkr/os56r8EB0+6ANJcxmqEWJV6oMFTq6ynAgm64N8J6j7EksW0CaEL7Z1h0GBjvoBt20oHGoBXyyAmgDTliAe26avk3PoAnxCwVh8nYD1oTJmklsbZTQY1QapVlDZDz34/492K/YD8ElL5+2GoYbAAAAAElFTkSuQmCC',
      'searchUrl': 'https://www.opensubtitles.org/en/search/sublanguageid-eng/imdbid-%nott%',
      'loggedOutRegex': /Guru Meditation/,
      'matchRegex': /div itemscope/,
      'positiveMatch': true,
      'inSecondSearchBar': true,
      'both': true},
  {   'name': 'OpenSubtitles.com (EN)',
      'icon': 'https://www.opensubtitles.com/assets/ui/favicons/favicon-64x64-e8e9f196985f98cfaa08b1e0159a1030cfc9b014c464fab6693cd0573382a702.png',
      'searchUrl': 'https://www.opensubtitles.com/en/en/search-all/q-%tt%/hearing_impaired-hearing_impaired-1/machine_translated-machine_translated-0/trusted_sources-trusted_sources-0',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': /No results found/,
      'inSecondSearchBar': true,
      'both': true},
  {   'name': 'Subscene',
      'searchUrl': 'https://subscene.com/subtitles/searchbytitle?query=%search_string%',
      'loggedOutRegex': /Please do not hammer|HTTP Error 404/,
      'matchRegex': />Exact</,
      'positiveMatch': true,
      'rateLimit': 7500,
      'inSecondSearchBar': true},
  {   'name': 'Subscene',
      'searchUrl': 'https://subscene.com/subtitles/searchbytitle?query=%search_string%',
      'loggedOutRegex': /Please do not hammer|HTTP Error 404/,
      'matchRegex': />TV-Series</,
      'positiveMatch': true,
      'rateLimit': 7500,
      'inSecondSearchBar': true,
      'TV': true},
];

var pre_databases = [
  {   'name': 'PREcBurns',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAQAAAD9CzEMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAADsSURBVHja3NhbFoMwCEVR5j9p+ltr4B7Io0v1L6nslGSZoLntve0IIK/kefWY+hUcZg8o5qIKNNLNgfaMCiBeWKNrjPzGs2GDDJ4xKVALHiLhHIjgcR8D0vAqdSMiAch0auIKlEYPCA7c2ynxDYDxk1bXAF05JJ1XpTR+Z4v5DvgLAfVyyHoXAF4D1ox/GtD/dwog6ZwA2GwtALwH2JLwzwfsr4BtAhovC3KEgTtaG4i2TJtIUbwn2wogP1UAgvUiwMoAOdnhs2kb2H66PlAfVCocr1c40zWa8yrT91aZR+rkA5U+Qdi3ip33ZwAb5/CcnuFpKAAAAABJRU5ErkJggg==',
      'searchUrl': 'http://pre.c-burns.co.uk/pre.php?searchtext=%search_string%+%year%',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': />: 0</,
      'inSecondSearchBar': true},
  {   'name': 'xREL',
      'searchUrl': 'https://www.xrel.to/search.html?xrel_search_query=%tt%&lang=en_US',
      'matchRegex': /not return any results/,
      'inSecondSearchBar': true,
      'both': true}
];

var other_sites = [
  {   'name': 'Blu-ray',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAADeUExURVO29Vq59Vu59Vy59V269WC79W6/9W+/9XDA9XDB9nDC93HC93PC9nXE93bG9njF93vF9n3I94DH9oHG9oLH9oTI9oXJ9orK9orN+IvK94zM94zO+I3L943O+JDN95HP+JHQ+JPP95XQ+JbQ95jU+ZnR+JzR+JzS95zT+J3S+J3T+J3U+J7S+J/T+J/U+KDT+KPV+KTX+anX+K7Z+q/a+bHc+bbf+rrf+cTk+sXk+8jk+svl+svm+8zn+9vt/Nvu/Nzu/Nzv/N3v/ODv/OHw/Ojz/Onz/er0/er1/f///532i+4AAAC+SURBVDjLtdNFDsNADEDRFFxmZmZmZs79L9TUo1ZZOGOpamdlK0/K6EdRgDnK74CqO9cRA7RT54DapMFpf3wLEvTsNkdmKkCBAi5chzhXKODH0ceBEs55CrhfU/yBc4gCk1qnvxB3LJulHbYRMElBCsAqL3lgU58DFPACWJJzIZYGHbRXd/UfgwKw5sAYl7RhatjgkjVKDQ1xhwQBquForD0Tzy8eqsPt/glRZEIN5CV3OVnqVSvo/Mev9zV4Aq22bvwYC8iHAAAAAElFTkSuQmCC',
      'searchUrl': 'https://www.blu-ray.com/search/?quicksearch=1&quicksearch_country=all&quicksearch_keyword=%tt%&section=theatrical',
      'matchRegex': /return any results/,
      'inSecondSearchBar': true},
  {   'name': 'Wikidata',
      'icon': 'https://www.wikidata.org/static/favicon/wikidata.ico',
      'searchUrl': 'https://tools.wmflabs.org/wikidata-todo/resolver.php?prop=P345&value=%tt%',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': /wiki\/Q/,
      'positiveMatch': true,
      'inSecondSearchBar': true,
      'both': true}
];

var streaming_sites = [
  {   'name': 'DbGDP',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAROSURBVFjDzZdbTBRnGIZJ0/te9aKJFhWwi6Fgu6wHPLR40bTaRm1CUamFptWmrYZUW4IcTCTW0gZDLyBBjFi4wGoitnsAi2Bokap00yJW2YXCnoGZ7bK7YGFhd3n7/bOMYfYgyyHqxZOZ7E7+95nv/+bLTAyAmCdJzFMjwG1dK/IMsY/4hTATjki4Nq51nCpL4rZfS3S8q4mInegl6ojNRAwjksBzhIpANJAASAAkAFo0GvxEcSSBZwm1JGRLCvgNMvCp8eDlcXSU4k6Ow4lTsd70q8uwXSnlLeG4HDvV8eFEcsMJZErCNyUJ4YM5e2EuOw3jmXMwVUmxVp6DsuWsv/JuNc50SanuqkLp7SLkNL+OHcoXsVsjmy3AhxNofhielgRumwKGC1egt09DN4aIDIwAZjtgCkL87e6gE991luBt1QoKfijhDCdgDgiwsifCcEkN3QSgJ1f98MLp5wIiJ2/lC5WYEXCEE+CZAL/+JdgOZENHl+g56WK93MIkBugmbposyGhMxi716jkEqLlMldVCeYMX6hmaholK/o99fgK9RB/J57Zl4h1hKx4loEiAsfZH6Eali7DgKo0VBTU6dFu8sLrmVxEDVeFY+0HqhdgoBH64ECJgocDTl414flcD0o+0oabZhn57QCzabchvP7A4ge+vmLBirwrxWRqs2qfGeyW3odE6hf8G/n2MAmtympBIrKTzxOwmHK7oxs3ecdjc1B/8YxIQkWU3IjZTCcWnLSi92I/7Np9wbXB/zCnwIC2eJzD+yguw1dShJ0oBkdX7NYLIG3ntqGsdxv1Bn0SCCXzx28dIp1nwploWKlCWXTFEeEv3lHuvNnT7B1zzExBZlvEzlmcoUaE0wzirQftIoLHzkK++ZY334nU5FyKQVOLjCawq8qG8dRrWkfkJJLxPFdijwo6CDtS3cdAN+yUV0NH5+J0vgQ4FTaWtoRVYf9zFE0jOd6Li2iQsUQrIPmgUgjd83kqPqYGu9cPiDO0BJuDsOorJG6nw/L5l8QKs+1fOnB+tugdtvwdWd6DU4Z6CJRWIy1ILcyDrmz/Q3OWOag4siYAwCXc2BDr9+pAQaoxyEs5LoLIlVICN3OomG47X9uJehGd9SQReJoGTP03A6gyzCGF2Rp52j2Yao9oPMdmxLqIAxwReLXBhd/kodEOhQQt9H+ihdQwmPQVvniG8QB8TYKQcc+JblQeDrLnsi3sj6hFuYgquv3Kp/AoWHlHgvCigKKZKFDpxomECWqMfRtZsjlBMRB8J9lBldLwUFsz2fcCsp/AjmLohF8MZo+EE5IRflFhXHGjIbV+78dHZBzhc+x8OBXHw/BR+bav3jf2dh5E7xUEUwv3nJxT2mth4s+kOJ8DIEwVEUosCW5JCMsJxFglfeaC6ROP1lky4w2AmO1jJNwWHjxEbIwkwPiNMhGMukgs9Ds3lQg6dcgfb1yjQEmnEU/hx+qT4Hxx8JuUJoU43AAAAAElFTkSuQmCC',
      'searchUrl': 'https://databasegdriveplayer.co/player.php?imdb=%tt%',
      'matchRegex': />HLS Mode</,
      'positiveMatch': true,
      'inThirdSearchBar': true},
  {   'name': 'Filmux (LT)',
      'icon': 'https://filmux.to/templates/Filmux/images/favicon.ico',
      'searchUrl': 'https://filmux.to/index.php?do=search&subaction=search&story=%search_string_orig%+%year%',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': /nedavė jokių rezultatų/,
      'inThirdSearchBar': true,
      'both': true},
  {   'name': 'OBNIV (FR)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAYFBMVEUAAAAuKSKV1aTuvYSSWkDJalfbhW94waV1y/bmlV/pqHFpsJNePi9xfs6ATznBgHSfqJF0SDSVxcxWhHOUd2KqkXN1nbS3sI9NWlvRvpTToXZ1ouBpZJHMiFenWUmxaVexta/xAAAAAXRSTlMAQObYZgAAAYZJREFUOMudztGOgyAQhWGpWlGhoiKi1t33f8tlcGCorXvRPyVp0i9nmn1bWf7ej/5BlonShVAwxj4798NPAh8M+sjAEfxlvmtH8OjCkZxGkm9OlVTHOdLEQUXZqRPkhiTBtqoq5c6W985/1OCqAiQ3Vic436AWZYS2fYckxevhdwgJ5qLBa9gGKPw/vIAQg+JlhFFNt5hNoEVous7ZCeaoMYEjQCOl3PhQ3gelbkntGUrJITVwt53A6gRdHgKDSL5CkDJC6BrO85ZuKq0+wnbJ83VYBs43Y6pWt31RTOBMgFoze7h6dY87uZlHUTy8NPLJhDhgPjHvmsa9mUNbH6SUVhQB5mIMrlkWgLoQKLVkPUDXlOc93GzQDpzD5bBZCAczhCsYfCssCpS4GyEU7ACLGqXvgXAJrkbLeU97vsyXY/G23IJ6hTVCdLWU8ilQokNYNwjRoYzpAEmiQ0kOIcl1t/bpnRVBAkEIreD2XbAYyiyB2F6jI0lnUxkdyYlQIuFb6rLv+gM8+SNPyta08QAAAABJRU5ErkJggg==',
      'searchUrl': 'http://obniv.com/ws4xct8/home/obniv',
      'mPOST': 'searchword=%search_string_orig%',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': /aucuns resultats disponible/,
      'inThirdSearchBar': true},
  {   'name': 'OK (RU)',
      'searchUrl': 'https://ok.ru/video/search?st.cmd=video&st.psft=search&st.m=SEARCH&st.ft=search&cmd=VideoContentBlock&st.v.srt=All&st.v.sfd=LONG&st.v.sfhd=off&st.v.sq=%search_string_orig%&gwt.requested=xxx',
      'loggedOutRegex': /Cloudflare|Ray ID/,
      'matchRegex': /No search results found/,
      'inThirdSearchBar': true,
      'both': true},
  {   'name': 'VidSrc',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABD0lEQVQ4ja2TvUoEMRSFv3sns7nbC4KtheAKNhZbW4mlpY0P4FYWgiLoFgpa2/kYvpwussciM+P+2TiekHCS+3cuSUwSfWDjoF+GcSBJSPoT917V2xZyDPj8mC0ZcgzWnBd9Wru9P08E8DWb8fL0xt30EgyaZQFCgsf7V24fJt1pAjArM4Y1XhlgG8INSUTUuIPmICC5gzUZIhLu/psAhJGjxt1RM5K7YWZFQdS0+02QROSEuyEaBWaOexEduWRvW1quDtJPEQFzWWmhDcqRqKoSuaqi3L2RGwVzwCXs+uTo/17i1fFux29O9zo+PTvYyM/3t+Sj0U6XbJCrjg+H6w9pFSlV2MXhdq8WrO93/gaUmJF4CshtQwAAAABJRU5ErkJggg==',
      'searchUrl': 'https://v2.vidsrc.me/embed/%tt%/',
      'matchRegex': /Not Found!/,
      'ignore404': true,
      'inThirdSearchBar': true}
];

var sites = public_sites.concat(private_sites, german_sites, usenet_sites, custom_sites, subs_sites, pre_databases, other_sites, streaming_sites);

var icon_sites_main = [
  {   'name': '_OMDb (for Dev tests)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAQAAAD9CzEMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAADsSURBVHja3NhbFoMwCEVR5j9p+ltr4B7Io0v1L6nslGSZoLntve0IIK/kefWY+hUcZg8o5qIKNNLNgfaMCiBeWKNrjPzGs2GDDJ4xKVALHiLhHIjgcR8D0vAqdSMiAch0auIKlEYPCA7c2ynxDYDxk1bXAF05JJ1XpTR+Z4v5DvgLAfVyyHoXAF4D1ox/GtD/dwog6ZwA2GwtALwH2JLwzwfsr4BtAhovC3KEgTtaG4i2TJtIUbwn2wogP1UAgvUiwMoAOdnhs2kb2H66PlAfVCocr1c40zWa8yrT91aZR+rkA5U+Qdi3ip33ZwAb5/CcnuFpKAAAAABJRU5ErkJggg==',
      'searchUrl': 'https://drive.google.com/drive/u/4/search?q=type:video+"%search_string%"+%year%',
      'showByDefault': false},
  {   'name': 'pirates bay)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAQAAAD9CzEMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAADsSURBVHja3NhbFoMwCEVR5j9p+ltr4B7Io0v1L6nslGSZoLntve0IIK/kefWY+hUcZg8o5qIKNNLNgfaMCiBeWKNrjPzGs2GDDJ4xKVALHiLhHIjgcR8D0vAqdSMiAch0auIKlEYPCA7c2ynxDYDxk1bXAF05JJ1XpTR+Z4v5DvgLAfVyyHoXAF4D1ox/GtD/dwog6ZwA2GwtALwH2JLwzwfsr4BtAhovC3KEgTtaG4i2TJtIUbwn2wogP1UAgvUiwMoAOdnhs2kb2H66PlAfVCocr1c40zWa8yrT91aZR+rkA5U+Qdi3ip33ZwAb5/CcnuFpKAAAAABJRU5ErkJggg==',
      'searchUrl': 'https://thepiratebay.org/search.php?q="%search_string%"+%year%',
      'showByDefault': false},
  {   'name': 'YouTube',
      'icon': 'https://www.youtube.com/s/desktop/640aba68/img/favicon_32.png',
      'searchUrl': 'https://www.youtube.com/results?search_query="%search_string%"+%year%+trailer'}
];

// Class of these should be renamed(search: "class of the special buttons").
var special_buttons = [
  {   'name': 'Copy Info to BBcode',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAACMjIw+cENnAAAAAXRSTlMAQObYZgAAALBJREFUKM910rENwyAUBNCPKFKyQdiErEVhKYzGKIzgkgLl4v/x2Y7k0PCQ7nQNcp53n7fHZ+IBFEMAqiECzfASvxqSuFlbxA1i9vMFjahEQZ+Yc9lWikJX6kQNTWFzhiS+b+BcjkPnDFkcDhSialjRiJXoe4YQGUQinjNMRPQTlvkFW3/rt1iIxPCLiJXAPhEIT8gBtm6xXJEUaX/onAxFLOK6AYAhbFgVHvwEG+Q4X86vk0jZCGx+AAAAAElFTkSuQmCC',
      'searchUrl': 'https://dummycopy.info',
      'showByDefault': false},
  {   'name': 'Radarr',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAACTFBMVEUAAAD//////////////vu1t7j/zFCGiYz////+/v4xNjs7QEUpLjP////7+/smKzBHS09VWV1obG/////////////Z2tv/////////////////////yUdQVFg/Q0imqKp2enz19va2t7n///+XmZyTlZj/4JOOkJOEh4n/8tTY2trV1tf/9+L////r7Oz///////84PEEuMjdLT1RCRkv/zlmMj5FaXWGVl5plaGzq6+yYmpx0d3rU1dZ8f4L8/f3v7/C+wMG6u72bnaD/5qmgo6WsrrD/67mxs7XOz9H//PT///////////////////////////////////////////////82Oj//xDX/xj3/zE2JjI9SVlr/0mVdYWV4e3//1nLn5+jg4eKGiYttcHSAg4b/2XzMzc+wsrTGx8ijpqj/5KCdn6H/7cC9vsC6vL2+wMH////Q0dL/8c3k5eX/+evp6en19fXy8vL9/f3////l5ubz8/T///////////////////////////////////////////////////9YXGD/z1r/13b////c3d7HyMmqrK7s7O2Ii43/24X4+Pjy8/Opq63/7sT4+PjExcf9/f3R0tP/89bf4OHl5ubl5ebk5ebj4+Tt7u7/////////////////////////////////////////////////////wjAkKS4XHCEaHyT/wCkiJywYHiMfJSobICYhJiv/vyQeIygcIicVGh//wSz/vyctMTYSGB0KDxUSFx1vUO58AAAAsHRSTlMA5eTH5u77+uPx/fz+8uX++/r31Xkg9drSOhIJ/Pv79vb19fPz8/Pz8+vq6uno57yj/f38+/r5+fj49/f39vb19fT09PDw7+7u6+bOybimlHFgWCkeGAb+/v38+vn4+Pf39vb29vX19PTz8/Hw7e3t7Ovr6+jn5+bm5d3Y18G0sZuPi4J9ZF5EDwz5+fb19fX19PT08/Pv7ezs6+vq6ejo6Ojn3suvl5GHbFRQSjECARZmqHoAAAO5SURBVEjHjZXle9NQFMbblEFSN9Yic0UmbGMbc2FjbsBwd3d3d3d3t+ZG2yTrgH+MJPfmCQ8k3c6Hfjq/5n3Pvee9Fq0uDZw8Fg509XwabxlVDdhcqzObq2/W1h8OThy5/WKxq7HCSQHAMt7mjM7+wRH6J3Y3+HkqSsrF8KBso6voQsL+H8UZKRJDaiVSFbW7ihNZ6XfVSXJjlKV4llO+Qnlurwr1TTQVFM5kGfmPneltO/IcIKqwoKT6bvj8d2PgK+Gj5H7HbhzD8MJ8j0KTHChtdJ2YYAicTiYZMuqcilnlwrBpyzlescILa5OtH42snEgDJMnW4HI7RB6lANUK66lreBOc9B9gW6IArZjarCLurXZkxbGZsH35DxgnA1SS0jtlukpY8Zfp0IoALm8giueaAWMWR3I7cGTFz4uKFYqblYy9H28CjI3FFs/BkPskB7LizM4I9A8aA3SEpldOQcjBPDuAIy7bSHRfMAEikVhk/T70kf01UQreFt8GImgGRIZii7aMQUh7BRDU2xLNyzptDEBk5h6k61CLg+XUEWdnnTMCUMWHlk3B4UEeaHYqVhiQdnieKaBaye1AyFS/IH9EsFedMQOQrsmzNStJw/KhSJWdZgAqOnblAbSCt5dwJJ8SMAc0K/TK6ZBopUhuxlFzQLeycDaU5eOjw0dGAcTjufATbdRoAFo5EDQqUliQUJI+JwjsLWFLzU0j+bkdaKwKMPyzPJwIiNNXpyM1r/OeyZI4z+pec4Cmx2qL4U5y/NqMYfd/VeJzjQAkfo52yNtLeQHk425H+rWg2eWLRe7sQ2qep4s8Q0rZeM6s+p5BLTUkHVDFL3uKLsTBHHXnGOHJi0yiVwscWyarA8oqbEPira2pcKt/risgwuf1FX3oBRoQ/2vZdvsoUV02cQ1RcGa+RQcet8+QfrcpwOSh9dooX+V7KEZZZzGlseAdClkEbMIK81O3K43btMA4kDMMs09KbXIdg+06UD4Nxw65oQ74u8OrRdKahlDfv+l6vNKPWWGh0FvL81roWXvnWf6tD7UgG9f7C1eQMFbZpZuInm8Gcf+Z8EpbMQymt7tlBgpue0t914DFqOaH0iRq+c5Ct9W9f6ePFaD4ulWhs2avXF+WH/CC3bvUaxfg48P7kwtOQfFGNam7ygEYTuRFDr4JZU2uIjhKkxpvu+5jRfhSc2BBzr235/RRGtsoykpLFQBgAWVfdws/e9EyUl0KhjJuVK+oKW+q2nVSf6ESygoe7woEOotOTUjc9weXiUPgDnteIQAAAABJRU5ErkJggg==',
      'searchUrl': 'https://radarr.video',
      'showByDefault': false},
  {   'name': 'Sonarr',
      'icon': 'data:image/png;base64,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',
      'searchUrl': 'https://sonarr.tv',
      'showByDefault': false}
];

var icon_sites = icon_sites_main.concat(special_buttons);

//==============================================================================
//    Replace Search URL parameters
//==============================================================================

async function replaceSearchUrlParams(site, movie_id, movie_title, movie_title_orig, movie_year, mPOSTsearch) {
  var search_url = ('mPOST' in site && !mPOSTsearch) ? site['mPOST'] : site['searchUrl'];
  // If an array, do a little bit of recursion
  if ($.isArray(search_url)) {
    var search_array = [];
    $.each(search_url, function(index, url) {
      search_array[index] = replaceSearchUrlParams(url, movie_id, movie_title, movie_title_orig, movie_year);
    });
    return search_array;
  }

  if (search_url.match("%tvdbid%")) {
    movie_id = await getTVDbID(movie_id);
  } else if (search_url.match("%tmdbid%")) {
    movie_id = await getTMDbID(movie_id);
  } else if (search_url.match("%doubanid%")) {
    movie_id = await getDoubanID0(movie_id);
  }
  if (search_url.match("%doubanid%") && movie_id == "00000000") {
    movie_id = await getDoubanID1(imdbid);
  }
  if (search_url.match("%doubanid%") && movie_id == "00000000") {
    movie_id = await getDoubanID2(imdbid);
  }
  if (search_url.match("%doubanid%") && movie_id == "00000000") {
    movie_id = await getDoubanID3(imdbid);
  }

  var space_replace      = ('spaceEncode' in site) ? site['spaceEncode'] : '+';
  var search_string      = movie_title.trim().replace(/ +\(.*|&|:/g, '').replace(/\s+/g, space_replace);
  var search_string_orig = movie_title_orig.trim().replace(/ +\(.*|&|:/g, '').replace(/\s+/g, space_replace);
  var movie_year         = (onSearchPage) ? movie_year : document.title.replace(/^(.+) \((\D*|)(\d{4})(.*)$/gi, '$3');
  var s = search_url.replace(/%tt%/g, 'tt' + movie_id)
                    .replace(/%nott%/g, movie_id)
                    .replace(/%tvdbid%/g, movie_id)
                    .replace(/%tmdbid%/g, movie_id)
                    .replace(/%doubanid%/g, movie_id)
                    .replace(/%search_string%/g, search_string)
                    .replace(/%search_string_orig%/g, search_string_orig)
                    .replace(/%year%/g, movie_year);
  return s;
}

//==============================================================================
//    Convert IMDb ID to TVDb/TMDb/Douban ID
//==============================================================================

function getTVDbID(movie_id) {
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 10000,
      url:    "https://thetvdb.com/api/GetSeriesByRemoteID.php?imdbid=tt" + movie_id,
      onload: function(response) {
        if (String(response.responseText).match("seriesid")) {
          response.responseXML = new DOMParser().parseFromString(response.responseText, "application/xml");
          const xmldata = response.responseXML;
          const tvdb_id = xmldata.getElementsByTagName("seriesid")[0].childNodes[0].nodeValue;
          resolve(tvdb_id);
        } else {
          const tvdb_id = "00000000";
          resolve(tvdb_id);
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getTVDbID)");
        console.log("IMDb Scout Mod (getTVDbID): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        resolve("00000000");
      },
      ontimeout: function() {
        resolve("00000000");
      }
    });
  });
}

function getTMDbID(movie_id) {
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 10000,
      url:    "https://api.themoviedb.org/3/find/tt" + movie_id + "?api_key=d12b33d3f4fb8736dc06f22560c4f8d4&external_source=imdb_id",
      onload: function(response) {
        const result = JSON.parse(response.responseText);
        if (String(response.responseText).match('movie_results":\\[{')) {
          const tmdb_id = result.movie_results[0].id;
          resolve(tmdb_id);
        } else if (String(response.responseText).match('tv_results":\\[{')) {
          const tmdb_id = result.tv_results[0].id;
          resolve(tmdb_id);
        } else if (String(response.responseText).match('tv_episode_results":\\[{')) {
          const tmdb_id = result.tv_episode_results[0].id;
          resolve(tmdb_id);
        } else {
          const tmdb_id = "00000000";
          resolve(tmdb_id);
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getTMDbID)");
        console.log("IMDb Scout Mod (getTMDbID): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        resolve("00000000");
      },
      ontimeout: function() {
        resolve("00000000");
      }
    });
  });
}

function getDoubanID0(movie_id) {
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 6000,
      url:    "https://movie.douban.com/j/subject_suggest?q=tt" + movie_id,
      onload: function(response) {
        const result = JSON.parse(response.responseText);
        if (String(response.responseText).match(movie_id)) {
          const douban_id = result[0].id;
          resolve(douban_id);
        } else {
          const douban_id = "00000000";
          resolve(douban_id);
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getDoubanID0)");
        console.log("IMDb Scout Mod (getDoubanID0): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (getDoubanID0): Request Aborted.");
        resolve("00000000");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (getDoubanID0): Request Timeout.");
        resolve("00000000");
      }
    });
  });
}

function getDoubanID1(movie_id) {
  console.log("IMDb Scout Mod (getDoubanID1): Started.");
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 8000,
      url:    "https://www.douban.com/search?cat=1002&q=tt" + movie_id,
      onload: function(response) {
        const parser = new DOMParser();
        const result = parser.parseFromString(response.responseText, "text/html");
        if ($(result).find('[onclick*=' +movie_id+ ']').length) {
          const x = $(result).find('[onclick*=' +movie_id+ ']').attr('href');
          if (x.match(/subject%2F(\d+)/)) {
            const y = x.match(/subject%2F(\d+)/)[1];
            resolve(y);
          } else {
            resolve("00000000");
          }
        } else {
          resolve("00000000");
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getDoubanID1)");
        console.log("IMDb Scout Mod (getDoubanID1): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (getDoubanID1): Request Aborted.");
        resolve("00000000");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (getDoubanID1): Request Timeout.");
        resolve("00000000");
      }
    });
  });
}

function getDoubanID2(movie_id) {
  console.log("IMDb Scout Mod (getDoubanID2): Started.");
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 8000,
      url:    'https://query.wikidata.org/sparql?format=json&query=SELECT * WHERE {?s wdt:P345 "tt' +movie_id+ '". OPTIONAL { ?s wdt:P4529 ?Douban_film_ID. }}',
      onload: function(response) {
        const result = JSON.parse(response.responseText);
        if (result.results.bindings[0] != undefined) {
          if (result.results.bindings[0].Douban_film_ID != undefined) {
            const douban_id = result.results.bindings[0].Douban_film_ID.value;
            resolve(douban_id);
          } else {
            const douban_id = "00000000";
            resolve("00000000");
          }
        } else {
          const douban_id = "00000000";
          resolve(douban_id);
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getDoubanID2)");
        console.log("IMDb Scout Mod (getDoubanID2): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (getDoubanID2): Request Aborted.");
        resolve("00000000");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (getDoubanID2): Request Timeout.");
        resolve("00000000");
      }
    });
  });
}

function getDoubanID3(movie_id) {
  console.log("IMDb Scout Mod (getDoubanID3): Started.");
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 10000,
      url:    'https://www.google.com/search?q="tt' +movie_id+ '" site:https://movie.douban.com/subject&safe=off',
      onload: function(response) {
        const result = String(response.responseText);
        if (result.match("movie.douban.com/subject/")) {
          const x = result.split("movie.douban.com/subject/")[1];
          const y = x.split("/")[0];
          const douban_id = y;
          resolve(douban_id);
        } else {
          const douban_id = "00000000";
          resolve(douban_id);
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getDoubanID3)");
        console.log("IMDb Scout Mod (getDoubanID3): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (getDoubanID3): Request Aborted.");
        resolve("00000000");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (getDoubanID3): Request Timeout.");
        resolve("00000000");
      }
    });
  });
}

function getAllocineID(movie_id) {
  return new Promise(resolve => {
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 10000,
      url:    'https://query.wikidata.org/sparql?format=json&query=SELECT * WHERE {?s wdt:P345 "tt' +movie_id+ '". OPTIONAL {?s wdt:P1265 ?AlloCin__film_ID.}  OPTIONAL {?s wdt:P1267 ?AlloCin__series_ID.}}',
      onload: function(response) {
        const result = JSON.parse(response.responseText);
        if (result.results.bindings[0] != undefined) {
          if (result.results.bindings[0].AlloCin__film_ID != undefined) {
            GM.setValue("AllocineID_last_is_film", true);
            const allocine_id = result.results.bindings[0].AlloCin__film_ID.value;
            resolve(allocine_id);
          } else if (result.results.bindings[0].AlloCin__series_ID != undefined) {
            GM.setValue("AllocineID_last_is_film", false);
            const allocine_id = result.results.bindings[0].AlloCin__series_ID.value;
            resolve(allocine_id);
          } else {
            GM.setValue("AllocineID_last_is_film", "none");
            const allocine_id = "00000000";
            resolve(allocine_id);
          }
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (getAllocineID)");
        console.log("IMDb Scout Mod (getAllocineID): Request Error.");
        resolve("00000000");
      },
      onabort: function() {
        resolve("00000000");
      },
      ontimeout: function() {
        resolve("00000000");
      }
    });
  });
}

//==============================================================================
//    Construct & return Title/List GM_config setting
//==============================================================================

function getPageSetting(key) {
  return (onSearchPage ? GM_config.get(key + '_search') : GM_config.get(key + '_movie'));
}

//==============================================================================
//    Get site's icon
//==============================================================================

function getFavicon(site, hide_on_err) {
  var favicon;
  if (typeof(hide_on_err) === 'undefined') {
    hide_on_err = false;
  } else if (hide_on_err === false) {
    return;
  }
  if ('icon' in site) {
    favicon = site['icon'];
  } else {
    var url = new URL(site['searchUrl']);
    favicon = url.origin + '/favicon.ico';
  }
  const size = GM_config.get('mod_icons_size');
  const border = parseInt(GM_config.get('iconsborder_size')) *2;
  var iconsize = ('matchRegex' in site) ? size : GM_config.get('call_http_mod_movie') ? size - border : size;
  var title = (site['TV']) ? site['name'] + ' (TV)' : site['name'];
  var img = $('<img />').attr({'style': '-moz-opacity: 0.4; border: 0',
                               'width': iconsize,
                               'height': iconsize,
                               'src': favicon,
                               'title': title,
                               'alt': site['name']});
  if (hide_on_err) { img.attr('onerror', "this.style.display='none';"); }
  return img;
}

//==============================================================================
//    Add search links to an element
//==============================================================================

function addLink(elem, site_name, target, site, state, scout_tick, post_data) {
  // State should always be one of the values defined in valid_states.
  if ($.inArray(state, valid_states) < 0) {
    console.log("Unknown state: " + state);
  }

  var link = $('<a />').attr('href', target).attr('target', '_blank');
  // Link and add Form element for POST method.
  if ('mPOST' in site) {
    var form_name = (site['TV']) ? site['name'] + '-TV-form-' + scout_tick : site['name'] + '-form-' + scout_tick;
    var placebo_url = new URL(target).origin;
    link = $('<a />').attr('href', placebo_url).attr('onclick', "$('#" + form_name + "').submit(); return false;").attr('target', '_blank');

    var data = (post_data.match('{')) ? post_data : '{"' + post_data.replace(/&/g, '","').replace(/=/g, '":"').replace(/\+/g, ' ') + '"}';
    var addform = $('<form></form>');
        addform.attr('id', form_name);
        addform.attr('action', target);
        addform.attr('method', 'post');
        addform.attr('style', 'display: none;');
        addform.attr('target', '_blank');

    if (post_data.match('},{')) {
      const dataArray = (new Function("return [" +data+ "];")());
      dataArray.forEach(function (item, index) {
        let addinput = $("<input>");
            addinput.attr('type', 'text');
            addinput.attr('name', item.key);
            addinput.attr('value', item.value);
        addform.append(addinput);
        $('body').append(addform);
      });
    } else {
      data = JSON.parse(data);
      for (const name in data) {
        let addinput = $("<input>");
            addinput.attr('type', 'text');
            addinput.attr('name', name);
            addinput.attr('value', data[name]);
        addform.append(addinput);
        $('body').append(addform);
     }
    }
  }
  // Icon/Text appearance.
  let icon;
  const border_width = GM_config.get('iconsborder_size');
  if (getPageSetting('use_mod_icons') && getPageSetting('call_http_mod')) {
    icon = getFavicon(site);
    (!GM_config.get('one_line') && !onSearchPage) ? icon.css({'border-width': '0px',        'border-style': 'solid', 'border-radius': '2px', 'margin': '1px 0px 2px'})
                                                  : icon.css({'border-width': border_width, 'border-style': 'solid', 'border-radius': '2px', 'margin': '1px 0px 2px'});
    if (state == 'error' || state == 'logged_out') {
      (getPageSetting('highlight_sites').split(',').includes(site['name'])) ? icon.css('border-color', 'rgb(255,0,0)')
                                                                            : icon.css('border-color', 'rgb(180,0,0)');
    } else if (state == 'missing') {
      (getPageSetting('highlight_sites').split(',').includes(site['name'])) ? icon.css('border-color', 'rgb(255,255,0)')
                                                                            : icon.css('border-color', 'rgb(230,200,100)');
    } else if (state == 'found') {
      (getPageSetting('highlight_sites').split(',').includes(site['name'])) ? icon.css('border-color', 'rgb(0,220,0)')
                                                                            : icon.css('border-color', 'rgb(0,130,0)');
        if ((site['name']).match('-Req')) icon.css('border-color', 'rgb(50,50,200)');
    }
    link.append(icon);
  } else if (!getPageSetting('use_mod_icons')) {
    site_name = (getPageSetting('highlight_sites').split(',').includes(site['name'])) ? site_name.bold() : site_name;
    if (state == 'missing' || state == 'error' || state == 'logged_out') {
      link.append($('<s />').append(site_name));
    } else {
      link.append(site_name);
    }
    if (state == 'error' || state == 'logged_out') {
      link.css('color', 'red');
    }
  } else {
    icon = getFavicon(site);
    icon.css({'border-width': '0px', 'border-style': 'solid', 'border-radius': '2px', 'margin': '1px 0px 2px'});
    (getPageSetting('highlight_sites').split(',').includes(site['name'])) ? icon.css('border-color', 'rgb(0,220,0)')
                                                                          : icon.css('border-color', 'rgb(0,130,0)');
    if ((site['name']).match('-Req')) icon.css('border-color', 'rgb(50,50,200)');
    link.append(icon);
  }
  // Create/find elements for Search/List pages.
  if (onSearchPage) {
    var result_box = $(elem).find('td.result_box');
    if (result_box.length == 0) {
      $(elem).append($('<td />').addClass('result_box'));
      $.each(valid_states, function(i, name) {
        $(elem).find('td.result_box').append("<span id='imdbscout_" + name + scout_tick + "'>"+'</span>');
      });
    }
  }
  if (onSearchPage && GM_config.get('load_third_bar_search')) {
    var result_box3 = $(elem).find('xd.result_box_3rd');
    if (result_box3.length == 0) {
      $(elem).append($('<xd />').addClass('result_box_3rd'));
      $.each(valid_states, function(i, name) {
        $(elem).find('xd.result_box_3rd').append("<span id='imdbscout3_" + name + scout_tick + "'>"+'</span>');
      });
    }
  }
  // Add links to IMDb page.
  var in_element_two = ('inSecondSearchBar' in site) ? site['inSecondSearchBar'] : false;
  var in_element_three = ('inThirdSearchBar' in site) ? site['inThirdSearchBar'] : false;
  if (onSearchPage && in_element_two || in_element_three && !getPageSetting('load_third_bar') || in_element_two && in_element_three) {
    return;
  } else if (!onSearchPage && in_element_two) {
    $('#imdbscoutsecondbar_' + state).append(link).append(' ');
  } else if (!onSearchPage && in_element_three) {
    $('#imdbscoutthirdbar_' + state).append(link).append(' ');
  } else if (!onSearchPage) {
    $('#imdbscout_' + state).append(link).append(' ');
  } else if (!in_element_three) {
    $('#imdbscout_' + state + scout_tick).append(link);
  } else {
    $('#imdbscout3_' + state + scout_tick).append(link);
  }

  if (onSearchPage) {
    // Hack: Convert link to button to deal with same-origin problem (icons mode only).
    // Sorting removes event, so on the title pages same hack will run at the end of the sorting (iconToButtonHack).
    if (site['name'] == "TorSyndikat") {
      const button = $('span[id*='+ scout_tick +']').find('img[title="TorSyndikat"]').parent();
      const link = button.attr('href');
            button.prop("href", "javascript: void(0)");
            button.removeAttr("target");
      button.click(function() {
        GM.openInTab(link);
      });
    }
    if (site['name'] == "TorSyndikat-Req") {
      const button = $('span[id*='+ scout_tick +']').find('img[title="TorSyndikat-Req"]').parent();
      const link = button.attr('href');
            button.prop("href", "javascript: void(0)");
            button.removeAttr("target");
      button.click(function() {
        GM.openInTab(link);
      });
    }
  }
  // Hack: Same-origin problem with POST, so remove 'onclick' form (icons mode only).
  if (site['name'] == "SFP-Req") {
    const button = $('img[title="SFP-Req"]').parent();
          button.prop("href", "https://s-f-p.dyndns.dk/viewrequests.php");
          button.removeAttr("onclick");
  }

  // Call to the sorting launcher.
  if (!onSearchPage && !in_element_two && !in_element_three) {
    iconSorterLauncher(site);
  }
}

function iconToButtonHack() {
  if ($('img[title="TorSyndikat"]').length) {
    const button = $('img[title="TorSyndikat"]').parent();
    const link = button.attr('href');
          button.prop("href", "javascript: void(0)");
          button.removeAttr("target");
    button.click(function() {
      GM.openInTab(link);
    });
  }
  if ($('img[title="TorSyndikat-Req"]').length) {
    const button = $('img[title="TorSyndikat-Req"]').parent();
    const link = button.attr('href');
          button.prop("href", "javascript: void(0)");
          button.removeAttr("target");
    button.click(function() {
      GM.openInTab(link);
    });
  }
}

//==============================================================================
//    Determine whether a site should be displayed
//==============================================================================

async function maybeAddLink(elem, site_name, search_url, site, scout_tick, movie_id, movie_title, movie_title_orig, movie_year) {
  // If the search URL is an array, recurse briefly on the elements.
  if ($.isArray(search_url)) {
    $.each(search_url, function(index, url) {
      maybeAddLink(elem, site_name + '_' + (index + 1).toString(), url, site);
    });
    return;
  }
  // Don't check the second/third bar sites if a 2nd/3rd bar is disabled in the Settings.
  var in_element_two = ('inSecondSearchBar' in site) ? site['inSecondSearchBar'] : false;
  var in_element_three = ('inThirdSearchBar' in site) ? site['inThirdSearchBar'] : false;
  if (in_element_two && !GM_config.get('load_second_bar') || in_element_three && !getPageSetting('load_third_bar') || in_element_two && in_element_three) {
    return;
  }
  // Don't check the second bar sites on a Search/List/Watchlist page.
  if (in_element_two && onSearchPage) {
    return;
  }
  // Connection rate limiter per domain.
  var set_rate = ('rateLimit' in site) ? site['rateLimit'] : 200;
  var rate     = (!onSearchPage) ? set_rate : (set_rate > 1000) ? set_rate : set_rate * 4;
  var domain   = search_url.split('/')[2];
  var now      = (new Date())*1;
  var lastLoaded = window.localStorage[domain+'_lastLoaded'];
  if (!lastLoaded) {
    lastLoaded = now - 50000;
  } else {
    lastLoaded = parseInt(lastLoaded);
  }
  if (now - lastLoaded < rate) {
    window.setTimeout(maybeAddLink.bind(undefined, elem, site['name'], search_url, site, scout_tick, movie_id, movie_title, movie_title_orig, movie_year), rate);
    return;
  } else {
    window.localStorage[domain+'_lastLoaded'] = (new Date())*1;
  }

  var success_match = ('positiveMatch' in site) ? site['positiveMatch'] : false;
  var target = search_url;
  if ('goToUrl' in site) {
    target = await replaceSearchUrlParams({'searchUrl': site['goToUrl'], 'spaceEncode': ('spaceEncode' in site) ? site['spaceEncode'] : '+'}, movie_id, movie_title, movie_title_orig, movie_year);
  }
  // Check tmdb/tvdb conversion.
  if (search_url.indexOf('=00000000') > -1 || search_url.indexOf('=undefined') > -1) {
    addLink(elem, site_name, target, site, 'error', scout_tick);
    return;
  }
  // Check for results with POST method.
  if ('mPOST' in site) {
    const post_data = await replaceSearchUrlParams(site, movie_id, movie_title, movie_title_orig, movie_year);
    GM.xmlHttpRequest({
      method: 'POST',
      timeout: parseInt(GM_config.get('timeout_ms')),
      url: search_url,
      data: post_data,
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      onload: function(response) {
        if (GM_config.get('debug_sites')) {
          const name = (site['TV']) ? site['name'] + ' (TV)' : site['name'];
          console.log(name + " POST Response Status: " + response.status + "\n ");
          console.log(name + " POST Response Headers: " + response.responseHeaders + "\n ");
          console.log(name + " POST Response: " + response.responseText + "\n ");
        }
        if (response.responseHeaders.indexOf('efresh: 0; url') > -1 || response.status > 499 || (response.status > 399 && !site.ignore404) || (response.responseText == "" && !site.ignoreEmpty)) {
          addLink(elem, site_name, target, site, 'logged_out', scout_tick, post_data);
        } else if (site['positiveMatch'] && site['loggedOutRegex'] && String(response.responseText).match(site['loggedOutRegex'])) {
          addLink(elem, site_name, target, site, 'logged_out', scout_tick, post_data);
        } else if (String(response.responseText).match(site['matchRegex']) ? !(success_match) : success_match) {
            if (getPageSetting('highlight_missing').split(',').includes(site['name'])) {
              if (elem.style) {
                elem.parentNode.style.background = 'rgba(255,104,104,0.7)';
              } else {
                document.querySelector('#imdbscout_missing').style.background = 'rgba(255,104,104,0.7)';
              }
            }
            if (!getPageSetting('hide_missing')) {
              addLink(elem, site_name, target, site, 'missing', scout_tick, post_data);
            }
        } else if (site['loggedOutRegex'] && String(response.responseText).match(site['loggedOutRegex'])) {
          addLink(elem, site_name, target, site, 'logged_out', scout_tick, post_data);
        } else {
          addLink(elem, site_name, target, site, 'found', scout_tick, post_data);
        }
      },
      onerror: function() {
        addLink(elem, site_name, target, site, 'error', scout_tick, post_data);
        console.log("IMDb Scout Mod (POST-Request Error. Site): " +site_name);
      },
      onabort: function() {
        addLink(elem, site_name, target, site, 'error', scout_tick, post_data);
        console.log("IMDb Scout Mod (POST-Request aborted. Site): " +site_name);
      },
      ontimeout: function() {
        addLink(elem, site_name, target, site, 'error', scout_tick, post_data);
        console.log("IMDb Scout Mod (POST-Request timed out. Site): " +site_name);
      }
    });
    return;
  }
  // Request header tweaks
  let reqHeader = {};
  if (site['name'] == "Milkie") {
    reqHeader = {
      "Host": "milkie.cc",
      "Authorization": GM_config.get("milkie_authToken")
    };
  } else if (site['name'] == "TNT") {
    reqHeader = {
      "Host": "tntracker.org",
      "Authorization": GM_config.get("tnt_authToken")
    };
  } else if (site['name'] == "DonTor") {
    reqHeader = {
      "Host": "dontorrents.one",
      "Referer": "https://dontorrents.one"
    };
  }
  // Check for results with GET method.
  GM.xmlHttpRequest({
    method: 'GET',
    headers: reqHeader,
    timeout: parseInt(GM_config.get('timeout_ms')),
    url: search_url,
    onload: function(response) {
      if (GM_config.get('debug_sites')) {
        const name = (site['TV']) ? site['name'] + ' (TV)' : site['name'];
        console.log(name + " GET Response Status: " + response.status + "\n ");
        console.log(name + " GET Response Headers: " + response.responseHeaders + "\n ");
        console.log(name + " GET Response: " + response.responseText + "\n ");
      }
      if (response.responseHeaders.indexOf('efresh: 0; url') > -1 || response.status > 499 || (response.status > 399 && !site.ignore404) || (response.responseText == "" && !site.ignoreEmpty)) {
        addLink(elem, site_name, target, site, 'logged_out', scout_tick);
      } else if (site['positiveMatch'] && site['loggedOutRegex'] && String(response.responseText).match(site['loggedOutRegex'])) {
        addLink(elem, site_name, target, site, 'logged_out', scout_tick);
      } else if (String(response.responseText).match(site['matchRegex']) ? !(success_match) : success_match) {
          if (getPageSetting('highlight_missing').split(',').includes(site['name'])) {
            if (elem.style) {
              elem.parentNode.style.background = 'rgba(255,104,104,0.7)';
            } else {
              document.querySelector('#imdbscout_missing').style.background = 'rgba(255,104,104,0.7)';
            }
          }
          if (!getPageSetting('hide_missing')) {
            addLink(elem, site_name, target, site, 'missing', scout_tick);
          }
      } else if (site['loggedOutRegex'] && String(response.responseText).match(site['loggedOutRegex'])) {
        addLink(elem, site_name, target, site, 'logged_out', scout_tick);
      } else {
        addLink(elem, site_name, target, site, 'found', scout_tick);
      }
    },
    onerror: function() {
      addLink(elem, site_name, target, site, 'error', scout_tick);
      console.log("IMDb Scout Mod (GET-Request Error. Site): " +site_name);
    },
    onabort: function() {
      addLink(elem, site_name, target, site, 'error', scout_tick);
      console.log("IMDb Scout Mod (GET-Request aborted. Site): " +site_name);
    },
    ontimeout: function() {
      addLink(elem, site_name, target, site, 'error', scout_tick);
      console.log("IMDb Scout Mod (GET-Request timed out. Site): " +site_name);
    }
  });
}

//==============================================================================
//    Perform code to create fields and display sites
//==============================================================================

function perform(elem, movie_id, movie_title, movie_title_orig, is_tv, is_movie, movie_year, scout_tick) {
  var site_shown = false;
  $.each(sites, async function(index, site) {
    if (site['show']) {
      site_shown = true;
      // For TV Series show only TV links. TV Special, TV Movie, Episode & Documentary are treated as TV and Movie.
      if ((Boolean(site['TV']) == is_tv || Boolean(site['both'])) || (!is_tv && !is_movie) || getPageSetting('ignore_type')) {
        var searchUrl = await replaceSearchUrlParams(site, movie_id, movie_title, movie_title_orig, movie_year, true);
        if ('goToUrl' in site && getPageSetting('call_http_mod')) {
          maybeAddLink(elem, site['name'], searchUrl, site, scout_tick, movie_id, movie_title, movie_title_orig, movie_year);
        }
        if ('goToUrl' in site && !getPageSetting('call_http_mod')) {
          searchUrl = await replaceSearchUrlParams({'searchUrl': site['goToUrl'], 'spaceEncode': ('spaceEncode' in site) ? site['spaceEncode'] : '+'}, movie_id, movie_title, movie_title_orig, movie_year);
          addLink(elem, site['name'], searchUrl, site, 'found', scout_tick);
        }
        if (!('goToUrl' in site) && getPageSetting('call_http_mod')) {
          maybeAddLink(elem, site['name'], searchUrl, site, scout_tick, movie_id, movie_title, movie_title_orig, movie_year);
        }
        if (!('goToUrl' in site) && !getPageSetting('call_http_mod')){
          addLink(elem, site['name'], searchUrl, site, 'found', scout_tick);
        }
      }
    }
  });

  if (!site_shown) {
    $(elem).append("<pre>No sites enabled!\nScript's settings can be found in your Monkey's shortcut.\nFor now you can press this temporary button:");
    var p = $('<p />').attr('id', 'imdbscout_settings_button');
        p.append($('<button>Load Settings</button>').css({'cursor':'pointer', 'background-color':'#F5C518', 'color':'blue', 'font-weight':'bold'}).click(function() {
          GM_config.open();
          $('#imdbscout_settings_button').remove();
    }));
    $(elem).append(p);
  }
}

//==============================================================================
//    'Load' button code
//==============================================================================

// Runs when "Load on Start?" is disabled.
function displayButton() {
  var p = $('<p />').attr('id', 'imdbscout_button');
  p.append($('<button>Load links</button>').css({'background-color':'#F5C518', 'color':'blue', 'font-weight':'bold'}).click(function() {
    $('#imdbscout_button').remove();
    if (onSearchPage) {
      performSearch();
    } else {
      performPage();
    }
  }));
  if (onSearchPage) {
    $('#sidebar').prepend(p);
  } else if ($('[class^=SubNav__SubNavContainer]').length) {
    $('[class^=SubNav__SubNavContainer]').append(p);
  // reference
  } else if ($('.titlereference-header').length) {
    $('.titlereference-header').append(p);
  }
}

//==============================================================================
//    Icons at top bar on Title page
//==============================================================================

// Unlike the other URLs, they aren't checked to see if the movie exists.
function addIconBar(movie_id, movie_title, movie_title_orig) {
  var iconbar;
  if ($('[class^=TitleBlock__TitleContainer]').length) {
    iconbar = getIconsLinkArea();
  // reference + remove "Reference View" txt and a link to settings
  } else if ($('.titlereference-header div script').length) {
    // wrap text node for removal
    $($('.titlereference-header div script')[0].nextSibling).wrap('<span class="removethis"/>');
    $('.removethis').remove();
    $('.titlereference-change-view-link').remove();
    iconbar = getIconsLinkArea();
  // in case if code above breaks
  } else if ($('h3[itemprop="name"]').length) {
    iconbar = $('h3[itemprop="name"]').append($('<br/>'));
  }

  $.each(icon_sites, async function(index, site) {
    if (site['show']) {
      var search_url = ('mPOST' in site) ? site['searchUrl'] : await replaceSearchUrlParams(site, movie_id, movie_title, movie_title_orig);
      var image = getFavicon(site);
      var html = $('<span />').append("&nbsp;").attr('style', 'font-size: 11px;').append($('<a />').attr('href', search_url).attr('target', '_blank').addClass('iconbar_icon').append(image));
      // Link and add Form element for POST method.
      if ('mPOST' in site) {
        var form_name = site['name'] + '-iconform';
        var placebo_url = new URL(site['searchUrl']).origin;
        html = $('<span />').append("&nbsp;").attr('style', 'font-size: 11px;').append($('<a />').attr('href', placebo_url).attr('onclick', "$('#" + form_name + "').submit(); return false;").attr('target', '_blank').addClass('iconbar_icon').append(image));

        var post_data = await replaceSearchUrlParams(site, movie_id, movie_title, movie_title_orig);
        var data = (post_data.match('{')) ? post_data : '{"' + post_data.replace(/&/g, '","').replace(/=/g, '":"').replace(/\+/g, ' ') + '"}';
        var addform = $('<form></form>');
            addform.attr('id', form_name);
            addform.attr('action', search_url);
            addform.attr('method', 'post');
            addform.attr('style', 'display: none;');
            addform.attr('target', '_blank');

        if (post_data.match('},{')) {
          const dataArray = (new Function("return [" +data+ "];")());
          dataArray.forEach(function (item, index) {
            let addinput = $("<input>");
                addinput.attr('type', 'text');
                addinput.attr('name', item.key);
                addinput.attr('value', item.value);
            addform.append(addinput);
            $('body').append(addform);
          });
        } else {
          data = JSON.parse(data);
          for (const name in data) {
            let addinput = $("<input>");
                addinput.attr('type', 'text');
                addinput.attr('name', name);
                addinput.attr('value', data[name]);
            addform.append(addinput);
            $('body').append(addform);
         }
        }
      }
      iconbar.append(html).append();
      // Call to 'Copy Info to BBcode' funcs.
      if (site['name'] == "Copy Info to BBcode"){
      start_copyInfoToBBcode(movie_id, movie_title_orig);
      }
      // Call to Emby funcs.
      if (site['name'] == "Emby"){
      start_emby(movie_id, movie_title, movie_title_orig);
      }
      // Call to Plex funcs.
      if (site['name'] == "Plex"){
      start_plex(movie_id, movie_title, movie_title_orig);
      }
      // Call to Radarr funcs.
      if (site['name'] == "Radarr"){
      get_radarr_movies(movie_id);
      }
      // Call to Sonarr funcs.
      if (site['name'] == "Sonarr"){
      get_sonarr_tvseries(movie_id);
      }
      // Call to Trakt-Watchlist funcs.
      if (site['name'] == "Trakt-Watchlist"){
      start_trakt(movie_id, movie_title);
      }
    }
  });

  if (!GM_config.get("remove_openall")) {
    // If we have access to the openInTab function, add an Open All feature.
    if (GM.openInTab) {
      // Wrapped in timeout because the button lands in front of icons (async function).
      setTimeout(() => {
        var aopenall = $('<a />').text('Open All').prepend("&nbsp;").attr('href', 'javascript:;').attr('style', 'font-weight:bold;font-size:11px;font-family: Calibri, Verdana, Arial, Helvetica, sans-serif;');
            aopenall.click(function() {
              $('.iconbar_icon').each(function() {
                GM.openInTab($(this).attr('href'));
              });
            });
        iconbar.append(aopenall);
        // Rename class of the special buttons so "Open all" wouldn't open them.
        $('img[title="Copy info to BBCode"]').parent().removeClass('iconbar_icon').addClass('iconbar_spec_icon');
        $('img[title="Emby"]').parent().removeClass('iconbar_icon').addClass('iconbar_spec_icon');
        $('img[title="Jellyfin"]').parent().removeClass('iconbar_icon').addClass('iconbar_spec_icon');
        $('img[title="Plex"]').parent().removeClass('iconbar_icon').addClass('iconbar_spec_icon');
        $('img[title="Radarr"]').parent().attr('class','iconbar_spec_icon');
        $('img[title="Sonarr"]').parent().attr('class','iconbar_spec_icon');
        $('img[title="Trakt-Watchlist"]').parent().attr('class','iconbar_spec_icon');
      }, 300);
    }
  }
}

// Create elements for the icons bar
function getIconsLinkArea() {
  // If it already exists, just return it
  if ($('#imdbscout_iconsheader').length) {
    return $('#imdbscout_iconsheader');
  }
  var p = $('<p />').attr('id', 'imdbscout_iconsheader').css({
    'padding': '0px 0px',
    'margin-left': '0px',
    'margin-right': '0px',
    'margin-top': '0px',
    'margin-bottom': '0px',
    'overflow': 'hidden',
  });
  if ($('[class^=TitleBlock__TitleContainer]').length) {
    $('[class^=TitleBlock__TitleContainer]').append(p);
  // reference
  } else if ($('.titlereference-header div hr').first().length) {
    $('.titlereference-header div hr').first().after(p);
  }
  var styles = '#imdbscout_iconsheader {line-height: 16px;} ';
  GM_addStyle(styles);
  return $('#imdbscout_iconsheader');
}

//==============================================================================
//    Search/List/Watchlist page code
//==============================================================================

function performSearch() {
  //Add css for the new table cells we're going to add
  var styles  = '.result_box {width: 975px} ';
      styles += '.result_box a { margin-right: 5px; color: #444;} ';
      styles += '.result_box a:visited { color: #551A8B; } ';
      styles += '#content-2-wide #main, #content-2-wide ';
      styles += '.maindetails_center {margin-left: 5px; width: 1001px;} ';
  GM_addStyle(styles);

  if (getPageSetting('load_third_bar')) {
    var styles3  = '.result_box_3rd {width: 975px} ';
        styles3 += '.result_box_3rd a { margin-right: 5px; color: #444;} ';
        styles3 += '.result_box_3rd a:visited { color: #551A8B; } ';
        styles3 += '#content-2-wide #main, #content-2-wide ';
        styles3 += '.maindetails_center {margin-left: 5px; width: 1001px;} ';
    GM_addStyle(styles3);
  }
  var showsites = public_sites.concat(private_sites, german_sites, usenet_sites).reduce(function (n, site) {
      return n + (site['show'] == true); }, 0);

  var search_page = (Boolean(location.href.match('/search/'))) ? true : false;
  if($('.lister-list').children().length !== 0) {
    $('.lister-list').children().each(function() {
      var elem     = (search_page) ? $(this).find('.lister-item-content') : $(this);
      var link     = $(this).find('.lister-item-image>a');
      var movie_id = link.attr('href').match(/tt([0-9]*)\/?.*/)[1];

      var scout_tick = window.localStorage['_imdbscoutmod_tick'];
      if (!scout_tick) {
        scout_tick = 1;
        window.localStorage['_imdbscoutmod_tick'] = scout_tick;
      }

      performSearchSecondPart(elem, link, movie_id, showsites, scout_tick);
      scout_tick = parseInt(scout_tick) + 1;
      window.localStorage['_imdbscoutmod_tick'] = scout_tick;
    });
  }
}

function performSearchSecondPart(elem, link, movie_id, showsites, scout_tick) {
  // Connection rate limiter for IMDb.
  var rate;
  if (!(GM_config.get('call_http_mod_search'))) {
    rate =  400;
  } else if (showsites > 99) {
    rate = 6000;
  } else if (showsites > 80) {
    rate = 5000;
  } else if (showsites > 60) {
    rate = 3500;
  } else if (showsites > 40) {
    rate = 2500;
  } else if (showsites > 20) {
    rate = 2000;
  } else if (showsites > 10) {
    rate = 1500;
  } else {
    rate = 800;
  }
  var domain = "https://www.imdb.com";
  var now    = (new Date())*1;
  var lastLoaded = window.localStorage[domain+'_lastLoaded'];
  if (!lastLoaded) {
    lastLoaded = now - 8000;
  } else {
    lastLoaded = parseInt(lastLoaded);
  }
  if (now - lastLoaded < rate) {
    window.setTimeout(performSearchSecondPart.bind(undefined, elem, link, movie_id, showsites, scout_tick), rate);
    return;
  } else {
    window.localStorage[domain+'_lastLoaded'] = (new Date())*1;
  }

  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    "https://www.imdb.com" + link.attr('href'),
    onload: function(response) {
      var parser = new DOMParser();
      var result = parser.parseFromString(response.responseText, "text/html");

      var is_tv    = Boolean($(result).find('title').text().match('TV Series'));
      // newLayout || reference : check if 'title' has just a year in brackets, eg. "(2009)"
      var is_movie = (Boolean($(result).find('[class^=TitleBlock__TitleMetaDataContainer]').text().match('TV')) || Boolean($(result).find('li.ipl-inline-list__item').text().match('TV Special'))) ? false : Boolean($(result).find('title').text().match(/.*? \(([0-9]*)\)/));
      // newLayout || reference
      if (Boolean($(result).find('[class^=GenresAndPlot__Genre]').text().match('Documentary')) || Boolean($(result).find('li.ipl-inline-list__item').text().match('Documentary'))) {
        is_tv    = false;
        is_movie = false;
      }
      var movie_year  = result.title.replace(/^(.+) \((\D*|)(\d{4})(.*)$/gi, '$3');
      var movie_title = $(result).find('[class^=TitleHeader__TitleText]').text().trim();
      // reference
      if (movie_title === "") {
        movie_title = $(result).find('h3[itemprop="name"]').text().trim();
        movie_title = movie_title.substring(movie_title.lastIndexOf("\n") + 1, -1 ).trim();
      }
      var movie_title_orig = $(result).find('[class^=OriginalTitle__OriginalTitleText]').text().trim().replace("Original title: ", "");
      // reference
      if (movie_title_orig === "" && $(result).find('h3[itemprop="name"]').length) {
        movie_title_orig = $.trim($($(result).find('h3[itemprop="name"]')[0].nextSibling).text());
      }
      // not found
      if (movie_title_orig === "") {
        movie_title_orig = movie_title;
      }
      perform(elem, movie_id, movie_title, movie_title_orig, is_tv, is_movie, movie_year, scout_tick);
      },
      onerror: function() {
        console.log("IMDb Scout Mod (Lists): Request Error.");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (Lists): Abort.");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (Lists): Time out.");
      }
  });
}

//==============================================================================
//    Title page code
//==============================================================================

function performPage() {
  var movie_title = $('[class^=TitleHeader__TitleText]').text().trim();
  // reference
  if (movie_title === "") {
    movie_title = $('h3[itemprop="name"]').text().trim();
    movie_title = movie_title.substring(movie_title.lastIndexOf("\n") + 1, -1 ).trim();
  }
  var movie_title_orig = $('[class^=OriginalTitle__OriginalTitleText]').text().trim().replace("Original title: ", "");
  // reference
  if (movie_title_orig === "" && $('h3[itemprop="name"]').length) {
    movie_title_orig = $.trim($($('h3[itemprop="name"]')[0].nextSibling).text());
  }
  // not found
  if (movie_title_orig === "") {
    movie_title_orig = movie_title;
  }

  var movie_id = document.URL.match(/\/tt([0-9]+)\//)[1].trim('tt');
  var is_tv    = Boolean($('title').text().match('TV Series'));
  // newLayout || reference : check if 'title' has just a year in brackets, eg. "(2009)"
  var is_movie = (Boolean($('[class^=TitleBlock__TitleMetaDataContainer]').text().match('TV')) || Boolean($('li.ipl-inline-list__item').text().match('TV Special'))) ? false : Boolean($('title').text().match(/.*? \(([0-9]*)\)/));
  // newLayout || reference
  if (Boolean($('[class^=GenresAndPlot__Genre]').text().match('Documentary')) || Boolean($('li.ipl-inline-list__item').text().match('Documentary'))) {
    is_tv    = false;
    is_movie = false;
  }

  // Start of External ratings code
  if (GM_config.get("ratings_cfg_imdb") || GM_config.get("ratings_cfg_metacritic") || GM_config.get("ratings_cfg_rotten") || GM_config.get("ratings_cfg_letterboxd")) {
    externalRatings(movie_id, movie_title, movie_title_orig);
  }
  // Call to iconSorterCount() for the icons/sites sorting.
  iconSorterCount(is_tv, is_movie);

  // Create areas to put links in
  addIconBar(movie_id, movie_title, movie_title_orig);
  perform(getLinkArea(), movie_id, movie_title, movie_title_orig, is_tv, is_movie);
  if (GM_config.get('load_second_bar') && !GM_config.get('load_third_bar_movie')) {
    getLinkAreaSecond();
  } else if (!GM_config.get('load_second_bar') && GM_config.get('load_third_bar_movie')) {
    getLinkAreaThird();
  } else if (GM_config.get('load_second_bar') && GM_config.get('load_third_bar_movie') && !GM_config.get('switch_bars')) {
    getLinkAreaSecond();
    getLinkAreaThird();
  } else if (GM_config.get('load_second_bar') && GM_config.get('load_third_bar_movie') && GM_config.get('switch_bars')) {
    getLinkAreaThird();
    getLinkAreaSecond();
  }
}

//==============================================================================
//    Create elements for the 1st search bar on Title page
//==============================================================================

function getLinkArea() {
  // If it already exists, just return it
  if ($('#imdbscout_header').length) {
    return $('#imdbscout_header');
  }
  var font_weight = (GM_config.get('highlight_sites_movie').length == 0) ? 'bold' : 'normal';
  let backgroundColor;
  if (onReferencePage) {
    backgroundColor = (GM_config.get('greybackground_reference_view')) ? '#333333' : '#ffffff' ;
  } else {
    backgroundColor = '#333333';
  }
  var p = $('<p />').append(GM_config.get('imdbscoutmod_header_text')).attr('id', 'imdbscout_header').css({
    'padding': '4px 10px',
    'font-weight': font_weight,
    'background-color': backgroundColor,
    'margin-top': '0px',
    'margin-bottom': '0px',
    'overflow': 'hidden',
    'color': '#EEEEEE'
  });

  $.each(valid_states, function(i, name) {
    if (GM_config.get('one_line')) {
      p.append($('<span />').attr('id', 'imdbscout_' + name));
    } else {
      var title = $('<span>' + name.replace('_', ' ') + ': </span>').css({
        'textTransform': 'capitalize',
        'min-width': '100px',
        'display': 'inline-block'
      });
      p.append($('<div />').attr('id', 'imdbscout_' + name).append(title));
    }
  });

  if ($('[class^=SubNav__SubNavContainer]').length) {
    $('[class^=SubNav__SubNavContainer]').append(p);
  // reference
  } else if ($('.titlereference-header').length) {
    $('.titlereference-header').append(p);
    if (GM_config.get('dark_reference_view')) {
      const hr = $('<hr>').css({'margin': '0px'});
      $('#imdbscout_header').after(hr);
    }
  }
  return $('#imdbscout_header');
}

//==============================================================================
//    Create elements for the 2nd search bar on Title page
//==============================================================================

function getLinkAreaSecond() {
  // If it already exists, just return it
  if ($('#imdbscoutsecondbar_header').length) {
    return $('#imdbscoutsecondbar_header');
  }
  var font_weight = (GM_config.get('highlight_sites_movie').length == 0) ? 'bold' : 'normal';
  let backgroundColor;
  if (onReferencePage) {
    backgroundColor = (GM_config.get('greybackground_reference_view')) ? '#333333' : '#ffffff' ;
  } else {
    backgroundColor = '#333333';
  }
  var p = $('<p />').append(GM_config.get('imdbscoutsecondbar_header_text')).attr('id', 'imdbscoutsecondbar_header').css({
    'padding': '4px 10px',
    'font-weight': font_weight,
    'background-color': backgroundColor,
    'margin-top': '0px',
    'margin-bottom': '0px',
    'overflow': 'hidden',
    'color': '#EEEEEE'
  });

  $.each(valid_states, function(i, name) {
    if (GM_config.get('one_line')) {
      p.append($('<span />').attr('id', 'imdbscoutsecondbar_' + name));
    } else {
      var title = $('<span>' + name.replace('_', ' ') + ': </span>').css({
        'textTransform': 'capitalize',
        'min-width': '100px',
        'display': 'inline-block'
      });
      p.append($('<div />').attr('id', 'imdbscoutsecondbar_' + name).append(title));
    }
  });
  if ($('[class^=SubNav__SubNavContainer]').length) {
    $('[class^=SubNav__SubNavContainer]').append(p);
  // reference
  } else if ($('.titlereference-header').length) {
    $('.titlereference-header').append(p);
    if (GM_config.get('dark_reference_view')) {
      const hr = $('<hr>').css({'margin': '0px'});
      $('#imdbscoutsecondbar_header').after(hr);
    }
  }
  return $('#imdbscoutsecondbar_header');
}

//==============================================================================
//     Create elements for the 3rd search bar on Title page
//==============================================================================

function getLinkAreaThird() {
  // If it already exists, just return it
  if ($('#imdbscoutthirdbar_header').length) {
    return $('#imdbscoutthirdbar_header');
  }
  var font_weight = (GM_config.get('highlight_sites_movie').length == 0) ? 'bold' : 'normal';
  let backgroundColor;
  if (onReferencePage) {
    backgroundColor = (GM_config.get('greybackground_reference_view')) ? '#333333' : '#ffffff' ;
  } else {
    backgroundColor = '#333333';
  }
  var p = $('<p />').append(GM_config.get('imdbscoutthirdbar_header_text')).attr('id', 'imdbscoutthirdbar_header').css({
    'padding': '4px 10px',
    'font-weight': font_weight,
    'background-color': backgroundColor,
    'margin-top': '0px',
    'margin-bottom': '0px',
    'overflow': 'hidden',
    'color': '#EEEEEE'
  });

  $.each(valid_states, function(i, name) {
    if (GM_config.get('one_line')) {
      p.append($('<span />').attr('id', 'imdbscoutthirdbar_' + name));
    } else {
      var title = $('<span>' + name.replace('_', ' ') + ': </span>').css({
        'textTransform': 'capitalize',
        'min-width': '100px',
        'display': 'inline-block'
      });
      p.append($('<div />').attr('id', 'imdbscoutthirdbar_' + name).append(title));
    }
  });
  if ($('[class^=SubNav__SubNavContainer]').length) {
    $('[class^=SubNav__SubNavContainer]').append(p);
  // reference
  } else if ($('.titlereference-header').length) {
    $('.titlereference-header').append(p);
    if (GM_config.get('dark_reference_view')) {
      const hr = $('<hr>').css({'margin': '0px'});
      $('#imdbscoutthirdbar_header').after(hr);
    }
  }
  return $('#imdbscoutthirdbar_header');
}

//==============================================================================
//    Icons/sites sorting
//==============================================================================

// Count selected sites for the sorting launcher (showSitezFirstBar).
function iconSorterCount(is_tv, is_movie) {
  let sitestosort = public_sites.concat(private_sites, german_sites, usenet_sites);
  if (!is_tv && !is_movie || getPageSetting('ignore_type')) {
    showSitezFirstBar = sitestosort.reduce(function (n, site) {
      return n + (site['show'] == true); }, 0);
  } else if (is_tv && !getPageSetting('ignore_type')) {
    const showtvsitez = public_sites.concat(private_sites, german_sites, usenet_sites).reduce(function (n, site) {
      return n + (site['TV'] == true && site['show'] == true); }, 0);
    const showbothsitez = public_sites.concat(private_sites, german_sites, usenet_sites).reduce(function (n, site) {
      return n + (site['both'] == true && site['show'] == true); }, 0);
    showSitezFirstBar = showtvsitez + showbothsitez;
  } else if (is_movie && !getPageSetting('ignore_type')) {
    const showallsitez = sitestosort.reduce(function (n, site) {
      return n + (site['show'] == true); }, 0);
    const showtvsitez = public_sites.concat(private_sites, german_sites, usenet_sites).reduce(function (n, site) {
      return n + (site['TV'] == true && site['show'] == true); }, 0);
    showSitezFirstBar = showallsitez - showtvsitez;
  }
}

// Sorting launcher.
function iconSorterLauncher(site) {
  showSitezFirstBar = showSitezFirstBar - 1;

  if (GM_config.get("sortReqOnNewLine") && showSitezFirstBar == 0) {
    sortReqOnNewLineTemp = true;
  }
  //console.log('Sites left: ' + showSitezFirstBar + ", Added: " + site['name']);
  if (showSitezFirstBar < 4) {
    iconSorterFound();
    iconSorterMissing();
    //console.log('SORTING!');
  }
  if (showSitezFirstBar == 0) {
    iconToButtonHack();
  }
}

// Sorting of the found sites.
function iconSorterFound() {
  const imdbscout_found = document.querySelector("#imdbscout_found");

  const sorta = (list) => { // sort alphabetically
    return list.sort((a, b) => {
      if (GM_config.get("use_mod_icons_movie")) {
        if (a.firstChild.getAttribute("alt").toLowerCase() < b.firstChild.getAttribute("alt").toLowerCase()) {
          return -1;
        } else if (a.firstChild.getAttribute("alt").toLowerCase() > b.firstChild.getAttribute("alt").toLowerCase()) {
          return 1;
        } else {
          return 0;
        }
      } else {
        if (a.textContent.toLowerCase() < b.textContent.toLowerCase()) {
          return -1;
        } else if (a.textContent.toLowerCase() > b.textContent.toLowerCase()) {
          return 1;
        } else {
          return 0;
        }
      }
    });
  };

  let highlighted = [], requests = [], others = [];

  let children = imdbscout_found.children;
  if (!GM_config.get('one_line')) {
    let [removed, ...children2] = children;
    children = children2;
  }
  for (const child of children) {
    if (GM_config.get("use_mod_icons_movie")) {
      if (child.firstChild.getAttribute("alt").includes("-Req")) {
        requests.push(child);
      } else {
        child.children[0].style.border.includes("solid rgb(0, 220, 0)") ? highlighted.push(child) : others.push(child);
      }
    } else {
      if (child.textContent.includes("-Req")) {
        requests.push(child);
      } else {
        child.querySelector("b") ? highlighted.push(child) : others.push(child);
      }
    }
  }

  let sorted;
  if (GM_config.get("highlight_sites_movie").includes(",")) {
    const highlighted_sites = GM_config.get("highlight_sites_movie").split(",");
    let hl_temp = [];
    for (const hl of highlighted_sites) {
      for (const hl_node of highlighted) {
        if (hl === (!GM_config.get("use_mod_icons_movie") ? hl_node.textContent : hl_node.children[0].getAttribute("alt"))) {
          hl_temp.push(hl_node);
        }
      }
    }
    sorted = [...hl_temp, ...sorta(others)];
  } else {
    sorted = [...sorta(highlighted), ...sorta(others)];
  }

  for (const node of sorted) {
    node.remove();
    imdbscout_found.insertAdjacentHTML("beforeend", node.outerHTML + " ");
  }

  sortReqOnNewLineTemp && requests.length > 0 ? imdbscout_found.insertAdjacentHTML("beforeend", "</br>") : false;
  for (const node of requests) {
    node.remove();
    imdbscout_found.insertAdjacentHTML("beforeend", node.outerHTML + " ");
  }
  sortReqOnNewLineTemp && requests.length > 0 ? imdbscout_found.insertAdjacentHTML("beforeend", "</br>") : false;
}

// Sorting of the missing sites.
function iconSorterMissing() {
  if (GM_config.get("hide_missing_movie") || !GM_config.get("call_http_mod_movie")) {
  return;
  }
  const imdbscout_missing = document.querySelector("#imdbscout_missing");

  const sorta = (list) => {
    return list.sort((a, b) => { // sort alphabetically
      if (GM_config.get("use_mod_icons_movie")) {
        if (a.firstChild.getAttribute("alt").toLowerCase() < b.firstChild.getAttribute("alt").toLowerCase()) {
          return -1;
        } else if (a.firstChild.getAttribute("alt").toLowerCase() > b.firstChild.getAttribute("alt").toLowerCase()) {
          return 1;
        } else {
          return 0;
        }
      } else {
        if (a.textContent.toLowerCase() < b.textContent.toLowerCase()) {
          return -1;
        } else if (a.textContent.toLowerCase() > b.textContent.toLowerCase()) {
          return 1;
        } else {
          return 0;
        }
      }
    });
  };

  let all = [];

  let children = imdbscout_missing.children;
  if (!GM_config.get('one_line')) {
    let [removed, ...children2] = children;
    children = children2;
  }
  for (const child of children) {
    all.push(child);
  }

  let sorted = [...sorta(all)];

  for (const node of sorted) {
    node.remove();
    imdbscout_missing.insertAdjacentHTML("beforeend", node.outerHTML + " ");
  }
}

//==============================================================================
//    Special button: Copy info to BBCode
//==============================================================================

function start_copyInfoToBBcode(imdbid, movie_title_orig) {
  const standby_icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAACpjQD94zkmAAAAAXRSTlMAQObYZgAAALBJREFUKM910rENwyAUBNCPKFKyQdiErEVhKYzGKIzgkgLl4v/x2Y7k0PCQ7nQNcp53n7fHZ+IBFEMAqiECzfASvxqSuFlbxA1i9vMFjahEQZ+Yc9lWikJX6kQNTWFzhiS+b+BcjkPnDFkcDhSialjRiJXoe4YQGUQinjNMRPQTlvkFW3/rt1iIxPCLiJXAPhEIT8gBtm6xXJEUaX/onAxFLOK6AYAhbFgVHvwEG+Q4X86vk0jZCGx+AAAAAElFTkSuQmCC';
  let button = $('a[href="https://dummycopy.info"]');
      button.addClass('CopyInfotoBBcode');
      button.removeAttr("href");
      button.removeAttr("target");
  button.prop("href", "javascript: void(0)");
  button.click(function() {
    button.find('img').prop("src", standby_icon);
    copyInfoToBBcode(imdbid, movie_title_orig);
  });
}

async function copyInfoToBBcode(imdbid, movie_title_orig) {
  const error_icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAACgAAB8H+SvAAAAAXRSTlMAQObYZgAAALBJREFUKM910rENwyAUBNCPKFKyQdiErEVhKYzGKIzgkgLl4v/x2Y7k0PCQ7nQNcp53n7fHZ+IBFEMAqiECzfASvxqSuFlbxA1i9vMFjahEQZ+Yc9lWikJX6kQNTWFzhiS+b+BcjkPnDFkcDhSialjRiJXoe4YQGUQinjNMRPQTlvkFW3/rt1iIxPCLiJXAPhEIT8gBtm6xXJEUaX/onAxFLOK6AYAhbFgVHvwEG+Q4X86vk0jZCGx+AAAAAElFTkSuQmCC';
  const ready_icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAAAAZACk9hdsAAAAAXRSTlMAQObYZgAAALBJREFUKM910rENwyAUBNCPKFKyQdiErEVhKYzGKIzgkgLl4v/x2Y7k0PCQ7nQNcp53n7fHZ+IBFEMAqiECzfASvxqSuFlbxA1i9vMFjahEQZ+Yc9lWikJX6kQNTWFzhiS+b+BcjkPnDFkcDhSialjRiJXoe4YQGUQinjNMRPQTlvkFW3/rt1iIxPCLiJXAPhEIT8gBtm6xXJEUaX/onAxFLOK6AYAhbFgVHvwEG+Q4X86vk0jZCGx+AAAAAElFTkSuQmCC';
  const success_icon1 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAAAAZACk9hdsAAAAAXRSTlMAQObYZgAAAKZJREFUKM990cENwyAMBVBHHHpkg7JJslYPkcpojMIIHH1A/FKTTxVViSXgHWwh68uv3jpehzbwAKLBA8kQgGzYgELomAYq0f6QiURE6IBDG/BANAQgDSSfDZu4YljFqWGXpRLN8JIFE5FIRCYKoXKGSCVW4nlGgN6CzZfj99jYPBEm+IUnHCFEr2/zBfYJW/C4dguxn2r5RlnUAMDgcSTtwPA6ZNYH82fX5apYo9sAAAAASUVORK5CYII=';
  const success_icon2 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAAAAZACk9hdsAAAAAXRSTlMAQObYZgAAAJxJREFUKM+V0rENxCAMBVCiFFcyApuEtVJECqMxCiNQUiD+WfZ97qJTirjxK/6XG7vvnM32imF4AUnhgawIQFFEt1bF5harHW7phPX3HxQiEwnNYOd2vZIUAchEUUSgEk1xAl0QumAQmEhE/oRRiEo0ZiY6MSY0fIO/8MM6cRAbEYmQCXSDJ1bCETKPEAX9giBoF3hBta/gEwjcnDdEcwZMhnHuiwAAAABJRU5ErkJggg==';
  let key;
  if (GM_config.get("ratings_cfg_omdb_apikey") == '') {
    const keys = ['8c967f70', 'dd37e5a4', '3fdb9c5a'];
    key = keys[Math.floor(Math.random() * keys.length)];
  } else {
    key = GM_config.get("ratings_cfg_omdb_apikey");
  }
  // Preparing button
  let button = $('.CopyInfotoBBcode');
      button.off("click");

  // Pause and let RT ratings to finish and get OMDb response from storage
  if (GM_config.get("ratings_cfg_rotten")) {
    await sleep(1000);
  }
  const omdbLast = await GM.getValue("OMDb_last","{}");
  let x;
  if (omdbLast.match(imdbid)) {
    x = JSON.parse(omdbLast);
    console.log("IMDb Scout Mod (Copy Info to BBCode): Parsing info from storage.");
  } else {
    x = await getInfoFromOMDb(key, imdbid, error_icon, button);
  }

  const y = JSON.stringify(x);
  if (y != undefined) {
    button.find('img').prop("src", ready_icon);
  } else {
    button.find('img').prop("src", error_icon);
    GM.notification("Error: 'undefined'!", "IMDb Scout Mod (Copy Info to BBCode)");
    return;
  }
  // Collecting info
  let collect = document.createElement("textarea");
      collect.innerHTML+="[center][size=6]" +x.Title+ "[/size][/center]\n";
      if (x.Poster != "N/A") {
        const xPoster = x.Poster.replace('300.jpg', '600.jpg');
        collect.innerHTML+="[center][img]" +xPoster+ "[/img][/center]\n";
      }
      collect.innerHTML+="\n";
      if (x.Title != movie_title_orig) {
        collect.innerHTML+="[b]Original Title:[/b] " +movie_title_orig+ "\n";
      }
      collect.innerHTML+="[b]Year:[/b] " +x.Year+ "\n";
      if (x.Runtime != "N/A") {
        collect.innerHTML+="[b]Runtime:[/b] " +x.Runtime+ "\n";
      } else if (onReferencePage) {
          if ($('.ipl-inline-list__item:eq(0)').text().trim().match('min')) {
            collect.innerHTML+="[b]Runtime:[/b] " +$('.ipl-inline-list__item:eq(0)').text().trim()+ "\n";
          } else if ($('.ipl-inline-list__item:eq(1)').text().trim().match('min')) {
            collect.innerHTML+="[b]Runtime:[/b] " +$('.ipl-inline-list__item:eq(1)').text().trim()+ "\n";
          } else {
            collect.innerHTML+="[b]Runtime:[/b] N/A\n";
          }
      } else {
          if ($('.ipc-inline-list__item:eq(0)').text().trim().match('min')) {
            collect.innerHTML+="[b]Runtime:[/b] " +$('.ipc-inline-list__item:eq(0)').text().trim()+ "\n";
          } else if ($('.ipc-inline-list__item:eq(1)').text().trim().match('min')) {
            collect.innerHTML+="[b]Runtime:[/b] " +$('.ipc-inline-list__item:eq(1)').text().trim()+ "\n";
          } else if ($('.ipc-inline-list__item:eq(2)').text().trim().match('min')) {
            collect.innerHTML+="[b]Runtime:[/b] " +$('.ipc-inline-list__item:eq(2)').text().trim()+ "\n";
          } else {
            collect.innerHTML+="[b]Runtime:[/b] N/A\n";
          }
      }
      collect.innerHTML+="[b]Genre:[/b] " +x.Genre+ "\n";
      const xLanguage = x.Language.split(',')[0];
      collect.innerHTML+="[b]Language:[/b] " +xLanguage+ "\n";
      const xCountry = x.Country.split(',')[0];
      collect.innerHTML+="[b]Country:[/b] " +xCountry+ "\n";
      if (x.Awards != "N/A") {
        collect.innerHTML+="[b]Awards:[/b] " +x.Awards+ " ([url=https://www.imdb.com/title/" +x.imdbID+ "/awards]link[/url])\n";
      }
      collect.innerHTML+="[b]IMDb link:[/b] https://www.imdb.com/title/" +x.imdbID+ "\n";
      if (x.imdbRating != "N/A") {
        collect.innerHTML+="[b]IMDb Rating:[/b] " +x.imdbRating+ " from " +x.imdbVotes+ " users\n";
      } else if (onReferencePage) {
          const imdbRating = $('.ipl-rating-star__rating:eq(0)').text().trim().replace(',','.') *1;
          const imdbVotes = $('.ipl-rating-star__total-votes:eq(0)').text().trim().replace('(','').replace(')','');
          if ($.isNumeric(imdbRating)) {
            collect.innerHTML+="[b]IMDb Rating:[/b] " +imdbRating+ " from " +imdbVotes+ " users\n";
          } else {
            collect.innerHTML+="[b]IMDb Rating:[/b] N/A\n";
          }
      } else {
          const imdbRating = $('[class^=AggregateRatingButton__RatingScore]:eq(0)').text().trim().replace(',','.') *1;
          const imdbVotes = $('[class^=AggregateRatingButton__TotalRatingAmount]:eq(0)').text().trim();
          if ($.isNumeric(imdbRating)) {
            collect.innerHTML+="[b]IMDb Rating:[/b] " +imdbRating+ " from " +imdbVotes+ " users\n";
          } else {
            collect.innerHTML+="[b]IMDb Rating:[/b] N/A\n";
          }
      }
      collect.innerHTML+="\n";
      collect.innerHTML+="[b]Plot:[/b] " +x.Plot+ "\n";
      collect.innerHTML+="\n";
      collect.innerHTML+="[b]Directed by:[/b] " +x.Director+ "\n";
      collect.innerHTML+="[b]Screenplay by:[/b] " +x.Writer+ "\n";
      collect.innerHTML+="[b]Starring:[/b] " +x.Actors+ "\n";

  // Finishing button
  button.prop("href", "javascript: void(0)");
  button.click(function() {
    copyInfoToClipboard(collect);
    if($('.CopyInfotoBBcode').length) {
      button.find('img').prop("src", success_icon2);
      button.removeClass('CopyInfotoBBcode').addClass('CopyInfotoBBcode2');
    } else {
      button.find('img').prop("src", success_icon1);
      button.removeClass('CopyInfotoBBcode2').addClass('CopyInfotoBBcode');
    }
  });
}

function copyInfoToClipboard(collect) {
  document.body.insertBefore(collect,document.body.firstChild);
  collect.focus();
  collect.select();
  const x = document.execCommand('copy');
  document.body.removeChild(collect);
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function getInfoFromOMDb(key, imdbid, error_icon, button) {
  return new Promise(resolve => {
    const url = "http://www.omdbapi.com/?i=tt" +imdbid+ "&apikey=" +key+ "&plot=full";
    GM.xmlHttpRequest({
      method: "GET",
      timeout: 10000,
      url:    url,
      onload: function(response) {
        if (String(response.responseText).match("limit reached!")) {
          GM.notification("Limit reached! \nSet OMDb API key in settings (at Ratings). \nGet it at www.omdbapi.com .", "IMDb Scout Mod (Copy Info to BBCode)");
          $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
          button.off("click");
          return;
        }
        let responseJSON;
        if (response.status == 200) {
          responseJSON = JSON.parse(response.responseText);
          if (responseJSON['Response'] == "False") {
            GM.notification("Response: 'False'! \nNo data!?", "IMDb Scout Mod (Copy Info to BBCode)");
            $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
            button.off("click");
            return;
          }
          GM.setValue("OMDb_last", JSON.stringify(responseJSON));
          const returnInfo = responseJSON;
          resolve(returnInfo);
        } else {
          GM.notification("Request not successful! \nStatus code:" +response.status+ ".", "IMDb Scout Mod (Copy Info to BBCode)");
          $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
          button.off("click");
        }
      },
      onerror: function() {
        GM.notification("Request Error.", "IMDb Scout Mod (Copy Info to BBCode)");
        console.log("IMDb Scout Mod (Copy Info to BBCode): Request Error.");
        $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
        button.off("click");
      },
      onabort: function() {
        console.log("IMDb Scout Mod (Copy Info to BBCode): Request is aborted.");
        $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
        button.off("click");
      },
      ontimeout: function() {
        console.log("IMDb Scout Mod (Copy Info to BBCode): Request timed out.");
        $('.CopyInfotoBBcode').find('img').prop("src", error_icon);
        button.off("click");
      }
    });
  });
}


//==============================================================================
//    Special button: Radarr
//==============================================================================

function get_radarr_movies(movie_id) {
  let imdbid = "tt" + movie_id;
  let radarr_url = GM_config.get("radarr_url").replace(/\/$/, "");
  let radarr_apikey = GM_config.get("radarr_apikey");
  const error_icon = "data:image/png;base64,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";
  GM.xmlHttpRequest({
    method: "GET",
    url: radarr_url + "/api/movie",
    headers: {
      "X-Api-Key": radarr_apikey,
      "Accept": "text/json"
    },
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        try {
          responseJSON = JSON.parse(response.responseText);
          if (responseJSON.error == "Unauthorized") {
            throw "creds";
          }
          GM.setValue("IMDb_Scout_Mod_Radarr_movies", JSON.stringify(responseJSON));
          console.log("IMDb Scout Mod (Radarr): Sync movies complete!");
          buttonBuilder(imdbid, radarr_url, radarr_apikey);
        }
        catch (e) {
          $('a[href="https://radarr.video"]').find('img').prop("src", error_icon);
          if (e instanceof SyntaxError) {
            errorNotificationHandler(e, true, "No JSON in response. \nPlease check your Radarr URL.");
          } else if (e == "creds") {
            errorNotificationHandler(e, true, "Invalid Radarr API Key.");
          } else {
            errorNotificationHandler(e, false);
          }
        }
      }
    },
    onerror: function() {
      $('a[href="https://radarr.video"]').find('img').prop("src", error_icon);
      console.log("IMDb Scout Mod (Radarr): Request Error. Check that Radarr is running or your Radarr URL.");
    },
    onabort: function() {
      $('a[href="https://radarr.video"]').find('img').prop("src", error_icon);
      console.log("IMDb Scout Mod (Radarr): Request is aborted.");
    }
  });
}

async function buttonBuilder(imdbid, radarr_url, radarr_apikey) {
  let exists = await check_exists(imdbid);
  const exists_icon = "data:image/png;base64,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";
  let button = $('a[href="https://radarr.video"]');
      button.prop("href", "javascript: void(0)");
      button.removeAttr("target");
  if (exists) {
    button.find('img').prop("src", exists_icon);
    button.click(function() {
      GM.openInTab(radarr_url + "/movie/" + exists[0].titleSlug);
    });
  } else {
    button.click(function() {
      new_movie_lookup(imdbid, radarr_url, radarr_apikey, exists_icon);
    });
  }
}

async function check_exists(imdbid) {
  let movieliststr = await GM.getValue("IMDb_Scout_Mod_Radarr_movies", "{}");
  let movie_list = JSON.parse(movieliststr);
  let filter = null;
  try {
    filter = movie_list.filter(movie => movie.imdbId == imdbid);
  }
  catch (e) {
    if (e instanceof TypeError) {
      return false;
    } else {
      errorNotificationHandler(e, false);
      return false;
    }
  }
  if (!filter.length) {
    return false;
  } else {
    return filter;
  }
}

function new_movie_lookup(imdbid, radarr_url, radarr_apikey, exists_icon) {
  GM.xmlHttpRequest({
    method: "GET",
    url: radarr_url + "/api/movie/lookup/imdb?imdbId=" + imdbid,
    headers: {
      "X-Api-Key": radarr_apikey,
      "Accept": "text/json"
    },
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        if (!response.responseText) {
          GM.notification("No results found.", "IMDb Scout Mod (Radarr)");
          return;
        }
        responseJSON = JSON.parse(response.responseText);
        add_movie(responseJSON, imdbid, radarr_url, radarr_apikey, exists_icon);
      }
    }
  });
}

function add_movie(movie, imdbid, radarr_url, radarr_apikey, exists_icon) {
  movie.RootFolderPath = GM_config.get("radarr_rootfolderpath");
  movie.monitored = GM_config.get("radarr_monitored");
  movie.minimumAvailability = GM_config.get("radarr_minimumavailability");
  if (GM_config.get("radarr_searchformovie")) {
    movie.addOptions = {searchForMovie: true};
  }
  const qProID = GM_config.get("radarr_profileid");
  if (qProID == "Any") {
    movie.ProfileId = 1;
  } else if (qProID == "HD - 720p/1080p") {
    movie.ProfileId = 6;
  } else if (qProID == "HD-1080p") {
    movie.ProfileId = 4;
  } else if (qProID == "HD-720p") {
    movie.ProfileId = 3;
  } else if (qProID == "SD") {
    movie.ProfileId = 2;
  } else if (qProID == "Ultra-HD") {
    movie.ProfileId = 5;
  } else if (qProID == "Custom") {
    movie.ProfileId = parseInt(GM_config.get("radarr_customprofileid"));
  }
  GM.xmlHttpRequest({
    method: "POST",
    url: radarr_url + "/api/movie",
    headers: {
      "X-Api-Key": radarr_apikey,
      "Accept": "text/json",
      "Content-Type": "application/json"
    },
    data: JSON.stringify(movie),
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        responseJSON = JSON.parse(response.responseText);
        try {
          if (!responseJSON.title && responseJSON[Object.keys(responseJSON)[0]].errorMessage == "This movie has already been added") {
            throw "exists";
          }
          let button = $('img[title="Radarr"]');
              button.prop("src", exists_icon);
              button.parent().off("click");
          button.click(function() {
            GM.openInTab(radarr_url + "/movie/" + responseJSON.titleSlug);
          });
          GM.notification('"' + responseJSON.title + '"' + " \nSuccessfully sent to Radarr.", "IMDb Scout Mod (Radarr)");
        }
        catch (e) {
          if (e == "exists") {
            errorNotificationHandler(e, true, "Movie already exists in Radarr.", "IMDb Scout Mod (Radarr)");
          } else {
            errorNotificationHandler(e, false);
          }
        }
      }
    }
  });
}

function errorNotificationHandler(error, expected, errormsg) {
  let prestring = "IMDb Scout Mod (Radarr): ";
  if (expected) {
    GM.notification("Error: " + errormsg, "IMDb Scout Mod (Radarr)");
  } else {
    GM.notification("Unexpected Radarr Error, please report it. \nActual Error: " + error, "IMDb Scout Mod (Radarr)");
  }
}

//==============================================================================
//    Special button: Sonarr
//==============================================================================

async function get_sonarr_tvseries(movie_id) {
  const error_icon = "data:image/png;base64,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";
  var tvdbid = await getTVDbID(movie_id);
  if (tvdbid == "0") {
    $('a[href="https://sonarr.tv"]').find('img').prop("src", error_icon);
    console.log("IMDb Scout Mod (Sonarr): TVDb ID not found.");
    return;
  } else if (tvdbid == undefined) {
    $('a[href="https://sonarr.tv"]').find('img').prop("src", error_icon);
    console.log("IMDb Scout Mod (Sonarr): Error converting IMDbID to TVDbID (undefined).");
    return;
  }
  let sonarr_url = GM_config.get("sonarr_url").replace(/\/$/, "");
  let sonarr_apikey = GM_config.get("sonarr_apikey");
  GM.xmlHttpRequest({
    method: "GET",
    url: sonarr_url + "/api/series",
    headers: {
      "X-Api-Key": sonarr_apikey,
      "Accept": "text/json"
    },
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        try {
          responseJSON = JSON.parse(response.responseText);
          if (responseJSON.error == "Unauthorized") {
            throw "creds";
          }
          GM.setValue("IMDb_Scout_Mod_Sonarr_series", JSON.stringify(responseJSON));
          console.log("IMDb Scout Mod (Sonarr): Sync series complete!");
          sonarrButtonBuilder(tvdbid, sonarr_url, sonarr_apikey);
        }
        catch (e) {
          $('a[href="https://sonarr.tv"]').find('img').prop("src", error_icon);
          if (e instanceof SyntaxError) {
            sonarrErrorNotificationHandler(e, true, "No JSON in response. \nPlease check your Sonarr URL.");
          } else if (e == "creds") {
            sonarrErrorNotificationHandler(e, true, "Invalid Sonarr API Key.");
          } else {
            sonarrErrorNotificationHandler(e, false);
          }
        }
      }
    },
    onerror: function() {
      $('a[href="https://sonarr.tv"]').find('img').prop("src", error_icon);
      console.log("IMDb Scout Mod (Sonarr): Request Error. Check that Sonarr is running or your Sonarr URL.");
    },
    onabort: function() {
      $('a[href="https://sonarr.tv"]').find('img').prop("src", error_icon);
      console.log("IMDb Scout Mod (Sonarr): Request is aborted.");
    }
  });
}

async function sonarrButtonBuilder(tvdbid, sonarr_url, sonarr_apikey) {
  let exists = await sonarrCheck_exists(tvdbid);
  const exists_icon = "data:image/png;base64,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";
  let button = $('a[href="https://sonarr.tv"]');
      button.prop("href", "javascript: void(0)");
      button.removeAttr("target");
  if (exists) {
    button.find('img').prop("src", exists_icon);
    button.click(function() {
      GM.openInTab(sonarr_url + "/series/" + exists[0].titleSlug);
    });
  } else {
    button.click(function() {
      new_tvseries_lookup(tvdbid, sonarr_url, sonarr_apikey, exists_icon);
    });
  }
}

async function sonarrCheck_exists (tvdbid) {
  let seriesliststr = await GM.getValue("IMDb_Scout_Mod_Sonarr_series", "{}");
  let series_list = JSON.parse(seriesliststr);
  let filter = null;
  try {
    filter = series_list.filter(series => series.tvdbId == tvdbid);
  }
  catch (e) {
    if (e instanceof TypeError) {
      return false;
    } else {
      sonarrErrorNotificationHandler(e, false);
      return false;
    }
  }
  if (!filter.length) {
    return false;
  } else {
    return filter;
  }
}

function new_tvseries_lookup(tvdbid, sonarr_url, sonarr_apikey, exists_icon) {
  GM.xmlHttpRequest({
    method: "GET",
    url: sonarr_url + "/api/series/lookup?term=tvdb:" + tvdbid,
    headers: {
      "X-Api-Key": sonarr_apikey,
      "Accept": "text/json"
    },
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        if (!response.responseText) {
          GM.notification("No results found.", "IMDb Scout Mod (Sonarr)");
          return;
        }
        responseJSON = JSON.parse(response.responseText);
        add_tvseries(responseJSON[0], tvdbid, sonarr_url, sonarr_apikey, exists_icon);
      }
    }
  });
}

function add_tvseries(tvseries, tvdbid, sonarr_url, sonarr_apikey, exists_icon) {
  tvseries.rootFolderPath = GM_config.get("sonarr_rootfolderpath");
  tvseries.seasonFolder = GM_config.get("sonarr_seasonfolder");
  tvseries.seriesType = GM_config.get("sonarr_seriestype");
  tvseries.languageProfileId = GM_config.get("sonarr_languageprofileid");
  if (GM_config.get("sonarr_searchformissing")) {
    tvseries.addOptions = {searchForMissingEpisodes: true};
  }
  if (GM_config.get("sonarr_searchforcutoff")) {
    tvseries.addOptions = {searchForCutoffUnmetEpisodes: true};
  }
  if (GM_config.get("sonarr_ignoreEpisodesWithFiles")) {
    tvseries.addOptions = {ignoreEpisodesWithFiles: true};
  }
  if (GM_config.get("sonarr_ignoreEpisodesWithoutFiles")) {
    tvseries.addOptions = {ignoreEpisodesWithoutFiles: true};
  }
  const uSceneNr = GM_config.get("sonarr_usescenenumbering");
  if (uSceneNr == "Yes") {
    tvseries.useSceneNumbering = true;
  } else if (uSceneNr == "No") {
    tvseries.useSceneNumbering = false;
  }
  const qProID = GM_config.get("sonarr_profileid");
  if (qProID == "Any") {
    tvseries.ProfileId = 1;
  } else if (qProID == "HD - 720p/1080p") {
    tvseries.ProfileId = 6;
  } else if (qProID == "HD-1080p") {
    tvseries.ProfileId = 4;
  } else if (qProID == "HD-720p") {
    tvseries.ProfileId = 3;
  } else if (qProID == "SD") {
    tvseries.ProfileId = 2;
  } else if (qProID == "Ultra-HD") {
    tvseries.ProfileId = 5;
  } else if (qProID == "Custom") {
    tvseries.ProfileId = parseInt(GM_config.get("sonarr_customprofileid"));
  }
  const sonMon = GM_config.get("sonarr_monitored");
  if (sonMon == "All Episodes") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'all'};
  } else if (sonMon == "Future Episodes") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'future'};
  } else if (sonMon == "Missing Episodes") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'missing'};
  } else if (sonMon == "Existing Episodes") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'existing'};
  } else if (sonMon == "Pilot Episode") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'pilot'};
  } else if (sonMon == "Only First Season") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'firstSeason'};
  } else if (sonMon == "Only Latest Season") {
    tvseries.monitored  = true;
    tvseries.addOptions = {monitor: 'latestSeason'};
  } else if (sonMon == "None") {
    tvseries.monitored  = false;
    tvseries.addOptions = {monitor: 'none'};
  }
  GM.xmlHttpRequest({
    method: "POST",
    url: sonarr_url + "/api/series",
    headers: {
      "X-Api-Key": sonarr_apikey,
      "Accept": "text/json",
      "Content-Type": "application/json"
    },
    data: JSON.stringify(tvseries),
    onload: function(response) {
      let responseJSON = null;
      if (!response.responseJSON) {
        responseJSON = JSON.parse(response.responseText);
        try {
          if (!responseJSON.title && responseJSON[Object.keys(responseJSON)[0]].errorMessage == "This series has already been added") {
            throw "exists";
          }
          let button = $('img[title="Sonarr"]');
              button.prop("src", exists_icon);
              button.parent().off("click");
          button.click(function() {
            GM.openInTab(sonarr_url + "/series/" + responseJSON.titleSlug);
          });
          GM.notification('"' + responseJSON.title + '"' + " \nSuccessfully sent to Sonarr.", "IMDb Scout Mod (Sonarr)");
        }
        catch (e) {
          if (e == "exists") {
            sonarrErrorNotificationHandler(e, true, "Series already exists in Sonarr.", "IMDb Scout Mod (Sonarr)");
          } else {
            sonarrErrorNotificationHandler(e, false);
          }
        }
      }
    }
  });
}

function sonarrErrorNotificationHandler(error, expected, errormsg) {
  let prestring = "IMDb Scout Mod (Sonarr): ";
  if (expected) {
    GM.notification("Error: " + errormsg, "IMDb Scout Mod (Sonarr)");
  } else {
    GM.notification("Unexpected Sonarr Error, please report it. \nActual Error: " + error, "IMDb Scout Mod (Sonarr)");
  }
}

//==============================================================================
//    Special button: Trakt-Watchlist
//==============================================================================

async function start_trakt(movie_id, movie_title) {
  const imdbid = "tt" + movie_id;
  const title = movie_title.trim();
  let button = $('a[href="https://trakt.tv/oauth/authorize?client_id=325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2&redirect_uri=https://www.imdb.com/title/tt0052077/reference&response_type=code"]');
  const access_token = await GM.getValue("IMDb_Scout_Mod_Trakt_access_token", "none");

  if (access_token == 'none') {
    button.click(function() {
      button.remove();
    });
    GM.notification("Trakt's access token not found. \nPress icon to authorize with Trakt. \nRefresh page after authorization is completed.", "IMDb Scout Mod (Trakt-Watchlist)");
    return;
  }
  const created_at = await GM.getValue("IMDb_Scout_Mod_Trakt_created_at", 9999999999);
  const current_time = Math.round(new Date().getTime() / 1000);
  if (current_time - created_at > 5184000) {
    trakt_refresh_token();
    return;
  }
  const exists_icon = "data:image/png;base64,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";
  const missing_icon = "data:image/png;base64,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";
  const error_icon = "data:image/png;base64,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";
  const synctime = await GM.getValue("IMDb_Scout_Mod_Trakt_watchlist_synctime", "none");
  button.prop("href", "javascript: void(0)");
  button.removeAttr("target");

  if (synctime !== 'none') {
    if (current_time - synctime < GM_config.get('trakt_synclimiter')) {
      GM.setValue("IMDb_Scout_Mod_Trakt_watchlist_synctime", current_time);
      const trakt_watchlist = await GM.getValue("IMDb_Scout_Mod_Trakt_watchlist", "none");

      if (Boolean(trakt_watchlist.match(imdbid))) {
        button.find('img').prop("src", exists_icon);
        button.click(function() {
          trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
        });
      } else {
        button.find('img').prop("src", missing_icon);
        button.click(function() {
          trakt_watchlist_add(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
        });
      }
    } else {
      get_trakt_watchlist(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
    }
  } else {
    get_trakt_watchlist(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
  }
}

function get_trakt_watchlist(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon) {
  GM.xmlHttpRequest({
    method: "GET",
    url: "https://api.trakt.tv/sync/watchlist",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + access_token,
      "trakt-api-version": "2",
      'trakt-api-key': '325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2'
    },
    onload: function(response) {
      if (response.status == 200) {
        let responseJSON = JSON.parse(response.responseText);
        const set_synctime = Math.round(new Date().getTime() / 1000);
        const trakt_watchlist = JSON.stringify(responseJSON);

        GM.setValue("IMDb_Scout_Mod_Trakt_watchlist", trakt_watchlist);
        GM.setValue("IMDb_Scout_Mod_Trakt_watchlist_synctime", set_synctime);
        console.log("IMDb Scout Mod (Trakt-Watchlist): Sync watchlist complete!");

        if (Boolean(trakt_watchlist.match(imdbid))) {
          button.find('img').prop("src", exists_icon);
          button.click(function() {
            trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
          });
        } else {
          button.find('img').prop("src", missing_icon);
          button.click(function() {
            trakt_watchlist_add(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
          });
        }
      } else if (response.status == 401) {
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", "none");
        location.reload();
      } else if (response.status > 499) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Server/CF Error or Overloaded.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status > 399) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Sync Error " + response.status + ", please report it.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else {
        button.find('img').prop("src", error_icon);
        button.off("click");
        console.log("IMDb Scout Mod (Trakt Sync status): " + response.status);
        console.log("IMDb Scout Mod (Trakt Sync response): " + response.responseText);
      }
    }
  });
}

function trakt_watchlist_add(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon) {
  const body = {'movies': [{'ids': {'imdb': imdbid}}], 'shows': [{'ids': {'imdb': imdbid}}], 'episodes': [{'ids': {'imdb': imdbid}}]};

  GM.xmlHttpRequest({
    method: "POST",
    url: "https://api.trakt.tv/sync/watchlist",
    data: JSON.stringify(body),
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + access_token,
      "trakt-api-version": "2",
      'trakt-api-key': '325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2'
    },
    onload: function(response) {
      if (response.status == 201) {
        const responseJSON   = JSON.parse(response.responseText);
        const resultAdded    = JSON.stringify(responseJSON["added"]);
        const resultExisting = JSON.stringify(responseJSON["existing"]);
        const countAdded     = (resultAdded.match(/1/g) || []).length;
        const countExisting  = (resultExisting.match(/1/g) || []).length;

        if (countAdded == 0 && countExisting == 0) {
          button.find('img').prop("src", error_icon);
          button.off("click");
          GM.notification('"' + title + '"' + " \nNot Found on Trakt.", "IMDb Scout Mod (Trakt-Watchlist)");
        } else if (countAdded == 0 && countExisting !== 0) {
          button.find('img').prop("src", exists_icon);
          button.off("click");
          button.click(function() {
            trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
          });
          GM.notification('"' + title + '"' + " \nAlready exists in Trakt's watchlist!", "IMDb Scout Mod (Trakt-Watchlist)");
        } else if (countAdded > 1) {
          button.find('img').prop("src", exists_icon);
          button.off("click");
          button.click(function() {
            trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
          });
          GM.notification('"' + title + '"' + " \nAdded to Trakt's watchlist. \nDetected incorrect data on Trakt!", "IMDb Scout Mod (Trakt-Watchlist)");
        } else {
          button.find('img').prop("src", exists_icon);
          button.off("click");
          button.click(function() {
            trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
          });
          GM.notification('"' + title + '"' + " \nAdded to Trakt's watchlist.", "IMDb Scout Mod (Trakt-Watchlist)");
        }
      } else if (response.status == 401) {
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", "none");
        location.reload();
      } else if (response.status == 429) {
          button.find('img').prop("src", error_icon);
          button.off("click");
          GM.notification("API rate limit exceeded.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status > 499) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Server/CF Error or Overloaded.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status > 399) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Add Error " + response.status + ", please report it.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else {
        button.find('img').prop("src", error_icon);
        button.off("click");
        console.log("IMDb Scout Mod (Trakt Add status): " + response.status);
        console.log("IMDb Scout Mod (Trakt Add response): " + response.responseText);
      }
    },
    onerror: function() {
      button.find('img').prop("src", error_icon);
      button.off("click");
      console.log("IMDb Scout Mod (Trakt-Watchlist): Add Request Error.");
    },
    onabort: function() {
      button.find('img').prop("src", error_icon);
      button.off("click");
      console.log("IMDb Scout Mod (Trakt-Watchlist): Add Request is aborted.");
    }
  });
}

function trakt_watchlist_remove(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon) {
  const body = {'movies': [{'ids': {'imdb': imdbid}}], 'shows': [{'ids': {'imdb': imdbid}}], 'episodes': [{'ids': {'imdb': imdbid}}]};
  GM.xmlHttpRequest({
    method: "POST",
    url: "https://api.trakt.tv/sync/watchlist/remove",
    data: JSON.stringify(body),
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + access_token,
      "trakt-api-version": "2",
      'trakt-api-key': '325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2'
    },
    onload: function(response) {
      if (response.status == 200) {
        button.find('img').prop("src", missing_icon);
        button.off("click");
        button.click(function() {
          trakt_watchlist_add(imdbid, title, access_token, button, error_icon, missing_icon, exists_icon);
        });
        GM.notification('"' + title + '"' + " \nRemoved from Trakt's watchlist.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status == 401) {
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", "none");
        location.reload();
      } else if (response.status == 429) {
          button.find('img').prop("src", error_icon);
          button.off("click");
          GM.notification("API rate limit exceeded.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status > 499) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Server/CF Error or Overloaded.", "IMDb Scout Mod (Trakt-Watchlist)");
      } else if (response.status > 399) {
        button.find('img').prop("src", error_icon);
        button.off("click");
        GM.notification("Remove Error " + response.status + ", please report it.", "IMDb Scout Mod (Trakt-Watchlist)");

      } else {
        button.find('img').prop("src", error_icon);
        button.off("click");
        console.log("IMDb Scout Mod (Trakt Remove status): " + response.status);
        console.log("IMDb Scout Mod (Trakt Remove response): " + response.responseText);
      }
    },
    onerror: function() {
      button.find('img').prop("src", error_icon);
      button.off("click");
      console.log("IMDb Scout Mod (Trakt-Watchlist): Remove Request Error.");
    },
    onabort: function() {
      button.find('img').prop("src", error_icon);
      button.off("click");
      console.log("IMDb Scout Mod (Trakt-Watchlist): Remove Request is aborted.");
    }
  });
}

function traktCatchToken() {
  const code = location.href.replace('https://www.imdb.com/title/tt0052077/reference?code=','');
  var body = {
    'code': code,
    'client_id': '325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2',
    'client_secret': 'ee4204782a908e201ae22da35fbd19f08362e99ba158b04f1931caf8eea55fe4',
    'redirect_uri': 'https://www.imdb.com/title/tt0052077/reference',
    'grant_type': 'authorization_code'
  };
  GM.xmlHttpRequest({
    method: "POST",
    url: "https://api.trakt.tv/oauth/token",
    data: JSON.stringify(body),
    headers: {
      "Content-Type": "application/json"
    },
    onload: function(response) {
      if (response.status == 200) {
        let responseJSON = JSON.parse(response.responseText);
        const access_token  = responseJSON.access_token;
        const refresh_token = responseJSON.refresh_token;
        const created_at    = responseJSON.created_at;
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", access_token);
        GM.setValue("IMDb_Scout_Mod_Trakt_refresh_token", refresh_token);
        GM.setValue("IMDb_Scout_Mod_Trakt_created_at", created_at);
        window.close();
      } else {
        console.log("IMDb Scout Mod (Trakt Get Token status): " + response.status);
        console.log("IMDb Scout Mod (Trakt Get Token response): " + response.responseText);
      }
    }
  });
}

async function trakt_refresh_token() {
  const refresh_token = await GM.getValue("IMDb_Scout_Mod_Trakt_refresh_token", "none");
  var body = {
    'refresh_token': refresh_token,
    'client_id': '325c09f8f8d6e3466c7ced12c11cc32d4af00e1af1f6310da4f6dfb702c7b8c2',
    'client_secret': 'ee4204782a908e201ae22da35fbd19f08362e99ba158b04f1931caf8eea55fe4',
    'redirect_uri': 'https://www.imdb.com/title/tt0052077/reference',
    'grant_type': 'refresh_token'
  };
  GM.xmlHttpRequest({
    method: "POST",
    url: "https://api.trakt.tv/oauth/token",
    data: JSON.stringify(body),
    headers: {
      "Content-Type": "application/json"
    },
    onload: function(response) {
      if (response.status == 200) {
        let responseJSON = JSON.parse(response.responseText);
        const access_token  = responseJSON.access_token;
        const refresh_token = responseJSON.refresh_token;
        const created_at    = responseJSON.created_at;
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", access_token);
        GM.setValue("IMDb_Scout_Mod_Trakt_refresh_token", refresh_token);
        GM.setValue("IMDb_Scout_Mod_Trakt_created_at", created_at);
        GM.notification("Trakt's access token is refreshed. \nNext refresh after 2 months.", "IMDb Scout Mod (Trakt-Watchlist)");
        location.reload();
      } else {
        GM.setValue("IMDb_Scout_Mod_Trakt_access_token", "none");
        console.log("IMDb Scout Mod (Trakt Refresh Token status): " + response.status);
        console.log("IMDb Scout Mod (Trakt Refresh Token response): " + response.responseText);
      }
    }
  });
}

//==============================================================================
//    External ratings
//==============================================================================
//=========================  hide ==================================

function externalRatings(imdbid, title, title_orig) {
  const imdb_icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACABAMAAAAxEHz4AAAAGFBMVEUAAADmuR4AAADovi7xwiA0Kge0kBh1Xg/if3xnAAAAAXRSTlMAQObYZgAAAb5JREFUaN7t2s2OgjAQB3CSfYJxq3ebQK9u9gmaIJwlImeJumcJ6usvneI28lGQmmxM5p84trT9pQmHkoDnfXw7ZOV53hc45LPaADhlpTbgtAUCCCCAAAIIIIAAAt4XYGEY2oE4Van/0p1kF906QKpzO7H7tKwLWHMViDlGSJbo1iHi92QM9LjfC/gGgDbAd3I04EvgDQA74wGIuoDtaICzTiCQo4FD3AWI6cC1wPHxQNkAynrleGDdAKJHIAylHdjObQCTP7e9tAKbmQ2IiqqcpQ1Y5l0Ar4EcK7MBQS9gsnUFAmkBRMF5MgCIXiDVQNoLZMkg4FdTLr0Am9mBrPrZAB/WQwDmOBnYaSD/P2DDsTObDiSOwBYB4QAULwECByB/CbB0AHDpxuE2zpFxALBTtgF/LBC3gdgROB+fAiJcagCMOdo4m08ERA1ciwEAVGXdgElgAZKq3QEsIX7o9QJMAbINlA9AaQEKzkUbEFKPi0JPfhLw/x7zgiipauNwXZxUAFTdwwKLuYKtUEI9zhaX9No43lmoAqCqBIbFXMGWihkP3+1pnQACCCCAAAIIIICApwDnV+fOL++dPx/4BflDKTOe3dGdAAAAAElFTkSuQmCC";
  const rott_rotten = "data:image/png;base64,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";
  const rott_certified = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAACkVBMVEUAAAD+1CsCAgYpXSvkMzT+///+7S/90Cz/8jD//jP/+DL/4C3/2Cxnkzb/2yv5uy/1+/7lOjbzkTIOEQz7lDNDQBRQShVXgzT3tDAbGw1FdzIkJA/6wS7pNDQcOCBeWBgMHBPzeUTbMjMjTScxLRAeQiPwNDUSFR1ejTa3Kizu9vzl8fv8yC1Usu7vaz9pYhoTKxkULTxrtegbHB/9zS3S6Pn2ikzmRTbb7Pn/5C86NhOoKSvEJSX36TDELS/F4fa12PQlIyOVyO6YjyOQhiDNLzGolyOn0fDi1i6Bv+nVMDGtaDA2KR3jKzSonyXz5DB8cxzVgDDZzi26sbFVPCJxnDf3rTC7sShJTEkpLC/XtCF7pzjoxypKIhnvSjj4pjO4pSU2OznsLjRwSiV0aRz+mjj51i1OFRaEsjnpVTnCtymCVCiRJSeBfR7FeC5RZy7uziwoNBcyExHSxy2XYyw9RDtAWirXuym6ubLu3y++xshWV1fznDFldDDHrSbQpyFHMR4cBwjyXjzfwSo2SSifPTHJvCv9yiKoUjXOwiumHyXZ8P6Fweu7u7xdYGF7HR+ckl/qjjH62S6lMi7f0i1wbxuKhYZ0b3Po3C+Keh6h1vzb5uiXaWaNQja5My7khjLVIydnGBvl+P/09PRTjbK3Py340izO2NvIzc2ImKHyQDiXojPjKSiqvcaktL6jnZ6srzFDUS7y0y254fzU3+J5hjS5uDLHUDKPFxmaz/ZzwvVwosKej4vs4jEnVXGLU1GNHCWDx/WKpLRjeYaPwDvRQy1nKSFOY3N5LyeMrsRvX2x7gVvmpS6U0fu71ORCmMukqazJICVVo9VuQ0LDwjDbki7JOivQmh+tyt6dxN5xb0zagmZZAAAAAXRSTlMAQObYZgAAGIdJREFUeNrsVs9rE0EYdUawwjc7gc3mx5rAHlxJDoEcksvsLSTsJYukkFZbF5KSZA8W4qrRRaxBiAhehOaWU2659FID+vf5fbv1RxS01SoIvkCTTrt5b9573+xe+Y9/Fs8P9mpnKNUae3ev/EUc1Gped3A4aY/H24jxuN2eDLovG6W/IeOg1OgetrePR73dfKpYLFYqlWIxlcr3RvpyPBl4tcbzK38Oe7WXh+3lqJcv1pmQMQS+APCdbVVSuyN9e9Jt1P6Mhrsl73CsI/kWcQOAAggCxoQ/8xkBV1kl1RstJ93a3h/YfLd9PMpXkAY5A3+/3+pYjukCU1VuhwIF+IEiL7ZSPWP70CtdMv1gbPSKDJ1GQMfkMdIkACxeWOF6YNvVZhSAAlHPj44nXuntJdJvj3YrFDgoGQvIWAVuR36AxJDl9hwDiDihYDUjISRLjfS2V7qk7Lvbxm4d2ZWcthb7wNgqgOu4bxEbAhnukCqX80Uri95UFWOJhEnjErrQ8ND8ihQAs4XNES4qEEwNeXom4+45PAOMqmAG12A9XUwlE2EAMsiPloPfNeFtaXA8SgnBQjeL5FkrTX4joMU5MjHKnmdRwNzm5u2ZVAokxeL0BZP1ntH+PRP2Gm1jl8k4aG63ZuS8uYqN7ydeMLEqcAuYnKU5wq66IvkjiRIyZSy7v2FCqbs08knQC87710D5Nh9CbPw+561YgG9S6lSBziKT5g4wgW6kI5SNvakcGZPa3V/lP9RHlD7x+WmeVdOqyYc0B8Sbxo+MxVvvKKpA2lcQ9jEX1eK4RIPhg2A9Y9xo/FL7axPjaEvKwA3IAounHY7ILMIz58nlZPwWiipAsyAAsIEmN0PBxLpgTpWQeWP58hdiOGhg+4WAdYY3IYmVWy0Lf5pNEEicLVRjL1bTfiTPgiCQGbyp4neKScqioXdLF68fDr8U6j52fCbo9MWTRyk1zZALPq6EAaVMBaXeB767LxkBsB3OmWSbrlayohuD0sX581JCi/YAAvlUB2sIyOZmhtMVEtHi+v7rgCUQJIMwR4lTCqLAzVmY5ekmyPoRKrg4P9DlrlJ9J5Jx1haFDrTjBOJ17sYdyTYAU/w/CsBCA3xFW8iGcutiCg6S/fdNNFvNO8nEQwZ7LjbIxKn2nQAW9DORjMfSjOVHjr1mok4pnL//Y8yfQRPThlWGF9BREOBa/dUmlzjJvfPFpqikF1TKdNTEcQxgRbJFRT9/E0tt7D+5WUU3HW6FIOedfUEpf4N7T7si/BAxwlby+lKEpoLI4fa+FKQKivqx1zjn+WMcnblpx4Mk6Iss2KCe0aD7mlc9Le+E7DsEmFt1DXJtJXcMcF2VN7YbT851/hp6/czMKI1HvwQ3zS1/0/ywefImOC17llZ+LCNffOsBTG1e6IOQkfh061J4ayqdo4DeUk+h3SI4u7DzjA4WEF/TM//xaa68o5U9Zyf3Pgy1k4B9RiIBgiHnw0BS/oAfcSbhyDj8uYISFlCAP7QLfZmcwAXuRMAShILwZqdcLmvaC03zvMw7TfuwU55tsMeAPl45E0yus0hf5fa6rusvGz/jH4x09M/kyczRccKH88/ti04+vD49KWuI3KsHO5rz6NGrnFbWcq+/VORLDOsqdyXMHM4L0bUqzwLWoPb2JwEc60WYmTzbcQG9o224X9kvohc3cuXc05ym7Tx4lXvgIRz8LXfy4Q25882Ywn6ymYwPbO7wZhzCzydQZvhCAT1YWVPBQtgYcnb7xdOnDx+gA1dv3nroOO/K5dyNnEaZ3Dt9HHyjQUiXbmLz5CnFnuNp4P3oEekjI+b+00QQxPH0LLkfqLWtCqhcTNUcnBBMpIhKg2CCBuolIkqsYpHT+AhGDcFo8IFoGhsqaGzSRvoQUCxgoUYwoJIQMcbgKxCNj//Gmb3bctcD4vcX54adnc/tzs5tLcYTAM10N0l6mdw+NNUHp/74kZVHjqxcmb9+fXb2+hWb14OtCCiOvExrTAhwepeJnAvYVXP98ieh+KItx5R5EEJIcBZsm+Z1Dp3Lz74Jyodkck54eVD2zUuXLsHekHX4iSVDhbeT3a/IUcjCWwJrW3O4cpkKXGNjsQFmEQAgWWg/rCnz0ItW369NRlHcFGuGvCqdjvVWVZULgWhzM+A9/mpSIcAZXPsoM/MRtlVYz5w1F/OWXoBaWAAW73/7dhlYuHBDEbNEgJVbO1AjSbwRxUtemYByvJ6QOI7neUkSN4mieL7RbGIV4UKuPblvN3YCE2vAJSheKj9ZANaEF9zHZzLPILqBJTKzT6yixBlTkqIksfcURbAaVRLFOzmZGIoyPc9iUOtumfEpx7bkEuRBBSA4fgaZLVnQSxtMyks0lopGjSQrZr0pSYKC0CoZNQhGu8NMCc483rB6w7YG8mxwLFkFbvIRYAnBanL/hCVDmR1FoqhODjK2YtV7JdiN8lP5uiVAhNLGTAPdv+d3L2eaFBw8CEv2ALridx9vPH3SpOSvV78+x1s/TrhaX2MBRCVSEGIUCSakdALRDrWrSGXlQi9Y7JfCdWyCdBi5eCkwNs3rDzTfzM5HZW8M0JSSFwh88JSOcL7QxOpkwHa4VAnqR5vt2t2vKY8FvNFoNCCIvKok8wmAnsChJzDk2GqLl/gMGvT5n2jzWzkrr0iT6fRKlx4ACyHXrJsT+vHtpuV3YGHnFt7fqlFaIr4qXwbQE+ToCeD3Yp5+B+A7TFJqWv8dkUNZFxWnktRKAKAboThOLliQyNUDgXpm1R7oz0DDMY0m5o3OBZWXV9Vww6WlmNyZJskHNcAn5gUhEAiUCc7eBM/JsfPO3w2Q33GVTupgcQ9056ASbmIG9uE1jeqCk1N1ak1FvDWe0tJhb7JOo2TZpgE+URZJtsXD4fD4YN3UdKBGoLEP7zkMx6aUOaeOYS86lb4EV27bbIXsvYcZWrVNxtM845FfnlKPt0DrLQjwxt7pQbUrHHXS56kG1tDeRqdsNxjI9VR/CB0OHUDXJE6iVfCXx+MNp2EF+N6IReMKxwSaM1JrZtu76JQAUK8vgjz8z4D/A7BM6wHCAT59UYYmy1MAvfUmNQC7Cn6kLNYFVABPZdWlAILuIP1b8uP5FIBFHhcP9E5RTzIUxH270iksAJw3HVMDYBVe0V8F1CtwtLgSdaCTAnQzDJ1vcOBOCiAojysWnNdoAgYUyhhv4VUAok0N4MAqdGsBoA2tUgDIVroZog5hUPGEznYkFTM+cMcXpm5GVpWTDgw3MR0M0x3skwEsBCDB/UZACwXQfQ6OwiHIRQALUcbWHw9QfQ9gEtkT+RgdV8yuCQBQ7GCl2+2u7OurcXZlKLGWuek+QBD4VGxyOhKJDNLodtbB6nphE9wFch0IIKt/ujwGsg7jJERtc2GaITRR5EMY1FaQJQldZz4IHoowGFndwSEAdVBRAN05dMMpLHQU3nu4VdF4PB4fnxOGY22YA7NkKEbGaEcRAJAnxZPs5bialngG2HRw/LOTFyBWJwQodDSmX00rKUCBIjJNFwEo0MjSxpywF/niW1UuADByHW4gWPBZgr0CjdXEjyJAve1i8eIA/p0L6h8FgJF++aEA/0WFm3x2u++7n7r7+wkAf4HJC45bCmhwgX/aOVJAB4H8dFIE0HWi4mYFoESRH9Q/InhiI37ZMUINf5sLAUoU9xDocw1+/VoYJq+7zZ+aYaqThNBBSoR/GYBCANijaGQUFIx5YqMl5Nl/nekGC1USLLL7/si2v5sBtVhhC4ShAx1gf8BRZNjc5EiJatBMieyebXfoAHALFIAKWWNu0gWsntjsGHHs+cQwwT3y3/66dvj+VlA3jkskjHx07M+Ps4DwnU4xMzlKYwnAmOJeHqBnvywKMDAre3pCvhZ3BVpo2133ZbNi5gMqGBISobGK/UPTTR9wEGos2JmKdQrlnTMVSgQCNAKA7hjmAsCXvYp+dJaVlQVKPQPv3pDnbyF77bpZ2X4zVOSqRgPtHqLqMicO7Pn2pkf2g320MxWb4Hj8Owl4BwB4DPWNaBUCvK0mehvleX54GAHeE8f7kH3HqWeyff+dy7X9fjUV8Qje6vsafXvW4qSxnxNGzvlMeXjWDkt9Y41L34oJwD8+zea1iSAM4zIpcWYRxK67JGzMxnwIgmbXDyykbkGSllBrtoaSqBA/K8FolKYqBD1E0Wp7MIgJ9KBoQS968eIHgtKLWlQQRBH8a3xmM5vGbvC5pLMzmec377wzu5Pt7o52PtqGp9AhADwVVwBw8fM7Ufvw4I/d/+jHwpd3qOzq3bunZGn0qSgAYGD/U1HvBXBvRoEdoTtfdwp1Ab6LCwB4/HmnWziIy736Przy4emP1fLTD4SMjLiNPjsAogCAUGgQNyPPI2FhR2jv9C6hCwLgo3that++fQ23cP7grjUaaRIi79r1wdGuPcjgC9tG3crSlmh09KhbOsYBzp454HkgObEjtH6aCLkAQ0QIAGen3ML5w2SNRps3SK9qw9u2RN1CGQBRt14O4XU7TsinPE/l1/EyPq2oqjpVLpe3uwAlofOIwOXGFNRoNC4fbjTcirKj0W3R4Wa5dsNRbWl4AAenaFmoORCNji+VyyV0ruh461/AI9m9dZ6tMASCvXv3rg/wowWOQg7BuZs3k8mtXCA429E+CBeSyZs3zx0/fvz5c95+i/Ot6Pj4eBR/ugcTCF3h4mg0+iS5Ad3vgI3YBjzrEFUcojAAdQHOnQNBkgMIufbwRyVOCb0nNeHoKuqI++M3pP1JmDvyLgJk4f3Bgqj2AAgCj78HQKiv/cjI9osdAKTAWb4IvFkY2sgVCmxaBQBB7yQI/x6AIQ+Ax3/U8QfA4R3CADl4xfuWAHPQqd+46Z8QfHx2+/btu2+SW2HcsYdwQyyVSwiAB8A7fGG/fUEAIAUeH/D+StzYPBjY2NHQoS7A8QeluKLqhqGrjRUYQ2L8wbGc/BEAyMFN/7UX/gD4hRBzDYoU8JwMTogQnFsFGKpVLCoxxiSab9eSXfutt1Vmyw8+Hh9q4pEYaSdWgbD3RB8aHv7WAQi425D3cCYAkgBwCKBanfr9EgD8lFVLjjv0qFQrsrqqag8uKOmZhW2wH3m7tLwfCP2iD/Gbq4jwCfdg5l2IgQ7AYC9AlvrpyUxmzO+ndvBNsqNP7fd+ztVulueZ8XZgW7Qc1Nt6vDy+Jbo2+tuF/8Kzjd4Z6D8HJwb+BZBUQuLgsLQuQFUCEGXtG6okVScmlmrGe8yTlbkxwmMQdaLQO3xo+WBnBgqDZ6fcc5l3HQQgkYWQC6AQkgLAYvBc8s3Kp5XbN1dkQ5IqKUXLLWKGrDliMNqam7dYuja6sLA9ulCu1ZbHe+0XLiwfDjm9XxfboEf3JrAXBbjcJADBQAkANG0YGYocqN0sKZmXOaP0rKwzKUcIqUt8JvLBOmU6IXlKU0RR4jU1V3kxszS66n8B+uYMr+DuQv3TMOBADvYCiCSk8yq5XapSBv1s1KodgBSqJ3VFRY4WMxmbskmyyGZzaM+y8nB3+LBfvgt/6DpS8Fp/gCMTgwiBoyF3a+9EQJIk6rfHJsqIdD2f9bNZkmEsTdpteZFaQYIZ8PsBhqYZkqVU8lt+6teW4d+xh5oX3QD0nks992QRAjEHWNulFqX54smT6JblyCIfomZRpmYYLeo0q9nU1ghRJFpX4ilFUTQ5SyVDM0AcB8Cq/8o3EQD3l+L+PxdvLvCdInDCMd8yOnwBSciqiHWa+WlLRULqhE94GjmAiRkLWtQm8cl4XrLVuNrKvk8RAChE5QClT58+NZvLHYCDGwuFgicDPK9tLx68fP7870Bo6+nx4WZjJhHTsnAjJplkyPZpLL24Kbco5l+v5GfTsobdoV1kSsriaSKxkwQRoIqpUgAkfLFYIhE+OoHHlqVfAWcTxJvDvmO/d+/akStXFEVvV3PVxsZvlz9NJGI+SGsBQPaZOgCozlPuqjZLWYY4QjQY0tKvkXgua9v5Kq70ArgCx4yiXr74a/PZvm8rpouV+XzW5tmGVJqXp8Ld78IBc+8LqwzSEQeJ2haPQzhCSCQWUebqdl4nKMiaBqKEtihJKVNZBeihCM9MnekbgDGEj8vPRedljL0LkMnljIgvpqUhhRTRkjHLIKJJDEPGKjB9JoFA5AvOZVtxU0E7DQAehfsuwSrzC/Fl3oqstu90HPb5iFC7MlusxuEoFMPYeSkcjGsRThUhskyCsqoqGIdHsXDf5ENkO+On+clqVe8FSESgGAzwYZqwcxT5J7LcSJ5jJyMusVolOhp5hy9rfKk6d4I/1X8AqLVoA0AqigH3EITDZiJmzuiqGcZ45ZQS79e1KgmARNBQMrOVzGRaCa9pZCpFm0KL00fX/SlWc6sAmprSZD4PdFaGX4z3o5md8aXa0+14cMyWpJYqaxmscjqrmN3kjjmfMbkoSWMkjORNyBlqYRdg7KS8FrKT5JQyfd3X4mSlZ/0TyOAALc1papoRY0yegVE4w9BVnlFU0moLn4iThQTH5MhBTdMipi8WVAzswtlisYiKiFGXXlzKY0p1LdgLEJmTaGXS0LG3Fk+tm3yprEkEVYJHXYN9KpNL6wZrz6kRX8IJDOQ4i0+WiyCeY/m65bfzGS2iOlx8fEpYAaz06tZrls1Klh52JtF0lrVW5xs5IZoW5HuB5z8ZFD5IawaRspnEJNjlDWPGdFaIZdk2t7Bn83kLNRXZnJZgxIlYNugCMCkVMRh9/ern1Xz26iWbZSLIXkU3VL5usKnS7Pz8fDHXnljXR3/bt3rWtqEoWq4hSAJPD9nIBkkgGbxZ0M2godgYT7IxBBW8xODBCIoRQgITvBmDl04ptL+hSzOkmzf/sJ77pMQhEoGSDzr0LHH0XnTOve9+Kch9eRPdQSWRCckRYQl7qIKwZxg9jYmJmz5KBbnsimg/VtgfxrcDLu5HwajdcRXtZ+f33a+73XaijmzbmiG1NT/q23Ygk40dNdGrBEjOhr0EY4FJ2GcPyJnMygUISsA1Q2+AB9rIOPzNd0FX2oVqcX52eDT4vV1n6wRUAf1QmRFtwm+Qe8QvADTvK4YydFZQWBSC6R7qRuQCTE8KCO2afZACXKuh60RCh1ETg1WpPRLCjPeKkvy6wwsNP5MLbcCH44dXAWLyaKBh3Ex86d6JW+K/bUt39ghT3hnqt6kU0DEfBOwh4EbId5ijGVcPZWOIMQRwxHUa2L7NxnfbJNvdqYO9xmqJcJCyqwsDmbNE6PSfDoTNU3vGAqaPPcBjjcwC/bEADRknROCrDCUXsGEPeMheAf3Ho7LN/N/rgfbF5+qKsB9pOL/G7JAM26471TBGPZnG5qeVkbCAIQ88jxT0SwIiDadOQ/ZtEgyYYWIYE/YA/UgwpslI+7k9ar4aICAApBBvG7s+YoBXEbcie8yfrk6rlRExRUDuxVkA/MZ9QgrgaIogIGQBfF4ofWT48nmBf2hf3Eg9EAUqDMQeRY1ICpBPdoBiWIr8oCpXIj6tH9u/AoxIxVrEE8W9+YA75KsQ0GA7QhagchpBpTYg0cBPbMIRYLssEDYtQ6uNjEuWlAsY9nq9hg4I6o8Os30w7RN1T2cF1+AH4mWAlr+0ZU3OQ3XmD6iNxsqdVRiIHwONv29ZPctl4s14c5EXD1qqmsxw1E5BgLBcnk5cdpCBT9PBIJgKjwqILQhP2b0DmqvVfL5ak4RpUpAXthuX2mQTQ3CfZ3RqJjGwhwlVZcYutWyywtnNTdTAhppnO04xnYgrHGBP1xs+3DYk9GM0kHi3na9g9OXtOQXrUFCPGYZTIxpoKt+WAMf0AEd2vrz3obKbpi2GY/9iE+ruLApGfdNjlbDdexg85F7P5WiARpzO0UC7ji9hqrR3np/AWcIcYD+goRLpg+gQwt9oItVweAZ0DSrgwDa22Sxt08ewhX31XWfvxEwi6a9Lhah5CcwhAC298PszyGcjAdOFbRejQ9UISKIX7GdJODXIxpbd/JIB+jLytS2MkAOYEPj0LBynRFmloAD4WYDkb36oQsbvxV02zecIORAQAQsgTT+fkaZ8CStYf6LLQbyQEB48KwXUgW6lgFad8VQAc5qL9PP1331nBo85C6h56iPnFgKAyqfD4vWguNjKw+jHT6/xHR2PMyJHJ6szSf22SnM3RwyLPUOQhHi5gI/EELaUYWaSo55VbLztNhndXbvgJhbxcgH5vXK043VXkqyrkgBLOVo7r8jDVxEgCn5v12o+UFQlwf0aK2xlMQGv5QGwZy3E1xkVdWDdOiPbyQ2pWLxcwDXJm3xNd3jr9IEhLW88s2PxbfAZGgrsyovFCmx/S6RZTlMrx6C83Pnw5khr1QKct6QvS6iVCitqH5z/TljUylHo4Mo7ovSfEtC/LxYf/uMfwR+nncxkU7Y7KgAAAABJRU5ErkJggg==";
  const rott_fresh = "data:image/png;base64,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";
  const rott_user_up = "data:image/png;base64,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";
  const rott_user_down = "data:image/png;base64,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";
  const meta_icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACABAMAAAAxEHz4AAAAElBMVEUAAAAzMzP/zDT+/v5oX0elmG641eaPAAAAAXRSTlMAQObYZgAAA3ZJREFUaN69mVFym0AQBVO6ARL8WxQ5gGulAyzGBwDL979K4tjmie2dmVKo8nxZpKbV83YFBH65dej/lv3PYbPqf9tVTw/29yggwq9nPfL1uwi9Xfv6GUTcz4r7owrzD2tHP2KIB3j/qMVQCPtvU/NZ7bSAEA9wy81dCaEhfIHcFDVCwRP43bBeQ0LRj+qCIQ7oB8FXYD8JnsKB+bFGRwH9PuHJFBjQNE3T+ndrKpgBtG8ppeuqdSwUIDCX/emz1uOLC6BASgWhq89gJfiS1spFjk81gQEDqC7KEYBYQENIgQAuYbqvq61wMARO6qYCAVyCtwSF+4XABGdjAihoBn+CLqW6wkiAImQEVGiLGbSLsYiGwlIFNMzQUjhqBq4BM6RCWwOcLcC1oqAQBMgGIG9muW7WgRHwl/SsNO4UjgQMBiDrTykoBC+C9k75VCoQkBvU/Vlgq6AQBCguhB/yawRQ2ISAXaDQBIBCVwIG7GEBoLBNkRl2CQAqlIC5NoBCpMLyDdAiUEDLSIWxAJg/wlxX0DIIwGuBZqBCJ4BWEechKOhguwUMmKCqoGMCYBuk5Cno0BZwRgSGgo4QwEWkwnpAG0H7iBlSQZ8dgKugj+MGAEtLQZ8CwPX1zVLIDuA0fwEu64aAwqVxACl9AbSgUMh1wLff5aSzQAcFFQDrIv0Tn7GrcwRQft8TQCEGpAIAhQBwAgAKNmCWgABQ8AEnABwF/Rb0a3wBAAo+oEuqOVLg+QDXo1ABpzTeBEhBWBVOqhuFeaOgg6oWp3VPQcd0GBcWR4ECvDJlV4ECBIQKMzYiLu+uwtXYiNoIngIEeIMxNJ4CBLSKulF1FSDQCaAUHYVSoDkCMLsKOB8tAAyNo6BihrrTtBVYHQF94yk4ESiERxTGCmB4RKEXADNAIYhAgOwpcAICzoECJzD+8x4rdABoHajgTsAHGFSIJ5BCU1F4NnYRANb9asNa+Binp4IEGKENmKUQCvTmkzApxAJSYAq2gABU6LMU/CXow+eRbVWg7SWAGbAdKwKjBKDAXwT7OwhQYTBOxXikCgUSuAICsHrGwH5MAAUQECAFqEAC+32F/sb85M8BqND/LpZgwjsSS0ESGV8vAVdBFrfpo3l6f+g1T1z7X1TtJOx+WRdV1B9X1B+XG+A+wk+9NiaB+nGh/Wde3hMSN/8BSXUWJsXAq8kAAAAASUVORK5CYII=";
  const meta_badge = "data:image/png;base64,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";
  const lboxd_icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACABAMAAAAxEHz4AAAALVBMVEUAAAAgKDD/gABAvPQA4FT8/v1Dw/0E6ViwYRE5msej6OIFx09I54QLokj/zZqk8vmhAAAAAXRSTlMAQObYZgAAArJJREFUaN7tmT1r21AUhuN/oNctwaZ0sKBQSimYC4KOBYGhydaqg+liBBc8FlQ0FA/O1NUUCpn7sQcKHkK3tHugkMFz/keva8tH55hYco6KnJBnNLyPz8H3y/fu/T/AUGQJr1y6gQ145eIKBUqg+HoqQpHnBpnXGbAFyrxD0QA1IfO6ErAtnq4Ah1rg6TpwiAJ0JeBaqAWsA10PqEkA6qAugVeVANemIkGjRoG3IwIouCWCBhR4d4JqBKhVAC5o+Y7HIGY/0vTgHMRxYO3zyVWCI3/BOPtgmoaO9ABL2oE1xgS2KwSU54ZpEv6j92GZt2YBGfKCpk9gzoXLLw0jzAlMRjDJCah/ogPggcuvDCcA9mOzIhYCaoCamIY55k3EhggGUtDyGZ2sACph3+QJpKDpc1wBjBFiLugKgS/oJFzQu8cFZsgFLSl4Egq+G06QCRrUQZ5LUcFhXwq6THAkBdFXLngZxcIwYAKZfxa95oL30RchGG4UPIrecsGvNUGQF7TWBX0u+Ba92UpwKQS9KOobguaDtxA01wVRUqngUAoc3QLB2c0XJFpByZ9x8zggoisGkld+JL6SgoLJVDgXjHo2FqwHZ3I9MIJBwYoUcnrrP8LmRfVpKPgtBeAC2cM4EYK2XJWL9oULnn+HQHQgBJA700O+HpzT1kibIxPwEgBewghAwBd1KYDYnVkJKRz5vWkIIaDhTKec+0l+d3d8XhksuIAMlHf8yU4oLwBmsBMpIAPlHbM0deWnJ8j4ZK2xNp6AC4iPLj5Gjtnp6U/kaB8bdkhDJefE2s/Kd4IqBLX/8bzZgl25wdAIduQiag+1X8YpBfobTb1Af6vbqP1iWnG3rhGonwf0DxTKErSvPJ72maeKly5NE16Vr32EIq998SSDIl+6DeW78V4ZdHGSyPCu8hfYVeoYJ6xJswAAAABJRU5ErkJggg==";
  const lboxd_cust = "data:image/png;base64,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";
  const douban_icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAgMAAAC+UIlYAAAADFBMVEUAAAABdhD9/v16t4L0Izp4AAAAAXRSTlMAQObYZgAAARhJREFUWMPt2D0OgjAUB/A6eATv4xEcKE0YcOcI3qNHcABjnDhKL8HuYqK1EuA988orUQeI/S8Q8iNtXstHK4SQTITLmgM7BzYcSEgLtI0VD7akC6QTGx4kYSADiQCBvPLmHMHPgbLeXGc1HxYCPLW8A/CPRhnBp8CiND5gJKSIIAIEmrnO6j8Ae/tw19Cje4H3ZJfUATRUNXkVKwTcqfYCA8AAoLcpAqBh6M50gKfhcSjKyQMOr29xm2wCKCmAy0AxwC0XfpAOoOm6S0HFAqifO6kpgBFQDNA90BRArVMHDAVQ63wKkBRAATMKbJubq1R7HKav6UE1Eh3BO7AjMfP6l1s6+HrFGlwUh5fVggfBpX14cyC4vfAEQ6sYUOFLXfsAAAAASUVORK5CYII=";
  const allocine_icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHYAAAB2BAMAAADviXoiAAAAGFBMVEUAAAAmJib/////ywBcUzPIoQmUehKRkZFw3PDCAAAAAXRSTlMAQObYZgAAA2BJREFUWMPdmU1P20AQQKv+AzeOe3WjSD1HG+fuptBz5JS7lY87qBJ/vxCyed6ZHS94b8wBiOTHzL7xLvbw5VPF18Vb1B8mF8OYQhIfqFZHPRUFTqNTYdA0nEaBk+hkOIoQ70Wf2+I1ymcBpyv+VxB/gqpTaX8WYTwlE8uk0dSJih8LHd/HqxaoBY+lXRbx+DWSGE1hlIc+FGanVWjnVtcfzcTGYu+dcxuxZIOVFZ/cSzSizUbJraz3Eq3/HC866njr3qIXru20xOzKrgojMaxq7fzKrmlyhCWtYpFFYp0WybDIQjWJYektrpBFj2Ep+VaYv/Tg2R2/j6KH7A9/K3XejfOxhv0Gq0u+e7mW5SIrUjTsdddQ48HdoiAES3OrDjl3jujlPob1JVfOx/n36fL94dxRyKBoUTIrJI7X/GtVNOz1xigFuvf2NvLArXWHOkegt0MWXQqW69USO+6vVi8YtmXXqa7OAlklLKqELARtDVmokrKo02lZsNzMsZIrPiBLsELWipIpAjbQzHXiPrTuLDQrWTevVKFEozm4ozeDDglZmkUWie57r6AxWY65Q7Dczh19Ja1o0rC9yOLaSm9hGuzZpT6T5S26Etu/lu0l1YYF6PPOYIvhpWJnJNmOEktIZJkssnbUj6xRFj+9Or52abaC3QbsOsGyyFaxzTiLLFgiwdJUfkLWOIsslCMrzVYWu06z5Y0tTwG7gY3tBWTxdEbE9gJ7EFksnmjVIavYGdeFt9YOVp85XB9l16PnFbJ6WCVLn7EE9YVsEz9jH6WsFayQxdlOg4kt9altaP89Amhi7EqyusEVsugvsmgvf7sJGgKLrAVsRPTBJ4ZFFpqlaM67po1vYf2sgiwM/T2fXhd5+YponpFMWTyf8fkoVBmy0BMsAlXmgjuqvN3iD/KJAXYZyvJxM78Xz8Bm0TO5dea9eDKzX1MqsWXtZ37dpZI7WAQdghVFd6gixDuOVfQB1ijZfqebGTU/wZrvklXMFe+S9jssspo+Nqio7XdnZG3aaNrafGdH1t6Yj1izAmQ1RyCRNjGjmDeiXmYU6dmIPQ6yZzJ2MJNJz4KM4VnODCpj9pUzc8ub9eXPGPNnm/kzVWA78mfI+bPr/Jl5/qwe2EKnwnXe/0Sm0Rn/A/pM8R8w2HBWwA4YRgAAAABJRU5ErkJggg==";

  let key;
  if (GM_config.get("ratings_cfg_omdb_apikey") == '') {
    const keys = ['8c967f70', 'dd37e5a4', '3fdb9c5a'];
    key = keys[Math.floor(Math.random() * keys.length)];
  } else {
    key = GM_config.get("ratings_cfg_omdb_apikey");
  }

  if (GM_config.get("ratings_cfg_imdb") || GM_config.get("ratings_cfg_letterboxd") || GM_config.get("ratings_cfg_rotten") || GM_config.get("ratings_cfg_metacritic") || GM_config.get("ratings_cfg_douban") || GM_config.get("ratings_cfg_allocine")) {
    addRatingsElements(imdbid, title, title_orig);
  }

  // Get IMDb ratings.
  if (GM_config.get("ratings_cfg_imdb")) {
    getIMDbRatings(imdbid, imdb_icon);
  }
  // Get Letterboxd ratings.
  if (GM_config.get("ratings_cfg_letterboxd")) {
    getLetterboxdRatings(imdbid, lboxd_icon, lboxd_cust);
  }
  // Get Metacritic's Metascore & RT's Tomatometer. Link for RT Audience score & "Certified" badge.
  // Running for Metascore without RT enabled is currently disabled, GM_config.get("ratings_cfg_metacritic")
  if (GM_config.get("ratings_cfg_rotten")) {
    getRTandMetaRatings_OMDb(key, imdbid, meta_icon, rott_rotten, rott_certified, rott_fresh, rott_user_up, rott_user_down);
  }
  // Get Metacritic's Metascore & "Must-See" Badge. Link for Metacritic's User Score.
  if (GM_config.get("ratings_cfg_metacritic")) {
    getMetacriticRatings_IMDb(imdbid, meta_icon, meta_badge);
  }
  // Get Douban ratings.
  if (GM_config.get("ratings_cfg_douban")) {
    getDoubanRatings(imdbid, douban_icon);
  }
  // Get Allocine ratings.
  if (GM_config.get("ratings_cfg_allocine")) {
    getAllocineRatings(imdbid, allocine_icon);
  }
}

function addRatingsElements(imdbid, title, title_orig) {
  const img_px = GM_config.get("ratings_img_px");
  // Main ratings table element
  const table = $('<table>').attr('id', 'scout_rating_table').attr('style', 'display: flex; justify-content:center; align-items:center; text-align:center;').append(
                  $('<tbody>').append(
                    $('<tr>')
  ));
  const hr = $('<hr />').css({'margin-top':'3px', 'margin-bottom':'3px'});
  // reference
  if ($('.titlereference-header').length) {
    $('#main').children().first().prepend(table);
    $('#scout_rating_table').after(hr);
  // new layout
  } else if ($('[class^=TitleBlock__Container]').length) {
   $('[class^=TitleBlock__Container]').parent().prepend(table);
  } else {
    return;
  }


  // Douban ratings
  if (GM_config.get("ratings_cfg_douban")) {
    const img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAgMAAAC+UIlYAAAADFBMVEUAAABlZWX+/v6np6epfp6hAAAAAXRSTlMAQObYZgAAARhJREFUWMPt2D0OgjAUB/A6eATv4xEcKE0YcOcI3qNHcABjnDhKL8HuYqK1EuA988orUQeI/S8Q8iNtXstHK4SQTITLmgM7BzYcSEgLtI0VD7akC6QTGx4kYSADiQCBvPLmHMHPgbLeXGc1HxYCPLW8A/CPRhnBp8CiND5gJKSIIAIEmrnO6j8Ae/tw19Cje4H3ZJfUATRUNXkVKwTcqfYCA8AAoLcpAqBh6M50gKfhcSjKyQMOr29xm2wCKCmAy0AxwC0XfpAOoOm6S0HFAqifO6kpgBFQDNA90BRArVMHDAVQ63wKkBRAATMKbJubq1R7HKav6UE1Eh3BO7AjMfP6l1s6+HrFGlwUh5fVggfBpX14cyC4vfAEQ6sYUOFLXfsAAAAASUVORK5CYII=";
    const url = "https://search.douban.com/movie/subject_search?search_text=tt" +imdbid;
    const td1 = $('<td>').append(
                  $('<center>').append(
                    $('<a>').addClass('DoubanUserRatingUrl').attr({'href': url, 'title':'Douban', 'target': '_blank'}).css('display','flex').append(
                      $('<img>').addClass('DoubanUserRatingImg').attr('src', img).css({'height':img_px, 'width':img_px})
    )));
    $('#scout_rating_table').find('tr').append(td1);

    const td = $('<td>').attr('style', 'width:30px; vertical-align:middle;');
          td.append($('<span>').addClass('DoubanUserRating scoutRatings').attr('title','Users rating').css('font-weight', 'bold').text("-"));
          td.append('<br>');
    $('#scout_rating_table').find('tr').append(td);
  }

  // Allocine ratings
  if (GM_config.get("ratings_cfg_allocine")) {
    const img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHYAAAB2BAMAAADviXoiAAAAGFBMVEUAAAAzMzPr6+vExMSdnZ1WVlaCgoJubm4HXAuhAAAAAXRSTlMAQObYZgAAA45JREFUWMPdmU1T2zAQhjv8A+OPXNNMoeeMnPgcPJCzG5q7G1LObtLp329JLL/Su5JVrBt7acrwoN13P5CWTx/KbhZXm7+bXJg2mWQ67C3bfCrKcBhleCrKcBhlOIhOhhfj9r/otkneLD8THPb4mMD25PX4sfeJbT9wcAh9TNieAY97vEmkZeNeE+qDx469S9z2beRgyGRbfmhtwfzHMjqr1bL/6D3YE+xeKVVRyB6WPT6rf1ZSmj0udxSqulij/Xc77dR4p67WktbOYxubTXt2OTiCg5nl1GY9WyHJDhbRChZiIWI6FiITC7Eg9ZxZ5Ja1UnAoE6xdUrnW9aTZ/qeiuJj9rEupXvWflLYV2FuwhsstSun6qRjYNdgCThtsX0rw8aAGS2DEIrmzGuI8K1jHfWyzG8vL1+/ny79PP2s4YigtXc4U2bEXYOVwGuyXS7SEPl6HpCVW8qBZylAfLtViDbGQJStcVAOXxM4SKxNsY3Qdt0BqiZWDhVQkFgQ6ecW60T1EYsHPoYXRS2BRzC6XC/wHYjnYg8PlHVqYWd0I+D64jMS13A6WzCzWMGcw7yC0yeIbtVVGhkgsyUIsHLTvtASlk9XVTGK111CP2pOGKnqQ+aucb43RkyTWr4vQmr2TM5lLdEntP0d6WazKCIDFumVWm1kZ1BlBttYu8ihoAizE0uML1oXZFLJmNAmCbIFTdha7CrAIshHsOsBCrEZMLxVkNZFItguzqY/d+FgWC+mCWGE2H9j8hcViVtxwagiT1yZMvYAeJLEQPImFHkTvk1gNWlKI9cAzB5b52JVnXrFYHVghlpyxMO0fsyXPWMx2a94tmUUgBVgk2GzhysW2Y7+PAJQudilZvofOIFZqsZX4HSrfJzohzJbioiOFPuiDwUKs3HVXoXlXdtaExhRjlsW62NPr+a0i/ryAxR2J72YQC7Y1hu2R7mYesSAPgmhIKnfANfVO3juAcMFy+2PaDD19pDuw1+mUW6fo6GYGltuhoJb13/lllnJUMBkyBJacrmnM0Btn9G11IpbfVsze+5+g/KYbfUsWrBW/JeUblsUq8ePoDSvfziTWGl+gt7PnzQ6xtp79SGhXkKryNyDaFQR2FBn85VVUeDfiXwcFdzJscicT3gXJ5VnMDipi9xWzc4vY9cXsGON3m/E71fhdbvwOGXD84jt+4R6/6AcahhmN+5vINDrib0Afyf4CrepxXp43oBkAAAAASUVORK5CYII=";
    const url = "https://www.allocine.fr/rechercher/?q=" +title_orig;
    const td1 = $('<td>').append(
                  $('<center>').append(
                    $('<a>').addClass('AllocineUserRatingUrl').attr({'href': url, 'title':'Allocine', 'target': '_blank'}).css('display','flex').append(
                      $('<img>').addClass('AllocineUserRatingImg').attr('src', img).css({'height':img_px, 'width':img_px})
    )));
    $('#scout_rating_table').find('tr').append(td1);

    const td = $('<td>').attr('style', 'width:30px; vertical-align:middle;');
          td.append($('<span>').addClass('AllocineCritRating scoutRatings').attr('title','Critics').css('font-weight', 'bold').text("-"));
          td.append('<br>');
          td.append($('<span>').addClass('AllocineUserRating scoutRatings').attr('title','Users').css('font-weight', 'bold').text("-"));
          td.append('<br>');
    $('#scout_rating_table').find('tr').append(td);
  }
}

function getIMDbRatings(imdbid, imdb_icon) {
  const url = "https://www.imdb.com/title/tt" +imdbid+ "/ratings";
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      let crit_rating, user_rating, fem_rating;
      if ($(result).find('.ratingTable.Selected .bigcell').length) {
        user_rating = $(result).find('.ratingTable.Selected .bigcell').text().trim().replace(',','.');
        if ($.isNumeric(user_rating)) {
          user_rating = user_rating *10;
        } else {
          user_rating = "-";
        }
        crit_rating = $(result).find('.ratingTable.noLeftBorder .bigcell').text().trim().replace(',','.');
        if ($.isNumeric(crit_rating)) {
          crit_rating = crit_rating *10;
        } else {
          crit_rating = "-";
        }
        if (GM_config.get("ratings_imdb_fem")) {
          fem_rating = $(result).find('.ratingTable:eq(10)').find('.bigcell').text().trim().replace(',','.');
          if ($.isNumeric(fem_rating)) {
            fem_rating = fem_rating *10;
          } else {
            fem_rating = "-";
          }
        } else {
          fem_rating = "-";
        }
      } else {
        return;
      }
      if (crit_rating > 0 || user_rating > 0) {
        $('.IMDbUserRatingImg').attr('src', imdb_icon)
      }
      $('.IMDbCritRating').text(crit_rating);
      $('.IMDbUserRating').text(user_rating);
      $('.IMDbFemRating').text(fem_rating);
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (IMDb Ratings): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (IMDb Ratings): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (IMDb Ratings): Request timed out.");
    }
  });
}

function getMetacriticRatings_IMDb(imdbid, meta_icon, meta_badge) {
  const url = "https://www.imdb.com/title/tt" +imdbid+ "/criticreviews";
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");
      let meta_crit, meta_count, meta_url;
      if ($(result).find('.metascore').length) {
        const x = $(result).find('.metascore span').text().trim();
        if ($.isNumeric(x)) {
          meta_crit = x;
        } else {
          meta_crit = "-";
        }
        if ($(result).find('span[itemprop="ratingCount"]').length) {
          const y = $(result).find('span[itemprop="ratingCount"]').text().trim();
          if ($.isNumeric(y)) {
            meta_count = y;
          } else {
            meta_count = "-";
          }
        } else {
          meta_count = "-";
        }
        if ($(result).find('.see-more .offsite-link').length) {
          meta_url = $(result).find('.see-more .offsite-link').attr("href");
          getMetacritic_User(meta_url);
        }
      } else {
        return;
      }
      $('.MetaCritRatingImg').attr('src', meta_icon);
      if (meta_url.match("metacritic")) {
        $('.MetaCritRatingUrl').attr('href', meta_url);
      }
      $('.MetaCritRating').text(meta_crit);
      if (meta_crit > 80 && meta_count > 14) {
        $('.MetaCritRatingImg').attr('src', meta_badge);
      }
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Metascore from IMDb): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Metascore from IMDb): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Metascore from IMDb): Request timed out.");
    }
  });
}

function getMetacritic_User(url) {
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");
      let meta_user;
      if ($(result).find('a.metascore_anchor span.user').length) {
        const x = $(result).find('a.metascore_anchor span.user').text().trim();
        if ($.isNumeric(x)) {
          meta_user = x *10;
        } else {
          return;
        }
      } else {
        return;
      }
      $('.MetaUserRating').text(meta_user);
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Metacritic user): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Metacritic user): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Metacritic user): Request timed out.");
    }
  });
}

function getLetterboxdRatings(imdbid, lboxd_icon, lboxd_cust) {
  const url = "https://letterboxd.com/imdb/" + imdbid;
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      let user_rating;
      if ($(result).find('meta[content="Average rating"]').length) {
        const x = $(result).find('meta[content="Average rating"]').next().attr('content');
        const y = x.split("out")[0].replace( /^\D+/g, '').trim() * 20;
        const z = Math.round(y);
        user_rating = z;
        $('.LetterboxdUserRatingImg').attr('src', lboxd_icon);
        $('.LetterboxdUserRating').text(user_rating);
        ratingsColor();
      // If there is no score then try to get raw average rating with another func.
      } else if ($(result).find('meta[property="og\:url"]').length && !String(response.responseText).match('No-one has added')) {
        const url = $(result).find('meta[property="og\:url"]').attr('content');
        getLetterboxdRatingsCustom(url, lboxd_cust);
      }
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 1): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 1): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 1): Request timed out.");
    }
  });
}

function getLetterboxdRatingsCustom(url, lboxd_cust) {
  const newurl = url + "ratings";
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    newurl,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      let user_rating;
      if ($(result).find('[class*=rated-large-]').length) {
        let ratings_array = [];
        ratings_array.push($(result).find('.rated-large-1').parentsUntil('.section').find('li').length);
        ratings_array.push($(result).find('.rated-large-2').parentsUntil('.section').find('li').length *2);
        ratings_array.push($(result).find('.rated-large-3').parentsUntil('.section').find('li').length *3);
        ratings_array.push($(result).find('.rated-large-4').parentsUntil('.section').find('li').length *4);
        ratings_array.push($(result).find('.rated-large-5').parentsUntil('.section').find('li').length *5);
        ratings_array.push($(result).find('.rated-large-6').parentsUntil('.section').find('li').length *6);
        ratings_array.push($(result).find('.rated-large-7').parentsUntil('.section').find('li').length *7);
        ratings_array.push($(result).find('.rated-large-8').parentsUntil('.section').find('li').length *8);
        ratings_array.push($(result).find('.rated-large-9').parentsUntil('.section').find('li').length *9);
        ratings_array.push($(result).find('.rated-large-10').parentsUntil('.section').find('li').length *10);

        const voters = $(result).find('.film-rating-group').find('li').length;
        const average = (eval(ratings_array.join("+")) / voters) *10;
        user_rating = Math.round(average);
      } else {
        return;
      }
      $('.LetterboxdUserRatingImg').attr('src', lboxd_cust);
      $('.LetterboxdUserRating').attr('title', 'Custom raw average');
      $('.LetterboxdUserRating').text(user_rating);
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 2): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 2): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Letterboxd Ratings 2): Request timed out.");
    }
  });
}

function getRTandMetaRatings_OMDb(key, imdbid, meta_icon, rott_rotten, rott_certified, rott_fresh, rott_user_up, rott_user_down) {
  const url = "http://www.omdbapi.com/?i=tt" +imdbid+ "&apikey=" +key+ "&plot=full&tomatoes=true";
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      if (String(response.responseText).match("limit reached!")) {
        GM.notification("Limit reached! \nSet OMDb API key in settings. \nGet it at www.omdbapi.com .", "IMDb Scout Mod (RT/MC Ratings)");
        return;
      }
      let responseJSON, rott_crit, meta_crit;
      if (response.status == 200) {
        responseJSON = JSON.parse(response.responseText);
        GM.setValue("OMDb_last", JSON.stringify(responseJSON));
        if (responseJSON['Response'] == "False" || responseJSON['Ratings'].length < 1) {
          return;
        }
        const rott_url = responseJSON['tomatoURL'];
        if (rott_url.match("rottentomatoes")) {
          getRotten(rott_url, rott_rotten, rott_certified, rott_fresh, rott_user_up, rott_user_down);
          $('.RottCritRatingUrl').attr('href', rott_url);
        }
        let x;
        if (responseJSON['Ratings'][0]['Source'] == 'Rotten Tomatoes') {
          x = parseInt(responseJSON['Ratings'][0]['Value'], 10);
        } else if (responseJSON['Ratings'].length > 1) {
            if (responseJSON['Ratings'][1]['Source'] == 'Rotten Tomatoes') {
              x = parseInt(responseJSON['Ratings'][1]['Value'], 10);
            } else if (responseJSON['Ratings'].length > 2) {
               if (responseJSON['Ratings'][2]['Source'] == 'Rotten Tomatoes') {
                 x = parseInt(responseJSON['Ratings'][2]['Value'], 10);
               }
            }
        }
        const y = parseInt(responseJSON['Metascore'], 10);
        if ($.isNumeric(x)) {
          rott_crit = x;
        } else {
          rott_crit = "-";
        }
        if ($.isNumeric(y)) {
          meta_crit = y;
        } else {
          meta_crit = "-";
        }
      } else {
        return;
      }
      if (rott_crit <= 59) {
        $('.RottCritRatingImg').attr('src', rott_rotten);
      } else if (rott_crit > 59) {
        $('.RottCritRatingImg').attr('src', rott_fresh);
      }
      if (rott_crit >= 0) {
        $('.RottCritRating').text(rott_crit);
      }
      if (meta_crit >= 0) {
        $('.MetaCritRatingImg').attr('src', meta_icon);
        $('.MetaCritRating').text(meta_crit);
      }
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (OMDb Ratings): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (OMDb Ratings): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (OMDb Ratings): Request timed out.");
    }
  });
}

function getRotten(url, rott_rotten, rott_certified, rott_fresh, rott_user_up, rott_user_down) {
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 14000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      let rott_state, rott_user, rott_crit;
      if ($(result).find('#score-details-json').length) {
        const scoreTxt = $(result).find('#score-details-json').text();
        const scoreJsn = JSON.parse(scoreTxt);
        const x = scoreJsn.scoreboard.audienceScore;
        const y = scoreJsn.scoreboard.tomatometerScore;
        rott_state = scoreJsn.scoreboard.tomatometerState;
        if ($.isNumeric(x)) {
          rott_user = x;
        } else {
          rott_user = "-";
        }
        if ($.isNumeric(y)) {
          rott_crit = y;
        } else {
          rott_crit = "-";
        }
      } else {
        return;
      }

      if (rott_crit >= 0) {
        $('.RottCritRating').text(rott_crit);
      }
      if (rott_user >= 0) {
        $('.RottUserRating').text(rott_user);
      }
      if (rott_state.match("certified")) {
        $('.RottCritRatingImg').attr('src', rott_certified);
      } else if (rott_state.match("rotten")) {
        $('.RottCritRatingImg').attr('src', rott_rotten);
      } else if (rott_state.match("fresh")) {
        $('.RottCritRatingImg').attr('src', rott_fresh);
      }
      if (rott_user > 59) {
        $('.RottUserRatingImg').attr('src', rott_user_up);
      } else if (rott_user <= 59 && rott_user >= 0) {
        $('.RottUserRatingImg').attr('src', rott_user_down);
      }
      ratingsColor();
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Rotten Tomatoes): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Rotten Tomatoes): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Rotten Tomatoes): Request timed out.");
    }
  });
}

async function getDoubanRatings(imdbid, douban_icon) {
  let id = await getDoubanID0(imdbid);
  if (id == "00000000") {
    id = await getDoubanID1(imdbid);
  }
  if (id == "00000000") {
    id = await getDoubanID2(imdbid);
  }
  if (id == "00000000") {
    id = await getDoubanID3(imdbid);
  }
  if (id == "00000000") {
    return;
  }
  const url = "https://movie.douban.com/subject/" +id;
  $('.DoubanUserRatingUrl').attr('href', url);
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      let user_rating;
      if ($(result).find('.rating_num').length) {
        const x = $(result).find('.rating_num').text();
        if ($.isNumeric(x)) {
          user_rating = x *10;
          $('.DoubanUserRating').text(user_rating);
          $('.DoubanUserRatingImg').attr('src', douban_icon);
          ratingsColor();
        }
      }
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Douban): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Douban): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Douban): Request timed out.");
    }
  });
}
//www.allocine.fr/film/fichefilm_gen_cfilm=118831.html
async function getAllocineRatings(imdbid, allocine_icon) {
  const id = await getAllocineID(imdbid);
  const is_film = await GM.getValue("AllocineID_last_is_film");
  let url;
  if (id == "00000000") {
    return;
  } else if (is_film) {
    url = "https://www.allocine.fr/film/fichefilm_gen_cfilm=" +id+ ".html";
  } else {
    url = "https://www.allocine.fr/series/ficheserie_gen_cserie=" +id+ ".html";
  }
  $('.AllocineUserRatingUrl').attr('href', url);
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");
      const resultStr = String(response.responseText);

      let rating1, rating2;
      if ($(result).find('.stareval-note').length) {
        const x = $(result).find('.stareval-note:eq(0)').text().replace(',','.') *20;
        const y = $(result).find('.stareval-note:eq(1)').text().replace(',','.') *20;
        if ($.isNumeric(x)) {
          rating1 = x;
        } else {
          rating1 = "-";
        }
        if ($.isNumeric(y)) {
          rating2 = y;
        } else {
          rating2 = "-";
        }
        if (rating1 > 0 || rating2 > 0) {
          $('.AllocineUserRatingImg').attr('src', allocine_icon);
        }
        if (resultStr.match('> Presse <')) {
          $('.AllocineCritRating').text(rating1);
          $('.AllocineUserRating').text(rating2);
        } else {
          $('.AllocineUserRating').text(rating1);
        }
        ratingsColor();
      }
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Allocine): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Allocine): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Allocine): Request timed out.");
    }
  });
}

function ratingsColor() {
  if (GM_config.get("ratings_cfg_color")) {
    const ref_high = parseInt(GM_config.get('ratings_cfg_color_scheme').split(',')[0], 10);
    const ref_low  = parseInt(GM_config.get('ratings_cfg_color_scheme').split(',')[1], 10);
    $( ".scoutRatings").each(function(index) {
      if ($(this).text() > ref_high) {
        $(this).css('color', '#00e600');
      } else if ($(this).text() <= ref_high && $(this).text() > ref_low) {
        $(this).css('color', '#f5c20a');
      } else if ($(this).text() <= ref_low && $(this).text() >= 0) {
        $(this).css('color', '#e60000');
      }
    });
  }
}



//==============================================================================
//    Dark styles for Reference View
//==============================================================================

function darkReferenceStyles() {
  if (!GM_config.get('dark_reference_view') || !onReferencePage) {
    return;
  }
  // www.w3schools.com/colors/colors_picker.asp
  // background color
  addGlobalStyles('#nav-search-form {background: #d9d9d9}');
  addGlobalStyles('#wrapper, #pagecontent, .recently-viewed {background-color: #000000}');
  addGlobalStyles('.aux-content-widget-2 {background: #191919}');
  addGlobalStyles('#imdbscout_header, #imdbscoutsecondbar_header, #imdbscoutthirdbar_header, .article, .cast_list tr, .titlereference-list tr {background-color: #191919 !important}');
  addGlobalStyles('.add-image-container {background-color: #262626}');
  // border color
  addGlobalStyles('.article, .aux-content-widget-2, .cast_list tr, .titlereference-list tr, .recently-viewed .item {border-color: #323232 !important}');
  addGlobalStyles('hr, .answers-widget__question, .answers-widget__see-more {border-color: #666666}');
  addGlobalStyles('.recently-viewed {border-color: #000000}');
  // font color
  addGlobalStyles('h3[itemprop="name"], .titlereference-title-year a {color: #f5c20a}');
  addGlobalStyles('.titlereference-original-title-label {color: #cc0000}');
  addGlobalStyles('.ipl-rating-star__rating {font-weight: bold; color: #00b300;}');
  addGlobalStyles('.article, .aux-content-widget-2, .cast_list tr td {color: #cccccc !important}');
  addGlobalStyles('.ipl-list-title, #sidebar h4, .ipl-list-title::after {color: #c49b08}');
  addGlobalStyles('.ipl-list-title::after {border-color: #7a6105}');
}

function addGlobalStyles(css) {
  var head, style;
  head = document.getElementsByTagName('head')[0];
  if (!head) { return; }
  style = document.createElement('style');
  style.className = 'IMDbScoutStyles';
  style.innerHTML = css;
  head.appendChild(style);
}

//==============================================================================
//    Compact mode for Reference View
//==============================================================================

function compactReferenceStyles() {
  if (!GM_config.get('compact_reference_view') || !onReferencePage) {
    return;
  }
  addGlobalStyles('#main {margin-left:25px !important}');
  addGlobalStyles('#sidebar {margin-right:25px !important}');
  addGlobalStyles('#content-2-wide {margin-top:5px !important}');
  addGlobalStyles('.aux-content-widget-2 {margin-top:0px; padding-top:0px !important}');

  addGlobalStyles('#imdbHeader {width:960px; display:flex; justify-content:center; align-items:center; margin:auto !important}');
  document.getElementById('styleguide-v2').id = 'styleguide-v2x';
  addGlobalStyles('body#styleguide-v2x {background-color: #000000 !important; margin-top:0px}');
}

function compactReferenceElemRemoval() {
  if (!GM_config.get('compact_reference_view') || !onReferencePage) {
    return;
  }
  $('.titlereference-section-credits').nextUntil('.titlereference-section-storyline').remove();
  $('.titlereference-section-credits').remove();
  if (Boolean($('.titlereference-section-storyline .ipl-zebra-list__item').first().text().match("Plot Summary"))) {
    $('.titlereference-section-storyline .ipl-zebra-list__item').first().nextUntil('section').remove();
  } else {
    $('.titlereference-section-storyline').remove();
  }
  $('.titlereference-section-did-you-know').remove();
  $('#contribute-main-section').remove();
  $('.recently-viewed').remove();

  // Inject Top Review
  if ($('.titlereference-overview-review-list').length) {
    if ($('.titlereference-overview-review-list').text().match('User')) {
      getIMDbTopReview();
    }
  }
}

function getIMDbTopReview() {
  const imdbid = document.URL.match(/\/tt([0-9]+)\//)[1].trim('tt');
  const url = "https://www.imdb.com/title/tt" +imdbid+ "/reviews?spoiler=hide&sort=helpfulnessScore";
  GM.xmlHttpRequest({
    method: "GET",
    timeout: 10000,
    url:    url,
    onload: function(response) {
      const parser = new DOMParser();
      const result = parser.parseFromString(response.responseText, "text/html");

      const xTitle = $(result).find('.imdb-user-review:eq(0)').find('.title').text().trim();
      const xRevLink = $(result).find('.imdb-user-review:eq(0)').find('.title').attr('href');
      const xReview = $(result).find('.imdb-user-review:eq(0)').find('.text').html();
      const xUser = $(result).find('.imdb-user-review:eq(0)').find('.display-name-link').text().trim();
      const xUsrLink = $(result).find('.imdb-user-review:eq(0)').find('.display-name-link a').attr('href');
      const xDate = $(result).find('.imdb-user-review:eq(0)').find('.review-date').text().trim();
      const xRating = $(result).find('.imdb-user-review:eq(0)').find('.ipl-star-icon').next().text().trim();

      let x = '' +
              '<section class="scout_review">' +
              '  <div><h4 class="ipl-list-title">Top Review</h4></div>' +
              '  <table class="titlereference-list ipl-zebra-list">' +
              '    <tbody>' +
              '      <tr class="ipl-zebra-list__item">' +
              '        <td>' +
              '          <a class="scout_review_rating">' +
              '            <span class="ipl-rating-star__star">' +
              '              <svg class="ipl-icon ipl-star-icon" xmlns="http://www.w3.org/2000/svg" fill="#000000" height="24" viewBox="0 0 24 24" width="24">' +
              '                <path d="M0 0h24v24H0z" fill="none"></path>' +
              '                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>' +
              '                <path d="M0 0h24v24H0z" fill="none"></path>' +
              '              </svg></span>' +
              '            <span class="point-scale"> xRating</span><span> |</span></a>' +
              '          <a class="scout_review_title" href="xRevLink"> xTitle</a>' +
              '          <div class="display-name-date" style="font-size:11px">' +
              '            <span class="display-name-link">' +
              '              <a href="xUsrLink">xUser</a></span>' +
              '            <span class="review-date"> xDate</span></div>' +
              '          <p>xReview</p></td></tr></tbody></table></section>' +
              '';
      x = x.replace('xTitle', xTitle);
      x = x.replace('xRevLink', xRevLink);
      x = x.replace('xReview', xReview);
      x = x.replace('xUser', xUser);
      x = x.replace('xUsrLink', xUsrLink);
      x = x.replace('xDate', xDate);
      x = x.replace('xRating', xRating);

      let y = jQuery.parseHTML(x);
      $('.titlereference-section-media').after(y);
    },
    onerror: function() {
      console.log("IMDb Scout Mod (Review): Request Error.");
    },
    onabort: function() {
      console.log("IMDb Scout Mod (Review): Request is aborted.");
    },
    ontimeout: function() {
      console.log("IMDb Scout Mod (Review): Request timed out.");
    }
  });
}

//==============================================================================
//    Remove ads from IMDb
//==============================================================================

function adsRemovalReference() {
  if (!GM_config.get('remove_ads')) {
    return;
  }
  if (Boolean($('.aux-content-widget-2').first().text().match("IMDb Answers"))) {
    $('.aux-content-widget-2').first().remove();
  }
  $('.cornerstone_slot').remove();
  $('.imdb-footer').remove();
  $('#social-share-widget').remove();
  $('.navbar__imdbpro').remove();
  $('[class^=Root__Separator]').remove();
  // To remove ad's background image
  $('#wrapper').attr('style', 'background: 000000 !important');
}

function adsRemoval() {
  if (!GM_config.get('remove_ads')) {
    return;
  }
  // removing 5th ".nas-slot" breaks dynamic reflow when window is resized.
  if ($('.nas-slot').length == 7) {
    $('.nas-slot')[0].remove();
    $('.nas-slot')[0].remove();
    $('.nas-slot')[0].remove();
    $('.nas-slot')[0].remove();
    $('.nas-slot')[1].remove();
    $('.nas-slot')[1].remove();
    $('#inline40_wrapper').remove();
  } else {
    $('.nas-slot').remove();
  }

  $('[class^=Banner]').remove();
  $('[id^=taboola]').remove();
  $('[class*=ProLink]').remove();
  $('[class^=IMDbPro]').remove();
  $('.imdb-editorial-single').remove();
  $('.imdb-footer').remove();
  $('.navbar__imdbpro').remove();
  $('[class^=Root__Separator]').remove();
}

//==============================================================================
//    Create the config name (GM_config)
//==============================================================================

function configName(site) {
  if ('configName' in site) {
    return 'show_' + site['configName'] + (site['TV'] ? '_TV' : '');
  } else {
    return 'show_' + site['name'] + (site['TV'] ? '_TV' : '');
  }
}

//==============================================================================
//    Count sites (GM_config)
//==============================================================================

function countSites(task) {
  if (task == 1) {
    const count_total = sites.concat(icon_sites).length;
    return count_total;
  }
  if (task == 2) {
    // Init GM_config to get amount of selected sites.
    // GM_config's fields needs to be mirrored to keep Settings intact.
    var config_fields = {
      'aftertitle': {'type': 'hidden'},
      'imdbtotalstats': {'type': 'hidden'},
      'imdbselectedstats': {'type': 'hidden'},
      'imdbscoutmod_header_text': {'type': 'text'},
      'imdbscoutsecondbar_header_text': {'type': 'text'},
      'imdbscoutthirdbar_header_text': {'type': 'text'},
      'mod_icons_size': {'type': 'text'},
      'iconsborder_size': {'type': 'select', 'options': ['2px', '3px', '4px', '5px', '6px']},
      'cfg_iconsize': {'type': 'text'},
      'timeout_ms': {'type': 'select', 'options': ['10000 ms', '20000 ms', '30000 ms', '45000 ms', '60000 ms']},
      'load_icons_in_settings': {'type': 'checkbox'},
      'remove_ads': {'type': 'checkbox'},
      'debug_sites': {'type': 'checkbox'},
      'loadmod_on_start_movie': {'type': 'checkbox'},
      'load_second_bar': {'type': 'checkbox'},
      'load_third_bar_movie': {'type': 'checkbox'},
      'switch_bars': {'type': 'checkbox'},
      'sortReqOnNewLine': {'type': 'checkbox'},
      'call_http_mod_movie': {'type': 'checkbox'},
      'hide_missing_movie': {'type': 'checkbox'},
      'use_mod_icons_movie': {'type': 'checkbox'},
      'one_line': {'type': 'checkbox'},
      'ignore_type_movie': {'type': 'checkbox'},
      'remove_openall': {'type': 'checkbox'},
      'force_reference_view': {'type': 'checkbox'},
      'dark_reference_view': {'type': 'checkbox'},
      'compact_reference_view': {'type': 'checkbox'},
      'greybackground_reference_view': {'type': 'checkbox'},
      'highlight_sites_movie': {'type': 'text'},
      'highlight_missing_movie': {'type': 'text'},
      'loadmod_on_start_search': {'type': 'checkbox'},
      'load_third_bar_search': {'type': 'checkbox'},
      'call_http_mod_search': {'type': 'checkbox'},
      'hide_missing_search': {'type': 'checkbox'},
      'use_mod_icons_search': {'type': 'checkbox'},
      'ignore_type_search': {'type': 'checkbox'},
      'highlight_sites_search': {'type': 'text'},
      'highlight_missing_search': {'type': 'text'},
      'ratings_img_px': {'type': 'select', 'options': ['32px', '48px', '64px']},
      'ratings_cfg_imdb': {'type': 'checkbox'},
      'ratings_cfg_metacritic': {'type': 'checkbox'},
      'ratings_cfg_rotten': {'type': 'checkbox'},
      'ratings_cfg_letterboxd': {'type': 'checkbox'},
      'ratings_cfg_douban': {'type': 'checkbox'},
      'ratings_cfg_allocine': {'type': 'checkbox'},
      'ratings_imdb_fem': {'type': 'checkbox'},
      'ratings_cfg_color': {'type': 'checkbox'},
      'ratings_cfg_color_scheme': {'type': 'text'},
      'ratings_cfg_omdb_apikey': {'type': 'text'},
      'radarr_searchformovie': {'type': 'checkbox'},
      'radarr_monitored': {'type': 'checkbox'},
      'radarr_url': {'type': 'text'},
      'radarr_apikey': {'type': 'text'},
      'radarr_rootfolderpath': {'type': 'text'},
      'radarr_profileid': {'type': 'select', 'options': ['Any', 'HD - 720p/1080p', 'HD-1080p', 'HD-720p', 'SD', 'Ultra-HD', 'Custom']},
      'radarr_customprofileid': {'type': 'text'},
      'radarr_minimumavailability': {'type': 'select', 'options': ['announced', 'inCinemas', 'released', 'preDB']},
      'sonarr_searchformissing': {'type': 'checkbox'},
      'sonarr_searchforcutoff': {'type': 'checkbox'},
      'sonarr_ignoreEpisodesWithFiles': {'type': 'checkbox'},
      'sonarr_ignoreEpisodesWithoutFiles': {'type': 'checkbox'},
      'sonarr_seasonfolder': {'type': 'checkbox'},
      'sonarr_usescenenumbering': {'type': 'select', 'options': ['Auto', 'No', 'Yes']},
      'sonarr_monitored': {'type': 'select', 'options': ['All Episodes', 'Future Episodes', 'Missing Episodes', 'Existing Episodes', 'Pilot Episode', 'Only First Season', 'Only Latest Season', 'None']},
      'sonarr_url': {'type': 'text'},
      'sonarr_apikey': {'type': 'text'},
      'sonarr_rootfolderpath': {'type': 'text'},
      'sonarr_profileid': {'type': 'select', 'options': ['Any', 'HD - 720p/1080p', 'HD-1080p', 'HD-720p', 'SD', 'Ultra-HD', 'Custom']},
      'sonarr_customprofileid': {'type': 'text'},
      'sonarr_languageprofileid': {'type': 'text'},
      'sonarr_seriestype': {'type': 'select', 'options': ['standard', 'daily', 'anime']},
      'trakt_synclimiter': {'type': 'select', 'options': ['15', '30', '60', '300']},
      'plex_server_url': {'type': 'text'},
      'plex_token': {'type': 'text'},
      'jellyfin_server_url': {'type': 'text'},
      'jellyfin_username': {'type': 'text'},
      'jellyfin_password': {'type': 'text'},
      'jellyfin_debug': {'type': 'checkbox'},
      'emby_server_url': {'type': 'text'},
      'emby_username': {'type': 'text'},
      'emby_password': {'type': 'text'},
      'emby_debug': {'type': 'checkbox'},
      'milkie_authToken': {'type': 'text'},
      'tnt_authToken': {'type': 'text'}
    };
    $.each(custom_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(public_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(private_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(german_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(usenet_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(subs_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(pre_databases, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(other_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(streaming_sites, function(index, site) {config_fields[configName(site)] = {'type': 'checkbox'};});
    $.each(icon_sites_main, function(index, icon_site) {config_fields['show_icon_' + icon_site['name']] = {'type': 'checkbox'};});
    $.each(special_buttons, function(index, icon_site) {config_fields['show_icon_' + icon_site['name']] = {'type': 'checkbox'};});

    GM_config.init({'id': 'imdb_scout', 'fields': config_fields});

    $.each(sites, function(index, site) {
      site['show'] = GM_config.get(configName(site));
    });
    $.each(icon_sites, function(index, icon_site) {
      icon_site['show'] = GM_config.get('show_icon_' + icon_site['name']);
    });

    const count_selected = sites.concat(icon_sites).reduce(function (n, site) {
      return n + (site['show'] == true); }, 0);

    return count_selected;
  }
}


//============================================================================//
//================================  MAIN  ====================================//
//============================================================================//


//==============================================================================
//    Polyfill for GM3 notifications
//==============================================================================

if (typeof GM.notification === "undefined") {
  this.GM_notification = function(options) {
    const opts = {};
    if (typeof options === "string") {
      opts.text = options;
      opts.title = arguments[1];
      opts.image = arguments[2];
      opts.onclick = arguments[3];
    } else {
      Object.keys(options).forEach(function(key) {
        opts[key] = options[key];
      });
    }

    checkPermission();

    function checkPermission() {
      if (Notification.permission === "granted") {
        fireNotice(opts);
      } else if (Notification.permission === "denied") {
        alert("User has denied notifications for this page/site!");
        // eslint-disable-next-line no-useless-return
        return;
      } else {
        Notification.requestPermission(function(permission) {
          console.log("New permission: ", permission);
          checkPermission();
        });
      }
    }

    function fireNotice(ntcOptions) {
      if (ntcOptions.text && !ntcOptions.body) {
        ntcOptions.body = ntcOptions.text;
      }
      var ntfctn = new Notification(ntcOptions.title, ntcOptions);

      if (ntcOptions.onclick) {
        ntfctn.onclick = ntcOptions.onclick;
      }
      if (ntcOptions.timeout) {
        setTimeout(function() {
          ntfctn.close();
        }, ntcOptions.timeout);
      }
    }
  };
  GM.notification = GM_notification;
}

//==============================================================================
//    Settings Menu (GM_config)
//==============================================================================

// To have consistent spacing in different browsers.
var set_cfg_iconsize_spacing = "&nbsp &nbsp";
var radarr_url_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
var radarr_apikey_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
var radarr_rootfolderpath_spacing = "&nbsp";
var sonarr_usescenenumbering_spacing = "&nbsp &nbsp";
var sonarr_monitored_spacing = " &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
var sonarr_languageprofileid_spacing = " &nbsp &nbsp &nbsp &nbsp &nbsp";
var sonarr_seriestype_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {
  set_cfg_iconsize_spacing = " &nbsp";
  radarr_url_spacing = " &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
  radarr_apikey_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
  radarr_rootfolderpath_spacing = "";
  sonarr_usescenenumbering_spacing = "&nbsp";
  sonarr_monitored_spacing = " &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
  sonarr_languageprofileid_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp";
  sonarr_seriestype_spacing = "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp";
}

var config_fields = {
  'aftertitle': {
    'section': ' ',
    'label': ' &nbsp',
    'type': 'hidden'
  },
  'imdbtotalstats': {
    'label': 'Total sites:&nbsp'.bold().fontsize(3) + countSites(1).toString().bold().fontsize(3).fontcolor("Blue"),
    'type': 'hidden'
  },
  'imdbselectedstats': {
    'label': 'Selected sites:&nbsp'.bold().fontsize(3) + countSites(2).toString().bold().fontsize(3).fontcolor("Blue"),
    'type': 'hidden'
  },
  'imdbscoutmod_header_text': {
    'label': 'Header text for the 1st bar:&nbsp',
    'type': 'text',
    'default': ''
  },
  'imdbscoutsecondbar_header_text': {
    'label': 'Header text for the 2nd bar:',
    'type': 'text',
    'default': ''
  },
  'imdbscoutthirdbar_header_text': {
    'label': 'Header text for the 3rd bar:&nbsp',
    'type': 'text',
    'default': ''
  },
  'mod_icons_size': {
    'label': 'Size of the icons (pixels): &nbsp &nbsp',
    'type': 'text',
    'default': '32'
  },
  'iconsborder_size': {
    'label': 'Size of the icons border:&nbsp &nbsp &nbsp',
    'type': 'select',
    'options': ['2px', '3px', '4px', '5px', '6px'],
    'default': '3px'
  },
  'cfg_iconsize': {
    'label': 'Size of the settings icons:' + set_cfg_iconsize_spacing,
    'type': 'text',
    'default': '22'
  },
  'timeout_ms': {
    'label': 'Timeout requests after: &nbsp &nbsp &nbsp' + radarr_rootfolderpath_spacing,
    'type': 'select',
    'options': ['10000 ms', '20000 ms', '30000 ms', '45000 ms', '60000 ms'],
    'default': '30000 ms'
  },
  'load_icons_in_settings': {
    'type': 'checkbox',
    'label': 'Load icons in settings (most of them are external)?',
    'default': true
  },
  'remove_ads': {
    'type': 'checkbox',
    'label': 'Remove IMDb ads?',
    'default': true
  },
  'debug_sites': {
    'type': 'checkbox',
    'label': 'Debug (the searchable sites)?',
    'default': false
  },
  'loadmod_on_start_movie': {
    'section': 'Title Page:',
    'type': 'checkbox',
    'label': 'Load links to sites on start?',
    'default': true
  },
  'load_second_bar': {
    'type': 'checkbox',
    'label': 'Enable the 2nd search bar?',
    'default': false
  },
  'load_third_bar_movie': {
    'type': 'checkbox',
    'label': 'Enable the 3rd search bar?',
    'default': false
  },
  'switch_bars': {
    'type': 'checkbox',
    'label': 'Swap 2nd and 3rd bars?',
    'default': false
  },
  'sortReqOnNewLine': {
    'type': 'checkbox',
    'label': 'Split Req sites to a new line if the request is found?',
    'default': true
  },
  'call_http_mod_movie': {
    'type': 'checkbox',
    'label': 'Auto-search sites for results?',
    'default': true
  },
  'hide_missing_movie': {
    'type': 'checkbox',
    'label': "Hide link if search didn't found results?",
    'default': false
  },
  'use_mod_icons_movie': {
    'type': 'checkbox',
    'label': 'Use icons instead of text?',
    'default': true
  },
  'one_line': {
    'type': 'checkbox',
    'label': 'Show search results on one line?',
    'default': true
  },
  'ignore_type_movie': {
    'type': 'checkbox',
    'label': 'Search all sites, ignoring movie/tv distinction?',
    'default': false
  },
  'remove_openall': {
    'type': 'checkbox',
    'label': 'Remove "Open All" button?',
    'default': false
  },
  'force_reference_view': {
    'type': 'checkbox',
    'label': 'Reference View: Force it (without login)?',
    'default': false
  },
  'dark_reference_view': {
    'type': 'checkbox',
    'label': 'Reference View: Enable the dark style?',
    'default': true
  },
  'compact_reference_view': {
    'type': 'checkbox',
    'label': 'Reference View: Enable the compact mode?',
    'default': true
  },
  'greybackground_reference_view': {
    'type': 'checkbox',
    'label': 'Reference View: Enable grey background for searchable sites?',
    'default': true
  },
  'highlight_sites_movie': {
    'label': 'Highlight sites: &nbsp &nbsp &nbsp',
    'type': 'text',
    'default': 'PTP,KG,BTN,BTN-Title,SC,CG,TVV,Tik'
  },
  'highlight_missing_movie': {
    'label': 'Mark when not on:',
    'type': 'text',
    'default': ''
  },
  'loadmod_on_start_search': {
    'section': 'Search/List/Watchlist Page:',
    'type': 'checkbox',
    'label': 'Load links to sites on start?',
    'default': false
  },
  'load_third_bar_search': {
    'type': 'checkbox',
    'label': 'Enable the 3rd search bar?',
    'default': false
  },
  'call_http_mod_search': {
    'type': 'checkbox',
    'label': 'Auto-search sites for results?',
    'default': true
  },
  'hide_missing_search': {
    'type': 'checkbox',
    'label': "Hide link if search didn't found results?",
    'default': false
  },
  'use_mod_icons_search': {
    'type': 'checkbox',
    'label': 'Use icons instead of text?',
    'default': true
  },
  'ignore_type_search': {
    'type': 'checkbox',
    'label': 'Search all sites, ignoring movie/tv distinction?',
    'default': false
  },
  'highlight_sites_search': {
    'label': 'Highlight sites: &nbsp &nbsp &nbsp',
    'type': 'text',
    'default': ''
  },
  'highlight_missing_search': {
    'label': 'Mark when not on:',
    'type': 'text',
    'default': ''
  },
  'ratings_img_px': {
    'label': 'Size of the ratings icons: &nbsp',
    'section': 'External ratings:',
    'type': 'select',
    'options': ['32px', '48px', '64px'],
    'default': '48px'
  },
  'ratings_cfg_imdb': {
    'type': 'checkbox',
    'label': 'Enable IMDb ratings?',
    'default': true
  },
  'ratings_cfg_metacritic': {
    'type': 'checkbox',
    'label': 'Enable Metacritic ratings?',
    'default': true
  },
  'ratings_cfg_rotten': {
    'type': 'checkbox',
    'label': 'Enable Rotten Tomatoes ratings?',
    'default': true
  },
  'ratings_cfg_letterboxd': {
    'type': 'checkbox',
    'label': 'Enable Letterboxd ratings?',
    'default': true
  },
  'ratings_cfg_douban': {
    'type': 'checkbox',
    'label': 'Enable Douban ratings?',
    'default': false
  },
  'ratings_cfg_allocine': {
    'type': 'checkbox',
    'label': 'Enable Allocine ratings?',
    'default': false
  },
  'ratings_imdb_fem': {
    'type': 'checkbox',
    'label': 'Add additional females ratings for IMDb?',
    'default': false
  },
  'ratings_cfg_color': {
    'type': 'checkbox',
    'label': 'Enable color scheme for ratings?',
    'default': true
  },
  'ratings_cfg_color_scheme': {
    'label': 'Reference points for colors:&nbsp',
    'type': 'text',
    'default': '69,49'
  },
  'ratings_cfg_omdb_apikey': {
    'label': 'OMDb API key:&nbsp',
    'type': 'text',
    'default': ''
  },
  'radarr_searchformovie': {
    'section': 'Radarr settings:',
    'type': 'checkbox',
    'label': 'Search for movie on add?',
    'default': true
  },
  'radarr_monitored': {
    'type': 'checkbox',
    'label': 'Add monitored?',
    'default': true
  },
  'radarr_url': {
    'label': 'Radarr URL:' + radarr_url_spacing,
    'type': 'text',
    'default': 'http://localhost:7878'
  },
  'radarr_apikey': {
    'label': 'Radarr API Key:' + radarr_apikey_spacing,
    'type': 'text',
    'default': ''
  },
  'radarr_rootfolderpath': {
    'label': 'Radarr Root Folder Path:' + radarr_rootfolderpath_spacing,
    'type': 'text',
    'default': 'D:\\Movies'
  },
  'radarr_profileid': {
    'label': 'Radarr Quality Profile: &nbsp &nbsp &nbsp',
    'type': 'select',
    'options': ['Any', 'HD - 720p/1080p', 'HD-1080p', 'HD-720p', 'SD', 'Ultra-HD', 'Custom'],
    'default': 'Any'
  },
  'radarr_customprofileid': {
    'label': 'Custom Quality ProfileID:' + radarr_rootfolderpath_spacing,
    'type': 'text',
    'default': '1'
  },
  'radarr_minimumavailability': {
    'label': 'Minimum Availability: &nbsp &nbsp &nbsp &nbsp',
    'type': 'select',
    'options': ['announced', 'inCinemas', 'released', 'preDB'],
    'default': 'inCinemas'
  },
  'sonarr_searchformissing': {
    'section': 'Sonarr settings:',
    'type': 'checkbox',
    'label': 'Start search for missing episodes?',
    'default': false
  },
  'sonarr_searchforcutoff': {
    'type': 'checkbox',
    'label': 'Start search for cutoff unmet episodes?',
    'default': false
  },
  'sonarr_ignoreEpisodesWithFiles': {
    'type': 'checkbox',
    'label': 'Set ignoreEpisodesWithFiles=true?',
    'default': false
  },
  'sonarr_ignoreEpisodesWithoutFiles': {
    'type': 'checkbox',
    'label': 'Set ignoreEpisodesWithoutFiles=true?',
    'default': false
  },
  'sonarr_seasonfolder': {
    'type': 'checkbox',
    'label': 'Season Folder?',
    'default': true
  },
  'sonarr_usescenenumbering': {
    'label': 'Use Scene Numbering?' + sonarr_usescenenumbering_spacing,
    'type': 'select',
    'options': ['Auto', 'No', 'Yes'],
    'default': 'Auto'
  },
  'sonarr_monitored': {
    'label': 'Monitored:' + sonarr_monitored_spacing,
    'type': 'select',
    'options': ['All Episodes', 'Future Episodes', 'Missing Episodes', 'Existing Episodes', 'Pilot Episode', 'Only First Season', 'Only Latest Season', 'None'],
    'default': 'All Episodes'
  },
  'sonarr_url': {
    'label': 'Sonarr URL:' + radarr_url_spacing,
    'type': 'text',
    'default': 'http://localhost:8989'
  },
  'sonarr_apikey': {
    'label': 'Sonarr API Key:' + radarr_apikey_spacing,
    'type': 'text',
    'default': ''
  },
  'sonarr_rootfolderpath': {
    'label': 'Sonarr Root Folder Path:' + radarr_rootfolderpath_spacing,
    'type': 'text',
    'default': 'D:\\TVSeries'
  },
  'sonarr_profileid': {
    'label': 'Sonarr Quality Profile: &nbsp &nbsp &nbsp',
    'type': 'select',
    'options': ['Any', 'HD - 720p/1080p', 'HD-1080p', 'HD-720p', 'SD', 'Ultra-HD', 'Custom'],
    'default': 'Any'
  },
  'sonarr_customprofileid': {
    'label': 'Custom Quality ProfileID:' + radarr_rootfolderpath_spacing,
    'type': 'text',
    'default': '1'
  },
  'sonarr_languageprofileid': {
    'label': 'Language ProfileID:' + sonarr_languageprofileid_spacing,
    'type': 'text',
    'default': '1'
  },
  'sonarr_seriestype': {
    'label': 'Series Type:' + sonarr_seriestype_spacing,
    'type': 'select',
    'options': ['standard', 'daily', 'anime'],
    'default': 'standard'
  },
  'trakt_synclimiter': {
    'label': "Sliding watchlist's sync timeout (seconds):",
    'section': 'Trakt-Watchlist settings:',
    'type': 'select',
    'options': ['15', '30', '60', '300'],
    'default': '15'
  },
  'plex_server_url': {
    'label': "Plex Server URL:",
    'section': 'Plex settings:',
    'type': 'text',
    'default': 'http://127.0.0.1:32400'
  },
  'plex_token': {
    'label': "Plex Token: &nbsp &nbsp &nbsp &nbsp &nbsp",
    'type': 'text',
    'default': ''
  },
  'jellyfin_server_url': {
    'label': "Jellyfin Server URL:",
    'section': 'Jellyfin settings:',
    'type': 'text',
    'default': 'http://localhost:8096'
  },
  'jellyfin_username': {
    'label': "Jellyfin Username: &nbsp",
    'type': 'text',
    'default': ''
  },
  'jellyfin_password': {
    'label': "Jellyfin Password:&nbsp &nbsp",
    'type': 'text',
    'default': ''
  },
  'jellyfin_debug': {
    'type': 'checkbox',
    'label': "Debug?",
    'default': false
  },
  'emby_server_url': {
    'label': "Emby Server URL:",
    'section': 'Emby settings:',
    'type': 'text',
    'default': 'http://localhost:8096'
  },
  'emby_username': {
    'label': "Emby Username: &nbsp",
    'type': 'text',
    'default': ''
  },
  'emby_password': {
    'label': "Emby Password:&nbsp &nbsp",
    'type': 'text',
    'default': ''
  },
  'emby_debug': {
    'type': 'checkbox',
    'label': "Debug?",
    'default': false
  },
  'milkie_authToken': {
    'label': 'Milkie:',
    'section': 'Authorization Tokens:',
    'type': 'text',
    'default': ''
  },
  'tnt_authToken': {
    'label': 'TNT:&nbsp &nbsp',
    'type': 'text',
    'default': ''
  }
};

//==============================================================================
//    Add sites to Settings (GM_config)
//==============================================================================

$.each(custom_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Custom sites:'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(public_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Public download sites:'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(private_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Private download sites:'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(german_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['German sites:'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(usenet_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Usenet sites:'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(subs_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Subtitles sites (in 2nd bar):'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(pre_databases, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Pre databases (in 2nd bar):'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(other_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Other sites (in 2nd bar):'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(streaming_sites, function(index, site) {
  config_fields[configName(site)] = {
    'section': (index == 0) ? ['Streaming sites (in 3rd bar):'] : '',
    'type': 'checkbox',
    'label': ' ' + site['name'] + (site['TV'] ? ' (TV)' : '')
  };
});

$.each(icon_sites_main, function(index, icon_site) {
  config_fields['show_icon_' + icon_site['name']] = {
    'section': (index == 0) ? ['Icon sites (no search):'] : '',
    'type': 'checkbox',
    'label': ' ' + icon_site['name'],
    'default': ('showByDefault' in icon_site) ? icon_site['showByDefault'] : true
  };
});

$.each(special_buttons, function(index, icon_site) {
  config_fields['show_icon_' + icon_site['name']] = {
    'section': (index == 0) ? ['Special icons/buttons:'] : '',
    'type': 'checkbox',
    'label': ' ' + icon_site['name'],
    'default': ('showByDefault' in icon_site) ? icon_site['showByDefault'] : true
  };
});

//==============================================================================
//    Initialize and register GM_config
//==============================================================================

GM_config.init({
  'id': 'imdb_scout',
  'title': 'IMDb Scout Mod Settings',
  'fields': config_fields,
  'css': `#imdb_scout_section_header_1, #imdb_scout_section_header_2, #imdb_scout_section_header_3, \
          #imdb_scout_section_header_4, #imdb_scout_section_header_5, #imdb_scout_section_header_6, \
          #imdb_scout_section_header_7, #imdb_scout_section_header_8, #imdb_scout_section_header_9, \
          #imdb_scout_section_header_10, #imdb_scout_section_header_11, #imdb_scout_section_header_12, \
          #imdb_scout_section_header_13, #imdb_scout_section_header_14, #imdb_scout_section_header_15, \
          #imdb_scout_section_header_16, #imdb_scout_section_header_17, #imdb_scout_section_header_18, \
          #imdb_scout_section_header_19, #imdb_scout_section_header_20, #imdb_scout_section_header_21 { \
             background:   #00ab00 !important; \
             color:          black !important; \
             font-weight:     bold !important; \
             border:           0px !important; \
             padding-left:     0px !important; \
             text-align:    middle !important;}\
          .field_label { \
             display:         flex !important; \
             align-items:   center !important; \
             font-weight:   normal !important;}\
          .config_var { \
             margin-top:       2px !important; \
             margin-bottom:    2px !important; \
             display:         flex !important; \
             align-items:   center !important;}\
          #imdb_scout_aftertitle_var { \
             margin-top:       0px !important; \
             margin-bottom:    0px !important;}\
          input { \
             margin-top:       0px !important; \
             margin-bottom:    0px !important;}\
          .grey_link { \
             margin-left:      4px !important;}\
          #imdb_scout_section_header_0 { \
             font-weight:     bold !important; \
             border:           0px !important; \
             margin-top:       0px !important; \
             background:   #bfbfbf !important;}\
          #imdb_scout_header { \
             background:     black !important; \
             color:          white !important;}\
          #imdb_scout_section_0 { \
             margin-top:       0px !important;}`,
  'events':
  {
    'open': function() {
      // Iframe position.
      this.frame.style.top    = '50px';
      this.frame.style.left   = 'auto';
      this.frame.style.right  = '150px';
      this.frame.style.height = '90%';
      this.frame.style.width  = '450px';

      $('#imdb_scout').contents().find('input#imdb_scout_field_highlight_sites_movie').attr('size', '35');
      $('#imdb_scout').contents().find('input#imdb_scout_field_highlight_missing_movie').attr('size', '35');
      $('#imdb_scout').contents().find('input#imdb_scout_field_highlight_sites_search').attr('size', '35');
      $('#imdb_scout').contents().find('input#imdb_scout_field_highlight_missing_search').attr('size', '35');
      $('#imdb_scout').contents().find('input#imdb_scout_field_mod_icons_size').attr('size', '1');
      $('#imdb_scout').contents().find('input#imdb_scout_field_cfg_iconsize').attr('size', '1');
      $('#imdb_scout').contents().find('input#imdb_scout_field_radarr_customprofileid').attr('size', '1');
      $('#imdb_scout').contents().find('input#imdb_scout_field_sonarr_customprofileid').attr('size', '1');
      $('#imdb_scout').contents().find('input#imdb_scout_field_sonarr_languageprofileid').attr('size', '1');
      $('#imdb_scout').contents().find('input#imdb_scout_field_ratings_cfg_color_scheme').attr('size', '2');

      const modVersion = 'IMDb Scout Mod v' + GM.info.script.version;
      const modUrl = 'https://greasyfork.org/en/scripts/407284-imdb-scout-mod';
      $('#imdb_scout').contents().find('#imdb_scout_section_header_0').append($('<a href="'+modUrl+'" target ="_blank">'+modVersion+'</a>'));
      $('#imdb_scout').contents().find('#imdb_scout_section_header_0').find('a').css({
       'text-decoration': 'none',
       'color': '#cb0000'
      });

      const iconsInSettings = GM_config.get('load_icons_in_settings');

      $('#imdb_scout').contents().find('#imdb_scout_section_11').find('.field_label').each(function(index, label) {
        var url = new URL(custom_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(custom_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_12').find('.field_label').each(function(index, label) {
        var url = new URL(public_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(public_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_13').find('.field_label').each(function(index, label) {
        var url = new URL(private_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(private_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_14').find('.field_label').each(function(index, label) {
        var url = new URL(german_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(german_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_15').find('.field_label').each(function(index, label) {
        var url = new URL(usenet_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(usenet_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_16').find('.field_label').each(function(index, label) {
        var url = new URL(subs_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(subs_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_17').find('.field_label').each(function(index, label) {
        var url = new URL(pre_databases[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(pre_databases[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_18').find('.field_label').each(function(index, label) {
        var url = new URL(other_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(other_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_19').find('.field_label').each(function(index, label) {
        var url = new URL(streaming_sites[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(streaming_sites[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_20').find('.field_label').each(function(index, label) {
        var url = new URL(icon_sites_main[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(icon_sites_main[index], iconsInSettings));
      });
      $('#imdb_scout').contents().find('#imdb_scout_section_21').find('.field_label').each(function(index, label) {
        var url = new URL(special_buttons[index].searchUrl);
        $(label).append(' ' + '<a class="grey_link" target="_blank" style="color: gray; text-decoration : none" href="' + url.origin + '">'
                        + (/www./.test(url.hostname) ? url.hostname.match(/www.(.*)/)[1] : url.hostname) + '</a>');
        $(label).prepend(getFavicon(special_buttons[index], iconsInSettings));
      });

      $('#imdb_scout').contents().find("img").css({"margin-right": "4px", "width": GM_config.get('cfg_iconsize'), "height": GM_config.get('cfg_iconsize')});
    },

    'close': function() {
      location.reload();
    }
  }
});

GM.registerMenuCommand('IMDb Scout Mod Settings', function() {GM_config.open();});

//==============================================================================
//    Remove tracking from IMDb's URL before start
//    Force the title pages to open in Reference View
//==============================================================================

if (Boolean(location.href.match('\\?ref_=')) || Boolean(location.href.match('\\?pf_'))) {
  let stripped_href = location.href.split('?ref_=')[0];
      stripped_href = stripped_href.split('?pf_')[0];
  if (GM_config.get('force_reference_view') && Boolean(location.href.match('/title/tt')) && !Boolean(location.href.match('reference'))) {
    stripped_href = stripped_href + "reference";
  }
  window.location.replace(stripped_href);
  return;
} else if (GM_config.get('force_reference_view') && Boolean(location.href.match('/title/tt')) && !Boolean(location.href.match('reference'))) {
  const reference_href = location.href + "reference";
  window.location.replace(reference_href);
  return;
}

//==============================================================================
//    Fetch per-site values from GM_config
//==============================================================================

$.each(sites, function(index, site) {
  site['show'] = GM_config.get(configName(site));
});

$.each(icon_sites, function(index, icon_site) {
  icon_site['show'] = GM_config.get('show_icon_' + icon_site['name']);
});

//==============================================================================
//    Global variables
//==============================================================================

// For internal use (order matters).
const valid_states = [
  'found',
  'missing',
  'logged_out',
  'error'
];

// Are we on a search/list page?
const onSearchPage = Boolean(location.href.match('/search/'))
                  || Boolean(location.href.match('/list/'))
                  || Boolean(location.href.match('watchlist'));

// Are we on a reference page?
const onReferencePage = Boolean(location.href.match('/reference'));

// Globals for the sorting launcher.
var showSitezFirstBar = 0;
var sortReqOnNewLineTemp = false;

// Trakt auth code?
const traktCodePage = Boolean(location.href.match(/tt0052077\/reference\?code=/));

//==============================================================================
//    Stuff for the new IMDb design (to start after reflow)
//==============================================================================

function startObserver() {
  if ($('[class^=TitleBlock__TitleContainer]').length) {
    addDummyElem();
    const obscfg = { childList: true};
    const obs = new MutationObserver(checkDummyElem);
    obs.observe($('[class^=TitleBlock__TitleContainer]')[0], obscfg);
  } else {
    console.log("IMDb Scout Mod (Start Error): Element not found! Please report it.");
  }
}

function addDummyElem() {
  const temp = $('<temp />').attr('id','temp_scout').css({'display':'none'});
  $('[class^=TitleBlock__TitleContainer]').append(temp);
  setTimeout(function(){
    temp.remove();
  }, 2000);
}

function checkDummyElem(mutation, observer) {
  if (!$('#temp_scout').length) {
    observer.disconnect();
    adsRemoval();
    startIMDbScout();
  }
}

//==============================================================================
//    Start: Display 'Load' button or add links to sites
//==============================================================================

function startIMDbScout() {
  if (traktCodePage) {
    traktCatchToken();
    return;
  }
  if (!onSearchPage && GM_config.get('loadmod_on_start_movie')) {
    performPage();
  } else if (onSearchPage && GM_config.get('loadmod_on_start_search')) {
    performSearch();
  } else {
    displayButton();
  }
}

if ($('html[xmlns\\:og="http://ogp.me/ns#"]').length) {
  document.events.on('bodyloaded', () => {
    darkReferenceStyles();
    compactReferenceStyles();
  });
  document.addEventListener('DOMContentLoaded', compactReferenceElemRemoval);
  document.addEventListener('DOMContentLoaded', adsRemovalReference);
  document.addEventListener('DOMContentLoaded', startIMDbScout);
} else {
  // Redesigned pages stopped using jQuery(?). It's needed for POST links.
  document.events.on('headloaded', () => {
    const addJquery = document.createElement("script");
    addJquery.setAttribute("type","text/javascript");
    addJquery.setAttribute("src","https://code.jquery.com/jquery-3.5.1.min.js");
    document.getElementsByTagName("head")[0].appendChild(addJquery);
  });
  // Start for redesigned page
  document.addEventListener('DOMContentLoaded', startObserver);
}
